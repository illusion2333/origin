# 多机部署

## 概述

在【快速入门】中，使用的`prepare.sh`脚本，生成的多节点的配置，默认使用本地回环地址（`127.0.0.1`）和自动生成的端口号，如果需要在生产环境不同的服务器上部署或使用固定的端口号，需要提前修改配置模板文件后，再进行配置文件和证书的生成。具体步骤如下。

## 操作步骤

### 配置指定端口

> 配置文件路径：`chainmaker-go/config/config_tpl/chainmaker.yml`

使用`prepare.sh`脚本会自动生成端口号，如果实际环境需要固定端口，可以通过修改下面的配置，将`{xxx}`修改为指定的端口，后续执行脚本时，就不会进行端口的修改。

```yaml
rpc: 
  port: {rpc_port}

net: 
  listen_addr: /ip4/0.0.0.0/tcp/{net_port}

monitor:
  port: {monitor_port}
     
pprof:
  port: {pprof_port}
```

### 配置指定IP

> 配置文件路径：`chainmaker-go/config/config_tpl/bc_xxx.yml`，`xxx`是节点数，根据需要，选择特定节点数的模板。

将`127.0.0.1`修改为集群各个节点实际所在机器的IP地址。

```yaml
#共识配置
consensus:
  # 共识类型(0-SOLO,1-TBFT,2-MBFT,3-HOTSTUFF,4-RAFT,10-POW)
  type: {consensus_type}
  # 共识节点列表，组织必须出现在trust_roots的org_id中，每个组织可配置多个共识节点，节点地址采用libp2p格式
  nodes:
    - org_id: "{org1_id}"
      address:
        - "/ip4/127.0.0.1/tcp/{org1_port}/p2p/{org1_peerid}"
    - org_id: "{org2_id}"
      address:
        - "/ip4/127.0.0.1/tcp/{org2_port}/p2p/{org2_peerid}"
    - org_id: "{org3_id}"
      address:
        - "/ip4/127.0.0.1/tcp/{org3_port}/p2p/{org3_peerid}"
    - org_id: "{org4_id}"
      address:
        - "/ip4/127.0.0.1/tcp/{org4_port}/p2p/{org4_peerid}"
```

### 生成节点安装包

```bash
$ ./prepare.sh 4 1
begin check params...
begin generate certs, cnt: 4
input consensus type(default 1/tbft): 
input log level(default INFO): 
begin generate node1 config...
begin generate node2 config...
begin generate node3 config...
begin generate node4 config...

$ ./build_release.sh 

$ tree ../build/release/
../build/release/
├── chainmaker-V1.0.0-wx-org1.chainmaker.org-20210407153351-x86_64.tar.gz
├── chainmaker-V1.0.0-wx-org2.chainmaker.org-20210407153351-x86_64.tar.gz
├── chainmaker-V1.0.0-wx-org3.chainmaker.org-20210407153351-x86_64.tar.gz
├── chainmaker-V1.0.0-wx-org4.chainmaker.org-20210407153351-x86_64.tar.gz
└── crypto-config-20210407153351.tar.gz
```

后续上传各节点安装包，到指定的服务器上，部署解压后使用。

如果需要配置自拉起方式启动，请参考：【宕机恢复】