# 快速入门

## 0 概述

通过本文你将可以搭建起长安链多节点集群，并使用命令行工具和SDK完成长安链功能的体验。

## 1 环境依赖

### 1.1 硬件依赖

| 配置 | 最低配置 | 推荐配置 |
| ---- | -------- | -------- |
| CPU  | 1.5GHz   | 2.4GHz   |
| 内存 | 4GB      | 8GB      |
| 核心 | 4核      | 8核      |
| 带宽 | 2Mb      | 10Mb     |

### 1.2 软件依赖

#### 1.2.1 git

下载地址：https://git-scm.com/downloads

安装步骤，请参看：https://git-scm.com/book/en/v2/Getting-Started-Installing-Git

#### 1.2.2 golang

> 版本为1.15或以上

下载地址：https://golang.org/dl/

安装步骤，请参看：https://golang.org/doc/install

#### 1.2.3 docker

> 若不使用采用`docker`方式搭建集群，可以不安装

安装步骤，请参看：https://docs.docker.com/engine/install/

#### 1.2.4 docker-compose

> 若不使用采用`docker`方式搭建集群，可以不安装

安装步骤，请参看：https://docs.docker.com/compose/install/

## 2 环境搭建

### 2.1 使用脚本搭建

> 适用于`Linux`、`MacOS`

#### 2.1.1 源码下载

从[长安链官网](https://www.chainmaker.org/)下载源码：https://git.chainmaker.org.cn/chainmaker/chainmaker-go

> 当前为私有仓库，需要先进行账号注册

- 下载`chainmaker`源码到本地

```bash
$ git clone --recursive https://git.chainmaker.org.cn/chainmaker/chainmaker-go.git
```

- 下载证书生成工具源码到本地

```bash
$ git clone --recursive https://git.chainmaker.org.cn/chainmaker/chainmaker-cryptogen.git
```

#### 2.1.2 源码编译

- 编译证书生成工具

```bash
$ cd chainmaker-cryptogen
$ make
```

#### 2.1.3 证书及配置文件生成

- 将编译好的`chainmaker-cryptogen`，软连接或拷贝到`chainmaker-go/tools`目录

```bash
# 进入工具目录
$ cd chainmaker-go/tools

# 软连接chainmaker-cryptogen到tools目录下
$ ln -s ../../chainmaker-cryptogen/ .
```

- 进入`chainmaker-go/scripts`目录，执行`prepare.sh`脚本生成单链4节点集群配置，存于路径`chainmaker-go/build`中

  > `prepare.sh`脚本支持生成`solo`模式节点证书和配置，以及4/7/10/13/16节点的证书和配置

```bash
# 进入脚本目录
$ cd ../scripts

# 查看脚本帮助
$ ./prepare.sh -h
Usage:  
  prepare.sh node_cnt(1/4/7/10/13/16) chain_cnt(1-4) p2p_port_prefix(default:11300) rpc_port_prefix(default:12300)
    eg1: prepare.sh 4 1
    eg2: prepare.sh 4 1 11300 12300

# 生成单链4节点集群的证书和配置
$ ./prepare.sh 4 1
begin check params...
begin generate certs, cnt: 4
input consensus type(default 1/tbft): 
input log level(default INFO): 
begin generate node1 config...
begin generate node2 config...
begin generate node3 config...
begin generate node4 config...

# 查看生成好的节点证书和配置
$ tree -L 3 ../build/
../build/
├── config
│   ├── node1
│   │   ├── certs
│   │   ├── chainconfig
│   │   ├── chainmaker.yml
│   │   └── log.yml
│   ├── node2
│   │   ├── certs
│   │   ├── chainconfig
│   │   ├── chainmaker.yml
│   │   └── log.yml
│   ├── node3
│   │   ├── certs
│   │   ├── chainconfig
│   │   ├── chainmaker.yml
│   │   └── log.yml
│   └── node4
│       ├── certs
│       ├── chainconfig
│       ├── chainmaker.yml
│       └── log.yml
├── crypto-config
│   ├── wx-org1.chainmaker.org
│   │   ├── ca
│   │   ├── node
│   │   └── user
│   ├── wx-org2.chainmaker.org
│   │   ├── ca
│   │   ├── node
│   │   └── user
│   ├── wx-org3.chainmaker.org
│   │   ├── ca
│   │   ├── node
│   │   └── user
│   └── wx-org4.chainmaker.org
│       ├── ca
│       ├── node
│       └── user
└── crypto_config.yml
```

- 关于自动生成的端口说明

通过`prepare.sh`脚本生成的配置，默认是在单台服务器上部署，故自动生成的端口号，是从一个起始端口号开始依次递增，可以通过命令行参数修改起始端口号。

主要有2个端口，`p2p`端口（用于节点互联）和`rpc`端口（用于客户端与节点通信），`p2p`起始端口为`11301`，`rpc`起始端口为`12301`。

如果生成4个节点的配置，`p2p`端口分别为：`11301、11302、11303、11304`，`rpc`端口分别为：`12301、12302、12303、12304`

如果是在多机部署，希望生成固定的端口号，请参考：[【多机部署】](./docs/operation/1、多机部署)

#### 2.1.4 编译及安装包制作

- 执行`build_release.sh`脚本，将编译`chainmaker-go`模块，并打包生成安装，存于路径`chainmaker-go/build/release`中

```bash
$ ./build_release.sh
$ tree ../build/release/
../build/release/
├── chainmaker-V1.0.0-wx-org1.chainmaker.org-20210406194833-x86_64.tar.gz
├── chainmaker-V1.0.0-wx-org2.chainmaker.org-20210406194833-x86_64.tar.gz
├── chainmaker-V1.0.0-wx-org3.chainmaker.org-20210406194833-x86_64.tar.gz
├── chainmaker-V1.0.0-wx-org4.chainmaker.org-20210406194833-x86_64.tar.gz
└── crypto-config-20210406194833.tar.gz
```

#### 2.1.5 启动节点集群

- 执行`cluster_quick_start.sh`脚本，会解压各个安装包，调用`bin`目录中的`start.sh`脚本，启动`chainmaker`节点

```bash
$ ./cluster_quick_start.sh normal
```

> 若需要关闭集群，使用脚本：
>
> ```bash
> $ ./cluster_quick_stop.sh
> ```

#### 2.1.6 查看节点启动使用正常

- 查看进程是否存在

```bash
$ ps -ef|grep chainmaker | grep -v grep
jason    25261  2146  4 19:55 pts/20   00:00:01 ./chainmaker start -c ../config/wx-org1.chainmaker.org/chainmaker.yml
jason    25286  2146  4 19:55 pts/20   00:00:01 ./chainmaker start -c ../config/wx-org2.chainmaker.org/chainmaker.yml
jason    25309  2146  4 19:55 pts/20   00:00:01 ./chainmaker start -c ../config/wx-org3.chainmaker.org/chainmaker.yml
jason    25335  2146  4 19:55 pts/20   00:00:01 ./chainmaker start -c ../config/wx-org4.chainmaker.org/chainmaker.yml
```

- 查看端口是否监听

```bash
$ netstat -lptn | grep 1230
tcp6       0      0 :::12301                :::*                    LISTEN      25261/./chainmaker  
tcp6       0      0 :::12302                :::*                    LISTEN      25286/./chainmaker  
tcp6       0      0 :::12303                :::*                    LISTEN      25309/./chainmaker  
tcp6       0      0 :::12304                :::*                    LISTEN      25335/./chainmaker 
```

- 检查节点是否有`ERROR`日志

```bash
$ tail -f ../build/release/chainmaker-V1.0.0-wx-org1.chainmaker.org/log/system.log
```

### 2.2 使用Docker搭建

> 适用于`Docker`

#### 2.2.1 编译docker镜像

```bash
$ cd chainmaker-go
# 生成镜像名称为：chainmaker:v1.0.0_r，如需要修改版本，请修改Makefile文件
$ make docker-build
```

#### 2.2.2 启停solo节点

> 为了方便使用，使用的配置文件及证书已放置于目录：`chainmaker-go/scripts/docker/config/solo`
>
> 如镜像名称有调整，请修改`solo.docker-compose.yml`文件

```bash
$ cd chainmaker-go/scripts/docker/
# 启动solo节点
$ ./solo_up.sh 
# 关闭solo节点
$ ./solo_down.sh
```

#### 2.2.3 启停4节点集群

> 为了方便使用，使用的配置文件及证书已放置于目录：`chainmaker-go/scripts/docker/config/four-nodes`
>
> 如镜像名称有调整，请修改`four-nodes.docker-compose.yml`文件

```bash
$ cd chainmaker-go/scripts/docker/
# 启动4节点集群
$ ./four-nodes_up.sh 
# 关闭4节点集群
$ ./four-nodes_down.sh
```

## 3 功能验证

为了验证所搭建的链功能是否正常，可以通过`cmc`命令行工具或`sdk`的单元测试用例来进行验证。

### 3.1 cmc命令行工具验证

请参看：[【命令行工具】](./docs/dev/3、命令行工具.md)

### 3.2 go sdk验证

#### 3.2.1 下载go sdk源码

```bash
$ git clone --recursive https://git.chainmaker.org.cn/chainmaker/chainmaker-sdk-go.git
```

#### 3.2.2 关联证书

> 将通过`prepare.sh`工具生成的`crypto-config`目录，软连接到`chainmaker-sdk-go/testdata`目录

```bash
$ cd chainmaker-sdk-go/testdata

# 这里我们使用新生成的用户证书，请先将testdata已有的crypto-config移除
$ /bin/rm -rf crypto-config
$ ln -s ../../chainmaker-go/build/crypto-config/ .
```

#### 3.2.3 配置修改

> 修改sdk单元测试使用的配置文件：`chainmaker-sdk-go/testdata/sdk_config.yml`

根据需要修改节点地址：

```yml
    nodes:
      - # 节点地址，格式为：IP:端口:连接数
        node_addr: "127.0.0.1:12301"
```

如果证书路径有调整，修改对应的证书路径配置：

```yml
    # 客户端用户私钥路径
    user_key_file_path: "./testdata/crypto-config/wx-org1.chainmaker.org/user/client1/client1.tls.key
    # 客户端用户证书路径
    user_crt_file_path: "./testdata/crypto-config/wx-org1.chainmaker.org/user/client1/client1.tls.crt"
    # 客户端用户交易签名私钥路径(若未设置，将使用user_key_file_path)
    user_sign_key_file_path: "./testdata/crypto-config/wx-org1.chainmaker.org/user/client1/client1.sign.key"
    # 客户端用户交易签名证书路径(若未设置，将使用user_crt_file_path)
    user_sign_crt_file_path: "./testdata/crypto-config/wx-org1.chainmaker.org/user/client1/client1.sign.crt"
```

#### 3.2.4 执行存证合约单测

该单测会进行存证合约的部署、调用和查询。

```bash
$ cd chainmaker-sdk-go
$ go test -v -run UserContractClaim
```

看到类似输出，说明功能验证成功：

```bash
2021-04-07 21:45:25.510	[DEBUG]	[SDK]	chainmaker-sdk-go/sdk_client.go:343	[SDK] proposalRequest resp: message:"SUCCESS" contract_result:<result:"{\"file_hash\":\"9387687162f344b79b39385c5e998f97\",\"file_name\":\"file_1617803123443\",\"time\":\"1617803123443\"}" gas_used:25145486 > 
```

#### 3.2.5 执行资产合约单测

也可以跑资产合约的单测，该单测会创建A、B两个账号，每个账号初始资产为100000，A给B转账100，最后查看A和B的余额，分别为`99900`和`100100`。

```bash
$ go test -v -run UserContractAsset
```

看到类似输出，说明资产合约功能验证成功：

```bash
2021-04-07 21:46:30.439	[DEBUG]	[SDK]	chainmaker-sdk-go/sdk_client.go:343	[SDK] proposalRequest resp: message:"SUCCESS" contract_result:<result:"99900" gas_used:16058023 > 

2021-04-07 21:46:30.448	[DEBUG]	[SDK]	chainmaker-sdk-go/sdk_client.go:343	[SDK] proposalRequest resp: message:"SUCCESS" contract_result:<result:"100100" gas_used:16120471 >
```

