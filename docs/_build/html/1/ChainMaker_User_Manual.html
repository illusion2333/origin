

<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
  <meta charset="utf-8" />
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  
  <title>长安链 · ChainMaker User Manual &mdash; chainmaker-docs 0.7.1 documentation</title>
  

  
  <link rel="stylesheet" href="../_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />

  
  

  
  

  

  
  <!--[if lt IE 9]>
    <script src="../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
    
      <script type="text/javascript" id="documentation_options" data-url_root="../" src="../_static/documentation_options.js"></script>
        <script src="../_static/jquery.js"></script>
        <script src="../_static/underscore.js"></script>
        <script src="../_static/doctools.js"></script>
    
    <script type="text/javascript" src="../_static/js/theme.js"></script>

    
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <link rel="next" title="长安链 · ChainMaker Data Structure" href="ChainMaker_Data_Structure.html" />
    <link rel="prev" title="长安链· ChainMaker Quick Start" href="ChainMaker_Quick_Start.html" /> 
</head>

<body class="wy-body-for-nav">

   
  <div class="wy-grid-for-nav">
    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
          

          
            <a href="../index.html" class="icon icon-home"> chainmaker-docs
          

          
          </a>

          
            
            
              <div class="version">
                0.7.1
              </div>
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        
        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <ul class="current">
<li class="toctree-l1 current"><a class="reference internal" href="index.html">目录</a><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="ChainMaker_General_Introduction.html">长安链 · ChainMaker General Introduction</a></li>
<li class="toctree-l2"><a class="reference internal" href="ChainMaker_Quick_Start.html">长安链· ChainMaker Quick Start</a></li>
<li class="toctree-l2 current"><a class="current reference internal" href="#">长安链 · ChainMaker User Manual</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#id1">整体架构</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#id2">逻辑架构</a></li>
<li class="toctree-l4"><a class="reference internal" href="#id3">核心流程</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="#id4">核心特性</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#id5">抽象统一的执行流程</a></li>
<li class="toctree-l4"><a class="reference internal" href="#id6">深度模块化</a></li>
<li class="toctree-l4"><a class="reference internal" href="#id7">支持广域场景</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="#id8">模块说明</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#id9">智能合约</a></li>
<li class="toctree-l4"><a class="reference internal" href="#id14">共识算法</a></li>
<li class="toctree-l4"><a class="reference internal" href="#p2p">P2P网络</a></li>
<li class="toctree-l4"><a class="reference internal" href="#rpc">RPC服务</a></li>
<li class="toctree-l4"><a class="reference internal" href="#id30">存储模块</a></li>
<li class="toctree-l4"><a class="reference internal" href="#id43">身份与权限管理</a></li>
<li class="toctree-l4"><a class="reference internal" href="#id59">配置模块</a></li>
<li class="toctree-l4"><a class="reference internal" href="#id63">同步模块</a></li>
<li class="toctree-l4"><a class="reference internal" href="#id70">轻节点模块</a></li>
<li class="toctree-l4"><a class="reference internal" href="#id76">交易池</a></li>
<li class="toctree-l4"><a class="reference internal" href="#id84">加密算法</a></li>
<li class="toctree-l4"><a class="reference internal" href="#id90">核心引擎</a></li>
<li class="toctree-l4"><a class="reference internal" href="#id95">日志</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="ChainMaker_Data_Structure.html">长安链 · ChainMaker Data Structure</a></li>
<li class="toctree-l2"><a class="reference internal" href="ChainMaker_SDK_Go_Manual.html">ChainMaker Go SDK README</a></li>
<li class="toctree-l2"><a class="reference internal" href="ChainMaker_SDK_Java_Manual.html">ChainMaker Java SDK README</a></li>
<li class="toctree-l2"><a class="reference internal" href="ChainMaker_Tools_Manual.html">长安链 · ChainMaker Tools Manual</a></li>
<li class="toctree-l2"><a class="reference internal" href="ChainMaker_Deploy_Manual.html">长安链 · ChainMaker Deploy Manual</a></li>
<li class="toctree-l2"><a class="reference internal" href="ChainMaker_Operation_Manual.html">长安链 · ChainMaker Operation Manual</a></li>
<li class="toctree-l2"><a class="reference internal" href="ChainMaker_Maintenance_Manual.html">长安链 · ChainMaker Maintenance Manual</a></li>
<li class="toctree-l2"><a class="reference internal" href="ChainMaker_PPROF_Manual.html">pprof使用</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../2/index.html">长安链</a></li>
</ul>

            
          
        </div>
        
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../index.html">chainmaker-docs</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content">
        
          

















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="../index.html" class="icon icon-home"></a> &raquo;</li>
        
          <li><a href="index.html">目录</a> &raquo;</li>
        
      <li>长安链 · ChainMaker User Manual</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
          
            <a href="../_sources/1/ChainMaker_User_Manual.md.txt" rel="nofollow"> View page source</a>
          
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <div class="section" id="chainmaker-user-manual">
<h1>长安链 · ChainMaker User Manual<a class="headerlink" href="#chainmaker-user-manual" title="Permalink to this headline">¶</a></h1>
<div class="section" id="id1">
<h2>整体架构<a class="headerlink" href="#id1" title="Permalink to this headline">¶</a></h2>
<div class="section" id="id2">
<h3>逻辑架构<a class="headerlink" href="#id2" title="Permalink to this headline">¶</a></h3>
<img src="images/chainmaker.png" style="zoom: 60%;" />
长安链的应用生态中主要包含以下元素：<ul class="simple">
<li><p>Consensus Node：共识节点，参与共识投票、交易执行、区块验证和记账的节点。</p></li>
<li><p>Sync Node：同步节点，或称为见证节点，节点会同步、验证区块，执行交易，并记录完整账本数据，不参与共识投票。</p></li>
<li><p>Light Node：轻节点，从共识节点同步数据，校验数据合法性，过滤同属组织的交易并存储；不具备接收交易请求和广播交易的功能。</p></li>
<li><p>SDK：即客户端SDK，帮助用户通过RPC和链进行沟通，完成合约创建、调用、链管理等功能。</p></li>
<li><p>Tools：长安链提供一系列工具集方便用户命令行方式对链部署和管理操作。比如证书生成、链配置、快速部署等。</p></li>
<li><p>长安链 Management Platform：区块链管理平台，包括链管理、区块信息检索、可视化监控等功能。</p></li>
<li><p>长安链 IDE：智能合约在线开发环境，长安链所有合约支持语言均可在该IDE上开发、编译、调试。</p></li>
</ul>
<p>通常构建一条链，根据共识算法的要求部署足够的共识节点即可。根据具体业务需要选择是否增加更多的共识节点或同步节点。</p>
</div>
<div class="section" id="id3">
<h3>核心流程<a class="headerlink" href="#id3" title="Permalink to this headline">¶</a></h3>
<img src="images/business-stream.png" style="zoom: 60%;" /><p>区块处理流程为：</p>
<ol class="simple">
<li><p>提案区块。提案节点从交易池选取一批交易，并行调度执行得到结果，生成DAG，并将区块和DAG广播。</p></li>
<li><p>验证区块。接收提案区块，基于DAG对交易并行执行，并验证结果是否一致。</p></li>
<li><p>共识投票。基于对应的共识机制，对提案区块进行共识投票。</p></li>
<li><p>提交区块。完成共识投票的区块，提交记录至账本。</p></li>
</ol>
</div>
</div>
<div class="section" id="id4">
<h2>核心特性<a class="headerlink" href="#id4" title="Permalink to this headline">¶</a></h2>
<div class="section" id="id5">
<h3>抽象统一的执行流程<a class="headerlink" href="#id5" title="Permalink to this headline">¶</a></h3>
<p>现阶段的各种区块链实现中，整体流程差别很大。为装配出各类满足需求的区块链，长安链需合理抽象出区块链整体执行流程，并基于此通用流程进行模块组合。长安链后续还考虑增加整体流程的灵活性，以支持更加丰富的区块链场景。</p>
</div>
<div class="section" id="id6">
<h3>深度模块化<a class="headerlink" href="#id6" title="Permalink to this headline">¶</a></h3>
<p>长安链不仅要求区块链模块功能的完全独立、接口定义清晰、可插拔替换，而且要求模块间通信完全虚拟化，可支持从函数调用、进程间通信（IPC）到各类网络通信协议等不同的实现模式，从而使得方便自由的模块拼装组合成为可能。</p>
</div>
<div class="section" id="id7">
<h3>支持广域场景<a class="headerlink" href="#id7" title="Permalink to this headline">¶</a></h3>
<p>根据业务场景特性，长安链可以生产出从公有链到联盟链各类基于不同信任模型的区块链，支持更加广泛的业务应用。</p>
</div>
</div>
<div class="section" id="id8">
<h2>模块说明<a class="headerlink" href="#id8" title="Permalink to this headline">¶</a></h2>
<div class="section" id="id9">
<h3>智能合约<a class="headerlink" href="#id9" title="Permalink to this headline">¶</a></h3>
<div class="section" id="id10">
<h4>合约的分类和执行流程<a class="headerlink" href="#id10" title="Permalink to this headline">¶</a></h4>
<p>长安链可以运行基于WASM和EVM的智能合约，同时内部也内置了多个系统合约。智能合约支持了面向用户的在区块链上可编程的能力，而系统合约为长安链区块链的管理与配置提供了必要条件。</p>
<p>当交易在合约模块执行时，先依据合约的名称，来决定是交给智能合约还是系统合约来执行。为系统合约保留的名称包括：</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="s2">&quot;SYSTEM_CONTRACT_CHAIN_CONFIG&quot;</span>
<span class="s2">&quot;SYSTEM_CONTRACT_QUERY&quot;</span>
<span class="s2">&quot;SYSTEM_CONTRACT_CERT_MANAGE&quot;</span>
<span class="s2">&quot;SYSTEM_CONTRACT_GOVERNMENT&quot;</span>
<span class="s2">&quot;SYSTEM_CONTRACT_MULT_SIGN&quot;</span>
</pre></div>
</div>
<p>如果合约名称不在上述列表中，再依据交易类型，来执行智能合约。对调用智能合约而言，有效的交易类型包括：</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">MANAGE_USER_CONTRACT</span>
<span class="n">INVOKE_USER_CONTRACT</span>
<span class="n">QUERY_USER_CONTRACT</span>
<span class="n">QUERY_SYSTEM_CONTRACT</span>
<span class="n">UPDATE_CHAIN_CONFIG</span>
<span class="n">INVOKE_SYSTEM_CONTRACT</span>
</pre></div>
</div>
<p>在把智能合约交给智能合约引擎执行前，还会经过一系列的参数校验。这些校验包括字节码、版本、合约调用方法名称、合约调用参数、合约引擎类型。</p>
<p>启动智能合约执行引擎时，将解析字节码、版本、合约调用方法名称、合约调用参数，并且序列化为智能合约执行引擎所需要的数据，并且拷贝数据到智能合约引擎中。智能合约执行引擎在执行过程中，就会依据上述信息执行，并且返回合约执行结果。最终把合约执行结果交给存储模块</p>
</div>
<div class="section" id="id11">
<h4>合约引擎介绍<a class="headerlink" href="#id11" title="Permalink to this headline">¶</a></h4>
<p>长安链目前支持四类智能合约执行引擎：</p>
<ul class="simple">
<li><p>WASMER：支持使用Rust语言生成的智能合约wasm字节码，运行时采用aot技术执行</p></li>
<li><p>GASM：支持使用Go语言编写合约，使用TinyGo编译器生成的智能合约wasm字节码，运行时采用解释技术执行</p></li>
<li><p>WXVM：支持使用C++语言生成的智能合约wasm字节码，运行时采用本地化编译技术执行</p></li>
<li><p>EVM：支持使用Solidity语言编写合约，使用solc编译器生成的智能合约字节码，运行时采用解释技术执行</p></li>
</ul>
</div>
<div class="section" id="id12">
<h4>系统合约<a class="headerlink" href="#id12" title="Permalink to this headline">¶</a></h4>
<p>目前系统合约包含：</p>
<ul class="simple">
<li><p>SYSTEM_CONTRACT_CHAIN_CONFIG：增删改链配置</p></li>
<li><p>SYSTEM_CONTRACT_QUERY：查询链上配置</p></li>
<li><p>SYSTEM_CONTRACT_CERT_MANAGE：证书管理</p></li>
<li><p>SYSTEM_CONTRACT_GOVERNMENT：链上治理</p></li>
<li><p>SYSTEM_CONTRACT_MULT_SIGN：链上多重签名</p></li>
</ul>
</div>
<div class="section" id="sdk">
<h4>合约SDK<a class="headerlink" href="#sdk" title="Permalink to this headline">¶</a></h4>
<p>长安链为不同的语言编写智能合约与链上交互提供了多种智能合约编写SDK。SDK主要提供的接口功能包括：</p>
<ul class="simple">
<li><p>读取在区块链数据库上的数据</p></li>
<li><p>往区块链数据库上写入数据</p></li>
<li><p>获取当前交易ID、区块高度</p></li>
<li><p>获取创建合约者的身份信息（公钥、组织、角色）</p></li>
<li><p>获取调用合约者（即交易发送者）的身份信息（公钥、组织、角色）</p></li>
</ul>
</div>
<div class="section" id="id13">
<h4>合约模块接口说明<a class="headerlink" href="#id13" title="Permalink to this headline">¶</a></h4>
<p>合约模块对外的接口为：</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="o">//</span><span class="n">VmManager</span> <span class="n">manage</span> <span class="n">vm</span> <span class="n">runtime</span>
<span class="nb">type</span> <span class="n">VmManager</span> <span class="n">interface</span> <span class="p">{</span>
   <span class="o">//</span> <span class="n">GetOrganization</span> <span class="n">get</span> <span class="n">organization</span> <span class="ow">or</span> <span class="n">membership</span>
   <span class="n">GetOrganization</span><span class="p">()</span> <span class="n">Organization</span>
   <span class="o">//</span> <span class="n">GetAccessControl</span> <span class="n">get</span> <span class="n">accessControl</span> <span class="n">manages</span> <span class="n">policies</span> <span class="ow">and</span> <span class="n">principles</span>
   <span class="n">GetAccessControl</span><span class="p">()</span> <span class="n">AccessControl</span>
   <span class="o">//</span> <span class="n">GetChainNodesInfoProvider</span> <span class="n">get</span> <span class="n">ChainNodesInfoProvider</span> <span class="n">provide</span> <span class="n">base</span> <span class="n">node</span> <span class="n">info</span> <span class="nb">list</span> <span class="n">of</span> <span class="n">chain</span><span class="o">.</span>
   <span class="n">GetChainNodesInfoProvider</span><span class="p">()</span> <span class="n">ChainNodesInfoProvider</span>
   <span class="o">//</span> <span class="n">RunContract</span> <span class="n">run</span> <span class="n">native</span> <span class="ow">or</span> <span class="n">user</span> <span class="n">contract</span> <span class="n">according</span> <span class="n">ContractName</span> <span class="ow">in</span> <span class="n">contractId</span><span class="p">,</span> <span class="ow">and</span> <span class="n">call</span> <span class="n">the</span> <span class="n">specified</span> <span class="n">function</span>
   <span class="n">RunContract</span><span class="p">(</span><span class="n">contractId</span> <span class="o">*</span><span class="n">pb</span><span class="o">.</span><span class="n">ContractId</span><span class="p">,</span> <span class="n">method</span> <span class="n">string</span><span class="p">,</span> <span class="n">byteCode</span> <span class="p">[]</span><span class="n">byte</span><span class="p">,</span> <span class="n">parameters</span> <span class="nb">map</span><span class="p">[</span><span class="n">string</span><span class="p">]</span><span class="n">string</span><span class="p">,</span>
      <span class="n">txContext</span> <span class="n">TxSimContext</span><span class="p">,</span> <span class="n">gasUsed</span> <span class="n">uint64</span><span class="p">,</span> <span class="n">refTxType</span> <span class="n">pb</span><span class="o">.</span><span class="n">TxType</span><span class="p">)</span> <span class="p">(</span><span class="o">*</span><span class="n">pb</span><span class="o">.</span><span class="n">ContractResult</span><span class="p">,</span> <span class="n">pb</span><span class="o">.</span><span class="n">TxStatusCode</span><span class="p">)</span>
<span class="p">}</span>
</pre></div>
</div>
<p>其主要的方法是RunContract，调用该方法时需要提供合约ID信息、调用方法、合约字节码、调用参数、合约执行上下文环境（主要为合约提供访问数据库的接口）、已消耗的资源量和合约操作交易类型（创建、升级、冻结、解冻、废止）</p>
</div>
<div class="section" id="pb">
<h4>PB数据模型<a class="headerlink" href="#pb" title="Permalink to this headline">¶</a></h4>
<p>合约ID：</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="o">//</span> <span class="n">the</span> <span class="n">unique</span> <span class="n">identifier</span> <span class="n">of</span> <span class="n">a</span> <span class="n">smart</span> <span class="n">contract</span>
<span class="n">message</span> <span class="n">ContractId</span> <span class="p">{</span>
    <span class="o">//</span> <span class="n">smart</span> <span class="n">contract</span> <span class="n">name</span><span class="p">,</span> <span class="nb">set</span> <span class="n">by</span> <span class="n">contract</span> <span class="n">creator</span><span class="p">,</span> <span class="n">can</span> <span class="n">have</span> <span class="n">multiple</span> <span class="n">versions</span>
    <span class="n">string</span> <span class="n">contract_name</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
    <span class="o">//</span> <span class="n">smart</span> <span class="n">contract</span> <span class="n">version</span><span class="p">,</span> <span class="nb">set</span> <span class="n">by</span> <span class="n">contract</span> <span class="n">creator</span><span class="p">,</span> <span class="n">name</span> <span class="o">+</span> <span class="n">version</span> <span class="n">should</span> <span class="n">be</span> <span class="n">unique</span>
    <span class="n">string</span> <span class="n">contract_version</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span>
    <span class="o">//</span> <span class="n">smart</span> <span class="n">contract</span> <span class="n">runtime</span> <span class="nb">type</span><span class="p">,</span> <span class="nb">set</span> <span class="n">by</span> <span class="n">contract</span> <span class="n">creator</span>
    <span class="n">RuntimeType</span> <span class="n">runtime_type</span> <span class="o">=</span> <span class="mi">3</span><span class="p">;</span>
<span class="p">}</span>
</pre></div>
</div>
<p>智能合约引擎类型（暂时还不支持 DOCKER_GO和 DOCKER_JAVA）</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="o">//</span> <span class="n">smart</span> <span class="n">contract</span> <span class="n">runtime</span><span class="p">,</span> <span class="n">contains</span> <span class="n">vm</span> <span class="nb">type</span> <span class="ow">and</span> <span class="n">language</span> <span class="nb">type</span>
<span class="n">enum</span> <span class="n">RuntimeType</span> <span class="p">{</span>
    <span class="n">INVALID</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="o">//</span> <span class="n">native</span> <span class="n">implement</span> <span class="ow">in</span> <span class="n">chainmaker</span><span class="o">-</span><span class="n">go</span>
    <span class="n">NATIVE</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
    <span class="o">//</span> <span class="n">vm</span><span class="o">-</span><span class="n">wasmer</span><span class="p">,</span> <span class="n">language</span><span class="o">-</span><span class="n">c</span><span class="o">++</span>
    <span class="n">WASMER</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span>
    <span class="o">//</span> <span class="n">vm</span><span class="o">-</span><span class="n">wxvm</span><span class="p">,</span> <span class="n">language</span><span class="o">-</span><span class="n">cpp</span>
    <span class="n">WXVM</span> <span class="o">=</span> <span class="mi">3</span><span class="p">;</span>
    <span class="o">//</span> <span class="n">wasm</span> <span class="n">interpreter</span> <span class="ow">in</span> <span class="n">go</span>
    <span class="n">GASM</span> <span class="o">=</span> <span class="mi">4</span><span class="p">;</span>
    <span class="o">//</span> <span class="n">vm</span><span class="o">-</span><span class="n">evm</span>
    <span class="n">EVM</span> <span class="o">=</span> <span class="mi">5</span><span class="p">;</span>
    <span class="o">//</span> <span class="n">vm</span><span class="o">-</span><span class="n">docker</span><span class="p">,</span> <span class="n">language</span><span class="o">-</span><span class="n">golang</span>
    <span class="n">DOCKER_GO</span> <span class="o">=</span> <span class="mi">6</span><span class="p">;</span>
    <span class="o">//</span> <span class="n">vm</span><span class="o">-</span><span class="n">docker</span><span class="p">,</span> <span class="n">language</span><span class="o">-</span><span class="n">java</span>
    <span class="n">DOCKER_JAVA</span> <span class="o">=</span> <span class="mi">7</span><span class="p">;</span>
<span class="p">}</span>
</pre></div>
</div>
<p>合约操作交易类型</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="o">//</span> <span class="n">transaction</span> <span class="nb">type</span> <span class="n">definition</span>
<span class="n">enum</span> <span class="n">TxType</span> <span class="p">{</span>
    <span class="o">//</span> <span class="n">call</span> <span class="n">a</span> <span class="n">pre</span> <span class="n">created</span> <span class="n">user</span> <span class="n">contract</span><span class="p">,</span> <span class="n">included</span> <span class="ow">in</span> <span class="n">block</span>
    <span class="n">INVOKE_USER_CONTRACT</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="o">//</span> <span class="n">query</span> <span class="n">a</span> <span class="n">pre</span> <span class="n">created</span> <span class="n">user</span> <span class="n">contract</span><span class="p">,</span> <span class="ow">not</span> <span class="n">included</span> <span class="ow">in</span> <span class="n">block</span>
    <span class="n">QUERY_USER_CONTRACT</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
    <span class="o">//</span> <span class="n">create</span><span class="p">,</span> <span class="n">upgrade</span><span class="p">,</span> <span class="n">freeze</span><span class="p">,</span> <span class="n">unfreeze</span><span class="p">,</span> <span class="n">revoke</span> <span class="n">a</span> <span class="n">user</span> <span class="n">contract</span><span class="p">,</span> <span class="n">included</span> <span class="ow">in</span> <span class="n">block</span>
    <span class="n">MANAGE_USER_CONTRACT</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span>
    <span class="o">//</span> <span class="n">query</span> <span class="n">chain</span> <span class="n">information</span>
    <span class="n">QUERY_SYSTEM_CONTRACT</span> <span class="o">=</span> <span class="mi">3</span><span class="p">;</span>
    <span class="o">//</span> <span class="n">update</span> <span class="n">chain</span> <span class="n">config</span><span class="p">,</span> <span class="n">included</span> <span class="ow">in</span> <span class="n">block</span>
    <span class="n">UPDATE_CHAIN_CONFIG</span> <span class="o">=</span> <span class="mi">4</span><span class="p">;</span>
    <span class="o">//</span> <span class="n">system</span> <span class="n">contract</span> <span class="k">for</span> <span class="n">multi</span> <span class="n">signature</span>
    <span class="n">INVOKE_SYSTEM_CONTRACT</span> <span class="o">=</span> <span class="mi">7</span><span class="p">;</span>
<span class="p">}</span>
</pre></div>
</div>
<p>合约操作管理数据结构</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="o">//</span> <span class="n">contract</span> <span class="n">management</span> <span class="nb">type</span> <span class="n">transaction</span> <span class="n">payload</span>
<span class="o">//</span> <span class="n">TxType</span><span class="p">:</span> <span class="n">CREATE_USER_CONTRACT</span> <span class="o">&amp;</span> <span class="n">UPGRADE_USER_CONTRACT</span> <span class="o">&amp;</span> <span class="n">FREEZE_USER_CONTRACT</span>
<span class="n">message</span> <span class="n">ContractMgmtPayload</span> <span class="p">{</span>
    <span class="o">//</span> <span class="n">endorsement</span> <span class="n">signature</span> <span class="k">with</span> <span class="n">chain_id</span><span class="p">,</span> <span class="n">redundant</span> <span class="k">with</span> <span class="n">TxHeader</span>
    <span class="n">string</span> <span class="n">chain_id</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
    <span class="o">//</span> <span class="n">smart</span> <span class="n">contract</span> <span class="n">name</span><span class="p">,</span> <span class="nb">set</span> <span class="n">by</span> <span class="n">contract</span> <span class="n">creator</span><span class="p">,</span> <span class="n">can</span> <span class="n">have</span> <span class="n">multiple</span> <span class="n">versions</span>
    <span class="n">ContractId</span> <span class="n">contract_id</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span>
    <span class="o">//</span> <span class="n">invoke</span> <span class="n">method</span> <span class="ow">in</span> <span class="nb">bytes</span> <span class="nb">format</span>
    <span class="n">string</span> <span class="n">method</span> <span class="o">=</span> <span class="mi">3</span><span class="p">;</span>
    <span class="o">//</span> <span class="n">invoke</span> <span class="n">parameters</span> <span class="ow">in</span> <span class="nb">bytes</span> <span class="nb">format</span>
    <span class="n">repeated</span> <span class="n">KeyValuePair</span> <span class="n">parameters</span> <span class="o">=</span> <span class="mi">4</span><span class="p">;</span> <span class="o">//</span> <span class="n">合约参数</span>
    <span class="o">//</span> <span class="n">合约编译后的字节码</span>
    <span class="nb">bytes</span> <span class="n">byte_code</span> <span class="o">=</span> <span class="mi">5</span><span class="p">;</span>
    <span class="o">//</span> <span class="n">payload</span> <span class="n">signature</span><span class="p">,</span> <span class="n">config_update</span><span class="o">|</span><span class="n">contract_mgmt</span> <span class="nb">type</span> <span class="n">needed</span><span class="p">,</span> <span class="n">multi</span><span class="o">-</span><span class="n">sign</span>
    <span class="n">repeated</span> <span class="n">EndorsementEntry</span> <span class="n">endorsement</span> <span class="o">=</span> <span class="mi">6</span><span class="p">;</span>
<span class="p">}</span>
</pre></div>
</div>
<p>系统合约操作数据结构</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="o">//</span> <span class="n">config</span> <span class="n">update</span> <span class="nb">type</span> <span class="n">transaction</span> <span class="n">payload</span>
<span class="o">//</span> <span class="n">TxType</span><span class="p">:</span> <span class="n">UPDATE_CHAIN_CONFIG</span>
<span class="n">message</span> <span class="n">SystemContractPayload</span> <span class="p">{</span>
    <span class="o">//</span> <span class="n">endorsement</span> <span class="n">signature</span> <span class="k">with</span> <span class="n">chain_id</span><span class="p">,</span> <span class="n">redundant</span> <span class="k">with</span> <span class="n">TxHeader</span>
    <span class="n">string</span> <span class="n">chain_id</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
    <span class="o">//</span> <span class="n">smart</span> <span class="n">contract</span> <span class="n">name</span>
    <span class="n">string</span> <span class="n">contract_name</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span>
    <span class="o">//</span> <span class="n">update</span> <span class="n">method</span>
    <span class="n">string</span> <span class="n">method</span> <span class="o">=</span> <span class="mi">3</span><span class="p">;</span>
    <span class="o">//</span> <span class="n">update</span> <span class="n">parameters</span> <span class="ow">in</span> <span class="n">k</span><span class="o">-</span><span class="n">v</span> <span class="nb">format</span>
    <span class="n">repeated</span> <span class="n">KeyValuePair</span> <span class="n">parameters</span> <span class="o">=</span> <span class="mi">4</span><span class="p">;</span>
    <span class="o">//</span> <span class="n">config</span> <span class="n">sequence</span><span class="p">,</span> <span class="n">starts</span> <span class="kn">from</span> <span class="mi">0</span> <span class="p">(</span><span class="n">genesis</span> <span class="n">config</span><span class="p">)</span>
    <span class="n">uint64</span> <span class="n">sequence</span> <span class="o">=</span> <span class="mi">5</span><span class="p">;</span>
    <span class="o">//</span> <span class="n">multi</span><span class="o">-</span><span class="n">sign</span><span class="p">,</span> <span class="n">signature</span> <span class="n">of</span> <span class="p">[</span><span class="n">SystemContractPayload</span><span class="p">]</span> <span class="k">with</span> <span class="n">endorsement</span> <span class="o">=</span> <span class="n">nil</span>
    <span class="n">repeated</span> <span class="n">EndorsementEntry</span> <span class="n">endorsement</span> <span class="o">=</span> <span class="mi">6</span><span class="p">;</span>
<span class="p">}</span>
</pre></div>
</div>
<p>查询合约操作数据结构</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="o">//</span> <span class="n">query</span> <span class="nb">type</span> <span class="n">transaction</span> <span class="n">payload</span>
<span class="o">//</span> <span class="n">TxType</span><span class="p">:</span> <span class="n">QUERY_USER_CONTRACT</span> <span class="o">&amp;</span> <span class="n">QUERY_SYSTEM_CONTRACT</span>
<span class="n">message</span> <span class="n">QueryPayload</span> <span class="p">{</span>
    <span class="o">//</span> <span class="n">smart</span> <span class="n">contract</span> <span class="n">name</span>
    <span class="n">string</span> <span class="n">contract_name</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
    <span class="o">//</span> <span class="n">query</span> <span class="n">method</span>
    <span class="n">string</span> <span class="n">method</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span>
    <span class="o">//</span> <span class="n">query</span> <span class="n">parameters</span> <span class="ow">in</span> <span class="n">k</span><span class="o">-</span><span class="n">v</span> <span class="nb">format</span>
    <span class="n">repeated</span> <span class="n">KeyValuePair</span> <span class="n">parameters</span> <span class="o">=</span> <span class="mi">3</span><span class="p">;</span>
<span class="p">}</span>
</pre></div>
</div>
<p>调用合约操作数据结构</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="o">//</span> <span class="n">transact</span> <span class="nb">type</span> <span class="n">transaction</span> <span class="n">payload</span>
<span class="o">//</span> <span class="n">TxType</span><span class="p">:</span> <span class="n">INVOKE_USER_CONTRACT</span>
<span class="n">message</span> <span class="n">TransactPayload</span> <span class="p">{</span>
    <span class="o">//</span> <span class="n">smart</span> <span class="n">contract</span> <span class="n">name</span>
    <span class="n">string</span> <span class="n">contract_name</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
    <span class="o">//</span> <span class="n">invoke</span> <span class="n">method</span>
    <span class="n">string</span> <span class="n">method</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span>
    <span class="o">//</span> <span class="n">invoke</span> <span class="n">parameters</span> <span class="ow">in</span> <span class="n">k</span><span class="o">-</span><span class="n">v</span> <span class="nb">format</span>
    <span class="n">repeated</span> <span class="n">KeyValuePair</span> <span class="n">parameters</span> <span class="o">=</span> <span class="mi">3</span><span class="p">;</span>
<span class="p">}</span>
</pre></div>
</div>
</div>
</div>
<div class="section" id="id14">
<h3>共识算法<a class="headerlink" href="#id14" title="Permalink to this headline">¶</a></h3>
<div class="section" id="tbft">
<h4>TBFT<a class="headerlink" href="#tbft" title="Permalink to this headline">¶</a></h4>
<div class="section" id="id15">
<h5>算法简述<a class="headerlink" href="#id15" title="Permalink to this headline">¶</a></h5>
<p>TBFT 是一种拜占庭容错的共识算法，可以在拜占庭节点数小于总数1/3的情况下，保证系统的安全运行。
TBFT 的每轮共识可以分为5个步骤：</p>
<ol class="simple">
<li><p>NewRound: 共识投票的准备阶段，会初始化共识相关状态</p></li>
<li><p>Proposal: 提案阶段，leader节点会打包区块，并广播给follwer节点</p></li>
<li><p>Prevote: 预投票阶段，follower节点在收到proposal并验证proposal合法后，广播自己的prevote投票到其他节点</p></li>
<li><p>Precommit: 预提交阶段，节点收到 &gt;2/3 针对proposal的prevote投票后，广播自己的precommit投票到其他节点</p></li>
<li><p>Commit: 提交阶段，节点收到 &gt;2/3 针对proposal的precommit投票后，提交proposal中的区块到账本</p></li>
</ol>
<p>其中共识投票是指其中的Proposal，Prevote，Precommit三个阶段。</p>
<p>阶段图示如下：
<img src="images/tbft_phase.png"/></p>
<p>流程图如下：
<img src="images/tbft_diagram.png"/></p>
</div>
<div class="section" id="pbft">
<h5>与PBFT的区别<a class="headerlink" href="#pbft" title="Permalink to this headline">¶</a></h5>
<p>TBFT基于Tendermint算法，与PBFT的最大区别在于：PBFT有一个固定的leader节点打包交易，当leader节点故障的时候会
使用view-change子协议更换leader；而在TBFT中，leader是轮换的，每提交n个块（可以配置）leader会轮换成下一个节点。
因此，TBFT比PBFT有更好的公平性。</p>
</div>
<div class="section" id="msgbus">
<h5>与msgbus交互流程<a class="headerlink" href="#msgbus" title="Permalink to this headline">¶</a></h5>
<img src="images/tbft_msgbus.png"/><p>ProposaState: TBFT发送给核心引擎本节点在当前高度是否是leader节点，核心引擎判断是否需要打包区块 <br>
Proposal: 核心引擎打包区块并发送给TBFT <br>
Verify: 当本节点收到主节点发来的区块后，向核心引擎验证区块读写集等信息 <br>
VerifyResult: 核心引擎返回给TBFT Verify的结果，当区块合法时，本节点将会投票给区块 <br>
Commit: TBFT完成共识后，向核心引擎发送提交区块的信号，核心引擎提交区块到账本 <br>
BlockInfo: 核心引擎告知TBFT已提交区块的高度等信息，TBFT进入下一个高度 <br></p>
</div>
<div class="section" id="id16">
<h5>接口说明<a class="headerlink" href="#id16" title="Permalink to this headline">¶</a></h5>
<div class="highlight-go notranslate"><div class="highlight"><pre><span></span><span class="kd">type</span> <span class="nx">ConsensusEngine</span> <span class="kd">interface</span> <span class="p">{</span>      
  <span class="c1">// Init starts the consensus engine.</span>
  <span class="nx">Start</span><span class="p">()</span> <span class="kt">error</span>                       
                                      
  <span class="c1">// Stop stops the consensus engine. </span>
  <span class="nx">Stop</span><span class="p">()</span> <span class="kt">error</span>                        
<span class="p">}</span>    
</pre></div>
</div>
<p>TBFT 实现了长安链的<code class="docutils literal notranslate"><span class="pre">ConsensusEngine</span></code>接口。
<code class="docutils literal notranslate"><span class="pre">Start</span></code> 方法用来初始化TBFT内部状态及启动TBFT实例。
<code class="docutils literal notranslate"><span class="pre">Stop</span></code> 方法用来停止TBFT实例。</p>
</div>
<div class="section" id="id17">
<h5>数据结构<a class="headerlink" href="#id17" title="Permalink to this headline">¶</a></h5>
<div class="highlight-protobuf notranslate"><div class="highlight"><pre><span></span><span class="c1">// TBFTMsgType defines different type message in tbft</span>
<span class="kd">enum</span> <span class="n">TBFTMsgType</span> <span class="p">{</span>
  <span class="na">propose</span>   <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
  <span class="na">prevote</span>   <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
  <span class="na">precommit</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span>
  <span class="na">state</span>     <span class="o">=</span> <span class="mi">3</span><span class="p">;</span>
<span class="p">}</span>

<span class="kd">message</span> <span class="nc">TBFTMsg</span> <span class="p">{</span>
  <span class="n">TBFTMsgType</span> <span class="na">type</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
  <span class="kt">bytes</span> <span class="na">msg</span>        <span class="o">=</span> <span class="mi">2</span><span class="p">;</span>
<span class="p">}</span>

<span class="c1">// Proposal defined a consesensus proposal which can </span>
<span class="c1">// be gossiped to other node and can be serilized </span>
<span class="c1">// for persistent store.</span>
<span class="kd">message</span> <span class="nc">Proposal</span> <span class="p">{</span>
  <span class="kt">string</span> <span class="na">voter</span>                 <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
  <span class="kt">int64</span> <span class="na">height</span>                 <span class="o">=</span> <span class="mi">2</span><span class="p">;</span>
  <span class="kt">int32</span> <span class="na">round</span>                  <span class="o">=</span> <span class="mi">3</span><span class="p">;</span>
  <span class="kt">int32</span> <span class="na">pol_round</span>              <span class="o">=</span> <span class="mi">4</span><span class="p">;</span>
  <span class="n">Block</span> <span class="na">block</span>                  <span class="o">=</span> <span class="mi">5</span><span class="p">;</span>
  <span class="n">EndorsementEntry</span> <span class="na">endorsement</span> <span class="o">=</span> <span class="mi">6</span><span class="p">;</span>
<span class="p">}</span>

<span class="c1">// VoteType represents the type of vote</span>
<span class="kd">enum</span> <span class="n">VoteType</span> <span class="p">{</span>
  <span class="na">VotePrevote</span>   <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
  <span class="na">VotePrecommit</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>

<span class="c1">// Vote represents a tbft vote</span>
<span class="kd">message</span> <span class="nc">Vote</span> <span class="p">{</span>
  <span class="n">VoteType</span> <span class="na">type</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
  <span class="kt">string</span> <span class="na">voter</span>  <span class="o">=</span> <span class="mi">2</span><span class="p">;</span>
  <span class="kt">int64</span> <span class="na">height</span>  <span class="o">=</span> <span class="mi">3</span><span class="p">;</span>
  <span class="kt">int32</span> <span class="na">round</span>   <span class="o">=</span> <span class="mi">4</span><span class="p">;</span>
  <span class="kt">bytes</span> <span class="na">hash</span>    <span class="o">=</span> <span class="mi">5</span><span class="p">;</span>
  <span class="n">EndorsementEntry</span> <span class="na">endorsement</span> <span class="o">=</span> <span class="mi">6</span><span class="p">;</span>
<span class="p">}</span>

<span class="c1">// Step represents the step in a round </span>
<span class="kd">enum</span> <span class="n">Step</span> <span class="p">{</span>
  <span class="na">NewHeight</span>     <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
  <span class="na">NewRound</span>      <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
  <span class="na">Propose</span>       <span class="o">=</span> <span class="mi">2</span><span class="p">;</span>
  <span class="na">Prevote</span>       <span class="o">=</span> <span class="mi">3</span><span class="p">;</span>
  <span class="na">PrevoteWait</span>   <span class="o">=</span> <span class="mi">4</span><span class="p">;</span>
  <span class="na">Precommit</span>     <span class="o">=</span> <span class="mi">5</span><span class="p">;</span>
  <span class="na">PrecommitWait</span> <span class="o">=</span> <span class="mi">6</span><span class="p">;</span>
  <span class="na">Commit</span>        <span class="o">=</span> <span class="mi">7</span><span class="p">;</span>
<span class="p">}</span>
</pre></div>
</div>
</div>
<div class="section" id="id18">
<h5>配置参数<a class="headerlink" href="#id18" title="Permalink to this headline">¶</a></h5>
<p>TBFT 可以通过在配置块中的<code class="docutils literal notranslate"><span class="pre">ext_config</span></code>字段配置相关参数：</p>
<ol class="simple">
<li><p>“TBFT_propose_timeout”: 提案的超时时间，如10s, 1m</p></li>
<li><p>“TBFT_propose_delta_timeout”: 每轮提案超时增加的时间，如10s, 1m</p></li>
<li><p>“TBFT_blocks_per_proposer”: 每个节点连续出块数，如 3</p></li>
</ol>
</div>
</div>
<div class="section" id="solo">
<h4>SOLO<a class="headerlink" href="#solo" title="Permalink to this headline">¶</a></h4>
<ul class="simple">
<li><p>什么是SOLO共识算法</p></li>
</ul>
<p>SOLO是单节点无共识投票过程的“共识算法”。</p>
<ul class="simple">
<li><p>SOLO共识算法的用途</p></li>
</ul>
<ol class="simple">
<li><p>快速部署单节点运行，降低试用门槛；</p></li>
<li><p>供开发人员进行除网络和共识模块的全流程测试；</p></li>
</ol>
<ul class="simple">
<li><p>如何使用SOLO共识算法</p></li>
</ul>
<p>部署一个长安链节点，将链配置（参见配置模块，链配置章节）的共识算法进行如下修改，清除数据启动即可：</p>
<div class="highlight-yml notranslate"><div class="highlight"><pre><span></span>#共识配置
consensus:
  # 共识类型(0-SOLO,1-TBFT,2-MBFT,3-HOTSTUFF,4-RAFT,10-POW)
  type: 1
</pre></div>
</div>
</div>
</div>
<div class="section" id="p2p">
<h3>P2P网络<a class="headerlink" href="#p2p" title="Permalink to this headline">¶</a></h3>
<div class="section" id="id19">
<h4><strong>组网方式</strong><a class="headerlink" href="#id19" title="Permalink to this headline">¶</a></h4>
<ul class="simple">
<li><p>长安链的P2P网络是基于libp2p实现并改进的，节点的网络地址遵循libp2p地址格式协议。</p></li>
<li><p>通过种子节点设置可实现节点自动发现、自动连接功能，在线的每个节点默认都可作为其他节点的种子节点提供网络发现服务，从而实现了长安链的自动组网机制。</p></li>
<li><p>长安链使用了改进后的libp2p-gossip-pubsub实现的消息广播/订阅功能。能够保证广播消息能最终到达在线的全部节点。多链场景下，节点上的每条链都独享一个独立的GossipPubSub服务，并通过对每个Gossip路由表的精确控制，可实现多链间广播数据隔离，保证了广播数据只在链内节点传播的确定性。也正是如此，才允许长安链的所有链共用一个底层P2P网络。</p></li>
<li><p>长安链理论上可实现上万甚至更多节点同时在线组网。</p></li>
<li><p>长安链可以提供NAT穿透、代理转发等在复杂网络环境下的场景解决方案支持。</p></li>
</ul>
</div>
<div class="section" id="id20">
<h4><strong>节点身份管理方式</strong><a class="headerlink" href="#id20" title="Permalink to this headline">¶</a></h4>
<ul class="simple">
<li><p>节点身份是由组织CA签发的TLS证书确定，在节点入网时，会校验TLS证书的合法性</p></li>
<li><p>每个节点都需保证TLS证书的唯一性，不可多节点共用一个TLS证书</p></li>
<li><p>每个TLS证书都可对应生成一个NodeId唯一标识，该标识是节点网络地址的组成部分，是网络通讯环节重要的标识</p></li>
</ul>
</div>
<div class="section" id="libp2p">
<h4><strong>基于libp2p的改进</strong><a class="headerlink" href="#libp2p" title="Permalink to this headline">¶</a></h4>
<ul class="simple">
<li><p>核心包增加对国密SM算法的支持</p></li>
<li><p>libp2p-gossip-pubsub功能模块增加白名单功能，实现对Gossip路由表的控制，达到广播隔离效果。</p></li>
<li><p>引入StreamPool，实现stream复用提高性能、网络吞吐能力自动扩容等特性。</p></li>
</ul>
</div>
<div class="section" id="id21">
<h4><strong>模块接口</strong><a class="headerlink" href="#id21" title="Permalink to this headline">¶</a></h4>
<div class="highlight-go notranslate"><div class="highlight"><pre><span></span><span class="c1">// NetType is the type of net.</span>
<span class="kd">type</span> <span class="nx">NetType</span> <span class="kt">int</span>

<span class="kd">const</span> <span class="p">(</span>
	<span class="c1">// Libp2p is a type of p2p net.</span>
	<span class="nx">Libp2p</span> <span class="nx">NetType</span> <span class="p">=</span> <span class="kc">iota</span>
	<span class="c1">// GRpc is a type of rpc net.</span>
	<span class="nx">GRpc</span>

	<span class="c1">// DefaultChainId is default chain id.</span>
	<span class="nx">DefaultChainId</span> <span class="p">=</span> <span class="s">&quot;default_chain&quot;</span>
<span class="p">)</span>

<span class="c1">// ReceiveMsgHandler handle the msg received from other node.</span>
<span class="kd">type</span> <span class="nx">ReceiveMsgHandler</span> <span class="kd">func</span><span class="p">(</span><span class="nx">from</span> <span class="kt">string</span><span class="p">,</span> <span class="nx">netMsg</span> <span class="o">*</span><span class="nx">pb</span><span class="p">.</span><span class="nx">NetMsg</span><span class="p">)</span> <span class="kt">error</span>

<span class="c1">// SubMsgHandler handle the msg published by other node.</span>
<span class="kd">type</span> <span class="nx">SubMsgHandler</span> <span class="kd">func</span><span class="p">(</span><span class="nx">publisher</span> <span class="kt">string</span><span class="p">,</span> <span class="nx">netMsg</span> <span class="o">*</span><span class="nx">pb</span><span class="p">.</span><span class="nx">NetMsg</span><span class="p">)</span> <span class="kt">error</span>

<span class="kd">type</span> <span class="nx">ChainNodeInfo</span> <span class="kd">struct</span> <span class="p">{</span>
	<span class="nx">NodeUid</span>     <span class="kt">string</span>
	<span class="nx">NodeAddress</span> <span class="p">[]</span><span class="kt">string</span>
	<span class="nx">NodeTlsCert</span> <span class="p">[]</span><span class="kt">byte</span>
<span class="p">}</span>

<span class="c1">// Net is local net interface.</span>
<span class="kd">type</span> <span class="nx">Net</span> <span class="kd">interface</span> <span class="p">{</span>
	<span class="c1">// NodeUid is the unique id of the node.</span>
	<span class="nx">NodeUid</span><span class="p">()</span> <span class="kt">string</span>

	<span class="c1">// InitPubsub will init new LibP2pPubsub instance with given chainId and maxMessageSize.</span>
	<span class="nx">InitPubsub</span><span class="p">(</span><span class="nx">chainId</span> <span class="kt">string</span><span class="p">,</span> <span class="nx">maxMessageSize</span> <span class="kt">int</span><span class="p">)</span> <span class="kt">error</span>

	<span class="c1">// BroadcastWithChainId  will broadcast a msg to a PubSubTopic with the pubsub service which id is given chainId.</span>
	<span class="nx">BroadcastWithChainId</span><span class="p">(</span><span class="nx">chainId</span> <span class="kt">string</span><span class="p">,</span> <span class="nx">topic</span> <span class="kt">string</span><span class="p">,</span> <span class="nx">netMsg</span> <span class="o">*</span><span class="nx">pb</span><span class="p">.</span><span class="nx">NetMsg</span><span class="p">)</span> <span class="kt">error</span>

	<span class="c1">// SubscribeWithChainId register a SubMsgHandler to a PubSubTopic with the pubsub service which id is given chainId.</span>
	<span class="nx">SubscribeWithChainId</span><span class="p">(</span><span class="nx">chainId</span> <span class="kt">string</span><span class="p">,</span> <span class="nx">topic</span> <span class="kt">string</span><span class="p">,</span> <span class="nx">handler</span> <span class="nx">SubMsgHandler</span><span class="p">)</span> <span class="kt">error</span>

	<span class="c1">// CancelSubscribeWithChainId cancel subscribe a PubSubTopic with the pubsub service which id is given chainId.</span>
	<span class="nx">CancelSubscribeWithChainId</span><span class="p">(</span><span class="nx">chainId</span> <span class="kt">string</span><span class="p">,</span> <span class="nx">topic</span> <span class="kt">string</span><span class="p">)</span> <span class="kt">error</span>

	<span class="c1">// SendMsg send msg to the node which id is given string.</span>
	<span class="c1">// 		msgFlag: is a flag used to distinguish msg type.</span>
	<span class="nx">SendMsg</span><span class="p">(</span><span class="nx">chainId</span> <span class="kt">string</span><span class="p">,</span> <span class="nx">node</span> <span class="kt">string</span><span class="p">,</span> <span class="nx">msgFlag</span> <span class="kt">string</span><span class="p">,</span> <span class="nx">netMsg</span> <span class="o">*</span><span class="nx">pb</span><span class="p">.</span><span class="nx">NetMsg</span><span class="p">)</span> <span class="kt">error</span>

	<span class="c1">// ReceiveMsgHandle register a ReceiveMsgHandler to the net.</span>
	<span class="c1">// 		msgFlag: is a flag used to distinguish msg type.</span>
	<span class="nx">ReceiveMsgHandle</span><span class="p">(</span><span class="nx">chainId</span> <span class="kt">string</span><span class="p">,</span> <span class="nx">msgFlag</span> <span class="kt">string</span><span class="p">,</span> <span class="nx">handler</span> <span class="nx">ReceiveMsgHandler</span><span class="p">)</span> <span class="kt">error</span>

	<span class="c1">// CancelReceiveMsgHandle unregister a ReceiveMsgHandler.</span>
	<span class="c1">// 		msgFlag: is a flag used to distinguish msg type.</span>
	<span class="nx">CancelReceiveMsgHandle</span><span class="p">(</span><span class="nx">chainId</span> <span class="kt">string</span><span class="p">,</span> <span class="nx">msgFlag</span> <span class="kt">string</span><span class="p">)</span> <span class="kt">error</span>

	<span class="c1">// AddSeed add a seed node addr.</span>
	<span class="nx">AddSeed</span><span class="p">(</span><span class="nx">seed</span> <span class="kt">string</span><span class="p">)</span> <span class="kt">error</span>

	<span class="c1">// RefreshSeeds refresh the seed node addr list.</span>
	<span class="nx">RefreshSeeds</span><span class="p">(</span><span class="nx">seeds</span> <span class="p">[]</span><span class="kt">string</span><span class="p">)</span> <span class="kt">error</span>

	<span class="c1">// AddTrustRoot add a tls root cert to the cert pool of chain.</span>
	<span class="nx">AddTrustRoot</span><span class="p">(</span><span class="nx">chainId</span> <span class="kt">string</span><span class="p">,</span> <span class="nx">rootCertByte</span> <span class="p">[]</span><span class="kt">byte</span><span class="p">)</span> <span class="kt">error</span>

	<span class="c1">// RefreshTrustRoots refresh the cert pool of chain.</span>
	<span class="nx">RefreshTrustRoots</span><span class="p">(</span><span class="nx">chainId</span> <span class="kt">string</span><span class="p">,</span> <span class="nx">rootsCertsBytes</span> <span class="p">[][]</span><span class="kt">byte</span><span class="p">)</span> <span class="kt">error</span>

	<span class="c1">// IsRunning return true when the net instance is running.</span>
	<span class="nx">IsRunning</span><span class="p">()</span> <span class="kt">bool</span>

	<span class="c1">// Start the local net.</span>
	<span class="nx">Start</span><span class="p">()</span> <span class="kt">error</span>

	<span class="c1">// Stop the local net.</span>
	<span class="nx">Stop</span><span class="p">()</span> <span class="kt">error</span>

	<span class="c1">// ChainNodesInfo return base node info list of chain which id is the given chainId.</span>
	<span class="nx">ChainNodesInfo</span><span class="p">(</span><span class="nx">chainId</span> <span class="kt">string</span><span class="p">)</span> <span class="p">([]</span><span class="o">*</span><span class="nx">ChainNodeInfo</span><span class="p">,</span> <span class="kt">error</span><span class="p">)</span>

	<span class="c1">// GetNodeUidByCertId return node uid which mapped to the given cert id. If unmapped return error.</span>
	<span class="nx">GetNodeUidByCertId</span><span class="p">(</span><span class="nx">certId</span> <span class="kt">string</span><span class="p">)</span> <span class="p">(</span><span class="kt">string</span><span class="p">,</span> <span class="kt">error</span><span class="p">)</span>

	<span class="c1">// AddOrg add a Organization for revoked validator.</span>
	<span class="nx">AddOrg</span><span class="p">(</span><span class="nx">chainId</span> <span class="kt">string</span><span class="p">,</span> <span class="nx">org</span> <span class="nx">Organization</span><span class="p">)</span>

	<span class="c1">// CheckRevokeTlsCerts check whether any tls certs revoked.</span>
	<span class="nx">CheckRevokeTlsCerts</span><span class="p">(</span><span class="nx">org</span> <span class="nx">Organization</span><span class="p">,</span> <span class="nx">certManageSystemContractPayload</span> <span class="p">[]</span><span class="kt">byte</span><span class="p">)</span> <span class="kt">error</span>
<span class="p">}</span>


<span class="kd">type</span> <span class="nx">MsgHandler</span> <span class="kd">func</span><span class="p">(</span><span class="nx">from</span> <span class="kt">string</span><span class="p">,</span> <span class="nx">msg</span> <span class="p">[]</span><span class="kt">byte</span><span class="p">,</span> <span class="nx">msgType</span> <span class="nx">pb</span><span class="p">.</span><span class="nx">NetMsg_MsgType</span><span class="p">)</span> <span class="kt">error</span>

<span class="c1">// ChainNodesInfoProvider provide base node info list of chain.</span>
<span class="kd">type</span> <span class="nx">ChainNodesInfoProvider</span> <span class="kd">interface</span> <span class="p">{</span>
	<span class="c1">// ChainNodesInfo return base node info list of chain.</span>
	<span class="nx">ChainNodesInfo</span><span class="p">()</span> <span class="p">([]</span><span class="o">*</span><span class="nx">ChainNodeInfo</span><span class="p">,</span> <span class="kt">error</span><span class="p">)</span>
<span class="p">}</span>

<span class="c1">//  NetService</span>
<span class="kd">type</span> <span class="nx">NetService</span> <span class="kd">interface</span> <span class="p">{</span>
	<span class="c1">// ChainId return the chainId of the net service.</span>
	<span class="nx">ChainId</span><span class="p">()</span> <span class="kt">string</span>

	<span class="c1">// BroadcastMsg broadcast a msg to the net.</span>
	<span class="nx">BroadcastMsg</span><span class="p">(</span><span class="nx">msg</span> <span class="p">[]</span><span class="kt">byte</span><span class="p">,</span> <span class="nx">msgType</span> <span class="nx">pb</span><span class="p">.</span><span class="nx">NetMsg_MsgType</span><span class="p">)</span> <span class="kt">error</span>

	<span class="c1">// Subscribe register a MsgHandler for subscribe.</span>
	<span class="nx">Subscribe</span><span class="p">(</span><span class="nx">msgType</span> <span class="nx">pb</span><span class="p">.</span><span class="nx">NetMsg_MsgType</span><span class="p">,</span> <span class="nx">handler</span> <span class="nx">MsgHandler</span><span class="p">)</span> <span class="kt">error</span>

	<span class="c1">// CancelSubscribe cancel subscribe.</span>
	<span class="nx">CancelSubscribe</span><span class="p">(</span><span class="nx">msgType</span> <span class="nx">pb</span><span class="p">.</span><span class="nx">NetMsg_MsgType</span><span class="p">)</span> <span class="kt">error</span>

	<span class="c1">// ConsensusBroadcastMsg broadcast a msg to the consensus nodes.</span>
	<span class="nx">ConsensusBroadcastMsg</span><span class="p">(</span><span class="nx">msg</span> <span class="p">[]</span><span class="kt">byte</span><span class="p">,</span> <span class="nx">msgType</span> <span class="nx">pb</span><span class="p">.</span><span class="nx">NetMsg_MsgType</span><span class="p">)</span> <span class="kt">error</span>

	<span class="c1">// ConsensusSubscribe register a MsgHandler handle the msg from consensus nodes for subscribe.</span>
	<span class="nx">ConsensusSubscribe</span><span class="p">(</span><span class="nx">msgType</span> <span class="nx">pb</span><span class="p">.</span><span class="nx">NetMsg_MsgType</span><span class="p">,</span> <span class="nx">handler</span> <span class="nx">MsgHandler</span><span class="p">)</span> <span class="kt">error</span>

	<span class="c1">// CancelConsensusSubscribe cancel subscribe.</span>
	<span class="nx">CancelConsensusSubscribe</span><span class="p">(</span><span class="nx">msgType</span> <span class="nx">pb</span><span class="p">.</span><span class="nx">NetMsg_MsgType</span><span class="p">)</span> <span class="kt">error</span>

	<span class="c1">// SendMsg send msg to any nodes.</span>
	<span class="nx">SendMsg</span><span class="p">(</span><span class="nx">msg</span> <span class="p">[]</span><span class="kt">byte</span><span class="p">,</span> <span class="nx">msgType</span> <span class="nx">pb</span><span class="p">.</span><span class="nx">NetMsg_MsgType</span><span class="p">,</span> <span class="nx">to</span> <span class="o">...</span><span class="kt">string</span><span class="p">)</span> <span class="kt">error</span>

	<span class="c1">// ReceiveMsg register a MsgHandler to handle the msg received from other node.</span>
	<span class="nx">ReceiveMsg</span><span class="p">(</span><span class="nx">msgType</span> <span class="nx">pb</span><span class="p">.</span><span class="nx">NetMsg_MsgType</span><span class="p">,</span> <span class="nx">handler</span> <span class="nx">MsgHandler</span><span class="p">)</span> <span class="kt">error</span>

	<span class="c1">// Start the net service.</span>
	<span class="nx">Start</span><span class="p">()</span> <span class="kt">error</span>

	<span class="c1">// Stop the net service.</span>
	<span class="nx">Stop</span><span class="p">()</span> <span class="kt">error</span>

	<span class="c1">// GetNodeUidByCertId return node uid which mapped to the given cert id. If unmapped return error.</span>
	<span class="nx">GetNodeUidByCertId</span><span class="p">(</span><span class="nx">certId</span> <span class="kt">string</span><span class="p">)</span> <span class="p">(</span><span class="kt">string</span><span class="p">,</span> <span class="kt">error</span><span class="p">)</span>

	<span class="c1">// GetChainNodesInfoProvider return a implementation of ChainNodesInfoProvider.</span>
	<span class="nx">GetChainNodesInfoProvider</span><span class="p">()</span> <span class="nx">ChainNodesInfoProvider</span>
<span class="p">}</span>
</pre></div>
</div>
</div>
<div class="section" id="id22">
<h4><strong>使用配置</strong><a class="headerlink" href="#id22" title="Permalink to this headline">¶</a></h4>
<ul class="simple">
<li><p>chainmaker.yml</p></li>
</ul>
<div class="highlight-yaml notranslate"><div class="highlight"><pre><span></span><span class="nt">net</span><span class="p">:</span>
  <span class="c1"># 底层网络类型</span>
  <span class="nt">provider</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">LibP2P</span>
  <span class="c1"># 本地网路监听地址及端口</span>
  <span class="nt">listen_addr</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">/ip4/0.0.0.0/tcp/6666</span>
  <span class="c1"># 每个节点连接stream池大小上限，不配默认为100</span>
  <span class="nt">peer_stream_pool_size</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">100</span>
  <span class="c1"># 允许与本节点建立链接的节点总数量，不配默认为20</span>
  <span class="nt">max_peer_count_allow</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">10</span>
  <span class="c1"># 节点链接淘汰策略，1 Random, 2 FIFO, 3 LIFO。不配默认为3</span>
  <span class="nt">peer_elimination_strategy</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">3</span>
  <span class="c1"># 种子节点地址列表，用于节点发现，可选项</span>
  <span class="nt">seeds</span><span class="p">:</span> 
    <span class="p p-Indicator">-</span> <span class="s">&quot;/ip4/127.0.0.1/tcp/6666/p2p/QmQZn3pZCcuEf34FSvucqkvVJEvfzpNjQTk17HS6CYMR35&quot;</span>
  <span class="c1"># TLS认证相关配置</span>
  <span class="nt">tls</span><span class="p">:</span>
    <span class="c1"># TLS认证开关</span>
    <span class="nt">enabled</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">true</span>
    <span class="c1"># TLS证书</span>
    <span class="nt">priv_key_file</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">./crypto-config/wx-org1.chainmaker.org/node/consensus1/consensus1.tls.key</span>
    <span class="nt">cert_file</span><span class="p">:</span>     <span class="l l-Scalar l-Scalar-Plain">./crypto-config/wx-org1.chainmaker.org/node/consensus1/consensus1.tls.crt</span>
  <span class="c1"># 组网黑名单配置，可选项</span>
  <span class="nt">blacklist</span><span class="p">:</span>
    <span class="c1"># 黑名单地址，可选项，[ip]:[port]或者[ip]两者均可</span>
    <span class="nt">addresses</span><span class="p">:</span>
      <span class="p p-Indicator">-</span> <span class="s">&quot;127.0.0.1:11305&quot;</span>
      <span class="p p-Indicator">-</span> <span class="s">&quot;192.168.1.8&quot;</span>
    <span class="c1"># 黑名单节点ID，可选项</span>
    <span class="nt">node_ids</span><span class="p">:</span>
      <span class="p p-Indicator">-</span> <span class="s">&quot;QmeyNRs2DwWjcHTpcVHoUSaDAAif4VQZ2wQDQAUNDP33gH&quot;</span>
      <span class="p p-Indicator">-</span> <span class="s">&quot;QmVSCXfPweL1GRSNt8gjcw1YQ2VcCirAtTdLKGkgGKsHqi&quot;</span>
</pre></div>
</div>
<p>在链初始化阶段，net_service在初始化时会读取链配置chainconfig下的共识节点列表和trust_root。当前阶段，网络会将共识节点作为种子节点seeds的一员，并会通过ConnSupervisor维护与其之间的链接；网络还会维护一份共识节点ID列表，便于向共识节点定向广播；trust_root作为TLS认证可信根证书池，同时会根据不同链的根证书池来确定对方节点隶属于哪条链。</p>
</div>
<div class="section" id="id23">
<h4><strong>节点地址格式说明</strong><a class="headerlink" href="#id23" title="Permalink to this headline">¶</a></h4>
<p>长安链节点地址遵循libp2p网络地址格式协定，使用multaddr组件解析地址，例如：</p>
<div class="highlight-text notranslate"><div class="highlight"><pre><span></span>/ip4/127.0.0.1/tcp/6666/p2p/QmQZn3pZCcuEf34FSvucqkvVJEvfzpNjQTk17HS6CYMR35
</pre></div>
</div>
<p>或者</p>
<div class="highlight-text notranslate"><div class="highlight"><pre><span></span>/dns4/chainmaker.org/tcp/6666/p2p/QmQZn3pZCcuEf34FSvucqkvVJEvfzpNjQTk17HS6CYMR35
</pre></div>
</div>
<p>地址以”/”开始，并以”/”分段，大多数情况下，各段说明如下：</p>
<ul class="simple">
<li><p>第一段：IP协议版本或DNS解析协议版本。ip4代表IPv4，ip6代表IPv6；dns4对应IPv4版本DNS服务，dns6对应IPv6版本DNS服务</p></li>
<li><p>第二段：IP地址或域名，需要与第一段对应</p></li>
<li><p>第三段：通讯网络协议，默认使用tcp</p></li>
<li><p>第四段：监听端口</p></li>
<li><p>第五段：固定协议，请勿改动，固定为”p2p”</p></li>
<li><p>第六段：节点NodeId，与TLS证书配套，根据TLS证书通过特定算法计算而来</p></li>
</ul>
<p>以上只是最普通常用场景下节点地址举例，在复杂网络场景下（比如需要使用节点中继、NAT穿透等）地址格式会稍有不同。</p>
</div>
<div class="section" id="id24">
<h4><strong>网络消息数据格式说明（加密前）</strong><a class="headerlink" href="#id24" title="Permalink to this headline">¶</a></h4>
<p>加密前的消息数据是由 <code class="docutils literal notranslate"><span class="pre">8位byte表示数据长度</span> <span class="pre">+</span> <span class="pre">1位byte数据压缩标识</span> <span class="pre">+</span> <span class="pre">实际数据</span></code> 来组成。</p>
<p>为了方便说明，我们使用如下例子：</p>
<div class="highlight-text notranslate"><div class="highlight"><pre><span></span>[0 0 0 0 0 0 0 78 0 10 57 10 5 ...... 80 85 83 72]
</pre></div>
</div>
<p>假设这是一条待发送的网络消息数据，其中：</p>
<ul class="simple">
<li><p>前8位，[0 0 0 0 0 0 0 78] 表示要发送数据的长度，在接收方接收数据时，若接收到的数据长度不足该值，则会尝试继续读取数据，直至接收全部长度的数据或接收失败。</p></li>
<li><p>第9位，[0] 或 [1] 是数据压缩标记位，若是1，接收方在接收到完整数据后，会将接收到的数据进行解压缩，得到最终的数据结果。</p></li>
<li><p>剩余位，[10 57 10 5 …… 80 85 83 72] 为要发送的原始数据或被压缩后的原始数据，是否压缩要与第9位压缩标识相对应。压缩/解压缩使用GZip工具包完成。</p></li>
</ul>
</div>
</div>
<div class="section" id="rpc">
<h3>RPC服务<a class="headerlink" href="#rpc" title="Permalink to this headline">¶</a></h3>
<div class="section" id="id25">
<h4>功能说明<a class="headerlink" href="#id25" title="Permalink to this headline">¶</a></h4>
<p><code class="docutils literal notranslate"><span class="pre">RPCServer</span></code>采用<code class="docutils literal notranslate"><span class="pre">gRPC</span></code>实现的远程过程调用系统，采用<code class="docutils literal notranslate"><span class="pre">HTTP/2</span></code> 传输协议，使用<code class="docutils literal notranslate"><span class="pre">Protobuf</span></code> 作为接口描述语言，实现模块间的高效交互。</p>
<p>功能上支持处理节点请求、基于流模式的消息订阅，通信上支持<code class="docutils literal notranslate"><span class="pre">TLS</span></code>单向和双向认证、流控机制等。</p>
</div>
<div class="section" id="id26">
<h4>配置说明<a class="headerlink" href="#id26" title="Permalink to this headline">¶</a></h4>
<div class="highlight-yml notranslate"><div class="highlight"><pre><span></span>rpc:
  provider: grpc
  port: 12301
  # 检查链配置TrustRoots证书变化时间间隔，单位：s，最小值为10s
  check_chain_conf_trust_roots_change_interval: 60
  ratelimit:
    # 每秒补充令牌数，取值：-1-不受限；0-默认值（10000）
    token_per_second: -1
    # 令牌桶大小，取值：-1-不受限；0-默认值（10000）
    token_bucket_size: -1
  subscriber:
    # 历史消息订阅流控，实时消息订阅不会进行流控
    ratelimit:
      # 每秒补充令牌数，取值：-1-不受限；0-默认值（1000）
      token_per_second: 100
      # 令牌桶大小，取值：-1-不受限；0-默认值（1000）
      token_bucket_size: 100
  tls:
    # TLS模式:
    #   disable - 不启用TLS
    #   oneway  - 单向认证
    #   twoway  - 双向认证
    mode:           twoway
    priv_key_file:  ./certs/node/consensus1/consensus1.tls.key
    cert_file:      ./certs/node/consensus1/consensus1.tls.crt
</pre></div>
</div>
</div>
<div class="section" id="id27">
<h4>接口定义<a class="headerlink" href="#id27" title="Permalink to this headline">¶</a></h4>
<div class="highlight-protobuf notranslate"><div class="highlight"><pre><span></span><span class="kd">service</span> <span class="n">RpcNode</span> <span class="p">{</span>
	<span class="c1">// 交易消息请求处理</span>
	<span class="k">rpc</span> <span class="n">SendRequest</span><span class="p">(</span><span class="n">TxRequest</span><span class="p">)</span> <span class="k">returns</span> <span class="p">(</span><span class="n">TxResponse</span><span class="p">)</span> <span class="p">{};</span>

	<span class="c1">// 消息订阅请求处理</span>
	<span class="k">rpc</span> <span class="n">Subscribe</span><span class="p">(</span><span class="n">TxRequest</span><span class="p">)</span> <span class="k">returns</span> <span class="p">(</span><span class="n">stream</span> <span class="n">SubscribeResult</span><span class="p">)</span> <span class="p">{};</span>

	<span class="c1">// 更新日志级别</span>
	<span class="k">rpc</span> <span class="n">RefreshLogLevelsConfig</span><span class="p">(</span><span class="n">LogLevelsRequest</span><span class="p">)</span> <span class="k">returns</span> <span class="p">(</span><span class="n">LogLevelsResponse</span><span class="p">)</span> <span class="p">{};</span>

	<span class="c1">// 获取长安链版本</span>
	<span class="k">rpc</span> <span class="n">GetChainMakerVersion</span><span class="p">(</span><span class="n">ChainMakerVersionRequest</span><span class="p">)</span> <span class="k">returns</span><span class="p">(</span><span class="n">ChainMakerVersionResponse</span><span class="p">)</span> <span class="p">{};</span>

	<span class="c1">// 检查链配置并动态加载新链</span>
	<span class="k">rpc</span> <span class="n">CheckNewBlockChainConfig</span><span class="p">(</span><span class="n">CheckNewBlockChainConfigRequest</span><span class="p">)</span> <span class="k">returns</span> <span class="p">(</span><span class="n">CheckNewBlockChainConfigResponse</span><span class="p">)</span> <span class="p">{};</span>

	<span class="c1">// 更新Debug状态（开发调试）</span>
	<span class="k">rpc</span> <span class="n">UpdateDebugConfig</span><span class="p">(</span><span class="n">DebugConfigRequest</span><span class="p">)</span> <span class="k">returns</span> <span class="p">(</span><span class="n">DebugConfigResponse</span><span class="p">)</span> <span class="p">{};</span>
<span class="p">}</span>
</pre></div>
</div>
</div>
<div class="section" id="id28">
<h4>关键数据结构<a class="headerlink" href="#id28" title="Permalink to this headline">¶</a></h4>
<ul class="simple">
<li><p><strong>TxRequest</strong></p></li>
</ul>
<p><img alt="image-20210205114809765" src="../_images/txrequest.png" /></p>
<ul class="simple">
<li><p><strong>TxResponse</strong></p></li>
</ul>
<p><img alt="image-20210205114858708" src="../_images/txresponse.png" /></p>
</div>
<div class="section" id="id29">
<h4>关键逻辑<a class="headerlink" href="#id29" title="Permalink to this headline">¶</a></h4>
<ul class="simple">
<li><p><strong>消息订阅（事件通知）</strong></p></li>
</ul>
<p><img alt="image-20210205110331710" src="../_images/rpc-subscribe.png" /></p>
<p>（1）订阅者发起消息订阅请求，当前支持订阅区块消息和交易消息</p>
<p>（2）如果只是订阅历史数据，直接从账本存储（<code class="docutils literal notranslate"><span class="pre">Store</span></code>）中获取后返回给订阅者</p>
<p>（3）如果需要订阅实时数据，则会有<code class="docutils literal notranslate"><span class="pre">Subscriber</span></code>发起订阅事件，将<code class="docutils literal notranslate"><span class="pre">chan</span></code>注册到订阅者列表中，当<code class="docutils literal notranslate"><span class="pre">Core</span></code>模块有新区块产生，会发送事件通知，通过<code class="docutils literal notranslate"><span class="pre">chan</span></code>通知到<code class="docutils literal notranslate"><span class="pre">Subscriber</span></code>，通过<code class="docutils literal notranslate"><span class="pre">RPCServer</span></code>返回给订阅者</p>
<p>（4）如果需要同时订阅历史和实时数据，则会分别从账本存储（<code class="docutils literal notranslate"><span class="pre">Store</span></code>）以及消息订阅发布者获取，而后返回给订阅者</p>
<p>（5）若订阅消息发送完，<code class="docutils literal notranslate"><span class="pre">RPCServer</span></code>会主动关闭订阅通道，避免资源浪费</p>
</div>
</div>
<div class="section" id="id30">
<h3>存储模块<a class="headerlink" href="#id30" title="Permalink to this headline">¶</a></h3>
<p>存储模块负责存储区块链上的区块、交易、账本数据和历史读写集数据，在提交区块时，这些数据就会被存储模块进行存储。存储模块的整体架构如下图：</p>
<p><img alt="存储架构图" src="../_images/store_structure.png" /></p>
<div class="section" id="id31">
<h4>账本存储的处理流程<a class="headerlink" href="#id31" title="Permalink to this headline">¶</a></h4>
<div class="section" id="id32">
<h5>区块提交存储流程<a class="headerlink" href="#id32" title="Permalink to this headline">¶</a></h5>
<ol class="simple">
<li><p>首先序列化后的区块数据、读写集列表、以及最新区块高度写入Block binary log(wal)，用于异常中断后的恢复。同时为了提高性能，加入cache层，新区块提交请求在更新完Block binary log之后，再将区块数据（包括区块、交易、状态数据、读写集）写入cache。更新完log和cache后即可返回，由后台线程异步更新Block DB、State DB和History DB。</p></li>
<li><p>在Block DB中记录区块信息与交易信息，其中交易信息以TxID作为key存储，区块信息以BlockHeight作为key存储，区块信息中只记录交易ID列表，同时索引BlockHash到BlockHeight的映射关系，同时Block DB中记录最新的区块高度（LastBlockHeight）作为checkpoint，以批量事务的方式提交，保证批处理的原子性。</p></li>
<li><p>在State DB中记录交易修改的state数据，key为合约名与对象主键的组合：&lt;contractName, ObjectKey&gt;，同时记录最新的区块高度（LastBlockHeight）作为checkpoint，以批量事务的方式提交，保证批处理的原子性。</p></li>
<li><p>在History DB中记录交易的读写集，读写集以TxID作为key，同时记录最新的区块高度（LastBlockHeight）作为checkpoint，以批量事务的方式提交，保证批处理的原子性。</p></li>
</ol>
</div>
<div class="section" id="id33">
<h5>账本恢复流程<a class="headerlink" href="#id33" title="Permalink to this headline">¶</a></h5>
<p>如果在提交区块过程中，单个数据库存储发生异常，将会导致数据库之间的数据不一致，程序遇到这种情况后会主动退出。然后系统在重启时会进入恢复流程：</p>
<ol class="simple">
<li><p>分别从Block binary log、Block DB、State DB、History DB中获取最新的区块高度，以Block binary log中的区块高度作为基准高度，判断其他DB是否落后基准高度。</p></li>
<li><p>如果存在DB落后基准高度，则从Block bianry log中获取缺失的区块及读写集，依次提交到落后DB中。</p></li>
<li><p>所有DB同步到基准高度后，存储模块启动完成，BlockChain模块继续调度其他模块完成启动。</p></li>
</ol>
</div>
<div class="section" id="id34">
<h5>账本查询流程<a class="headerlink" href="#id34" title="Permalink to this headline">¶</a></h5>
<p>查询请求首先查询cache中的kv数据，如果cache命中则返回，cache不存在再从DB中查询。对于删除操作，cache中提供标记删除，以表明最新的key已经被删除。对于范围查询，多条数据可能同时存在cache和db中，需要进行数据合并。</p>
</div>
</div>
<div class="section" id="id35">
<h4>账本数据库类型<a class="headerlink" href="#id35" title="Permalink to this headline">¶</a></h4>
<p>账本数据库支持多个不同的数据库，以匹配不同的业务需求</p>
<ul class="simple">
<li><p>LevelDB</p></li>
<li><p>RocksDB</p></li>
<li><p>MySQL/分布式MySQL</p></li>
</ul>
</div>
<div class="section" id="id36">
<h4>存储模块接口<a class="headerlink" href="#id36" title="Permalink to this headline">¶</a></h4>
<div class="highlight-go notranslate"><div class="highlight"><pre><span></span><span class="c1">// BlockchainStore provides handle to store instances</span>
<span class="kd">type</span> <span class="nx">BlockchainStore</span> <span class="kd">interface</span> <span class="p">{</span>

	<span class="c1">// PutBlock commits the block and the corresponding rwsets in an atomic operation</span>
	<span class="nx">PutBlock</span><span class="p">(</span><span class="nx">block</span> <span class="o">*</span><span class="nx">pb</span><span class="p">.</span><span class="nx">Block</span><span class="p">,</span> <span class="nx">txRWSets</span> <span class="p">[]</span><span class="o">*</span><span class="nx">pb</span><span class="p">.</span><span class="nx">TxRWSet</span><span class="p">)</span> <span class="kt">error</span>

	<span class="c1">// GetBlockByHash returns a block given it&#39;s hash, or returns nil if none exists.</span>
	<span class="nx">GetBlockByHash</span><span class="p">(</span><span class="nx">blockHash</span> <span class="p">[]</span><span class="kt">byte</span><span class="p">)</span> <span class="p">(</span><span class="o">*</span><span class="nx">pb</span><span class="p">.</span><span class="nx">Block</span><span class="p">,</span> <span class="kt">error</span><span class="p">)</span>

	<span class="c1">// BlockExists returns true if the black hash exist, or returns false if none exists.</span>
	<span class="nx">BlockExists</span><span class="p">(</span><span class="nx">blockHash</span> <span class="p">[]</span><span class="kt">byte</span><span class="p">)</span> <span class="p">(</span><span class="kt">bool</span><span class="p">,</span> <span class="kt">error</span><span class="p">)</span>

	<span class="c1">// GetBlock returns a block given it&#39;s block height, or returns nil if none exists.</span>
	<span class="nx">GetBlock</span><span class="p">(</span><span class="nx">height</span> <span class="kt">int64</span><span class="p">)</span> <span class="p">(</span><span class="o">*</span><span class="nx">pb</span><span class="p">.</span><span class="nx">Block</span><span class="p">,</span> <span class="kt">error</span><span class="p">)</span>

	<span class="c1">// GetLastConfigBlock returns the last config block.</span>
	<span class="nx">GetLastConfigBlock</span><span class="p">()</span> <span class="p">(</span><span class="o">*</span><span class="nx">pb</span><span class="p">.</span><span class="nx">Block</span><span class="p">,</span> <span class="kt">error</span><span class="p">)</span>

	<span class="c1">// GetBlockByTx returns a block which contains a tx.</span>
	<span class="nx">GetBlockByTx</span><span class="p">(</span><span class="nx">txId</span> <span class="kt">string</span><span class="p">)</span> <span class="p">(</span><span class="o">*</span><span class="nx">pb</span><span class="p">.</span><span class="nx">Block</span><span class="p">,</span> <span class="kt">error</span><span class="p">)</span>

	<span class="c1">// GetBlockWithRWSets returns a block and the corresponding rwsets given</span>
	<span class="c1">// it&#39;s block height, or returns nil if none exists.</span>
	<span class="nx">GetBlockWithRWSets</span><span class="p">(</span><span class="nx">height</span> <span class="kt">int64</span><span class="p">)</span> <span class="p">(</span><span class="o">*</span><span class="nx">pb</span><span class="p">.</span><span class="nx">BlockWithRWSet</span><span class="p">,</span> <span class="kt">error</span><span class="p">)</span>

	<span class="c1">// GetTx retrieves a transaction by txid, or returns nil if none exists.</span>
	<span class="nx">GetTx</span><span class="p">(</span><span class="nx">txId</span> <span class="kt">string</span><span class="p">)</span> <span class="p">(</span><span class="o">*</span><span class="nx">pb</span><span class="p">.</span><span class="nx">Transaction</span><span class="p">,</span> <span class="kt">error</span><span class="p">)</span>

	<span class="c1">// TxExists returns true if the tx exist, or returns false if none exists.</span>
	<span class="nx">TxExists</span><span class="p">(</span><span class="nx">txId</span> <span class="kt">string</span><span class="p">)</span> <span class="p">(</span><span class="kt">bool</span><span class="p">,</span> <span class="kt">error</span><span class="p">)</span>

	<span class="c1">// GetTxConfirmedTime returns the confirmed time for given tx</span>
	<span class="nx">GetTxConfirmedTime</span><span class="p">(</span><span class="nx">txId</span> <span class="kt">string</span><span class="p">)</span> <span class="p">(</span><span class="kt">int64</span><span class="p">,</span> <span class="kt">error</span><span class="p">)</span>

	<span class="c1">// GetLastBlock returns the last block.</span>
	<span class="nx">GetLastBlock</span><span class="p">()</span> <span class="p">(</span><span class="o">*</span><span class="nx">pb</span><span class="p">.</span><span class="nx">Block</span><span class="p">,</span> <span class="kt">error</span><span class="p">)</span>

	<span class="c1">// ReadObject returns the state value for given contract name and key, or returns nil if none exists.</span>
	<span class="nx">ReadObject</span><span class="p">(</span><span class="nx">contractName</span> <span class="kt">string</span><span class="p">,</span> <span class="nx">key</span> <span class="p">[]</span><span class="kt">byte</span><span class="p">)</span> <span class="p">([]</span><span class="kt">byte</span><span class="p">,</span> <span class="kt">error</span><span class="p">)</span>

	<span class="c1">// SelectObject returns an iterator that contains all the key-values between given key ranges.</span>
	<span class="c1">// startKey is included in the results and limit is excluded.</span>
	<span class="nx">SelectObject</span><span class="p">(</span><span class="nx">contractName</span> <span class="kt">string</span><span class="p">,</span> <span class="nx">startKey</span> <span class="p">[]</span><span class="kt">byte</span><span class="p">,</span> <span class="nx">limit</span> <span class="p">[]</span><span class="kt">byte</span><span class="p">)</span> <span class="nx">Iterator</span>

	<span class="c1">// GetTxRWSet returns an txRWSet for given txId, or returns nil if none exists.</span>
	<span class="nx">GetTxRWSet</span><span class="p">(</span><span class="nx">txId</span> <span class="kt">string</span><span class="p">)</span> <span class="p">(</span><span class="o">*</span><span class="nx">pb</span><span class="p">.</span><span class="nx">TxRWSet</span><span class="p">,</span> <span class="kt">error</span><span class="p">)</span>

	<span class="c1">// GetTxRWSetsByHeight returns all the rwsets corresponding to the block,</span>
	<span class="c1">// or returns nil if zhe block does not exist</span>
	<span class="nx">GetTxRWSetsByHeight</span><span class="p">(</span><span class="nx">height</span> <span class="kt">int64</span><span class="p">)</span> <span class="p">([]</span><span class="o">*</span><span class="nx">pb</span><span class="p">.</span><span class="nx">TxRWSet</span><span class="p">,</span> <span class="kt">error</span><span class="p">)</span>

	<span class="c1">// GetDBHandle returns the database handle for given dbName</span>
	<span class="nx">GetDBHandle</span><span class="p">(</span><span class="nx">dbName</span> <span class="kt">string</span><span class="p">)</span> <span class="nx">DBHandle</span>

	<span class="c1">// Close closes all the store db instances and releases any resources held by BlockchainStore</span>
	<span class="nx">Close</span><span class="p">()</span> <span class="kt">error</span>
<span class="p">}</span>
</pre></div>
</div>
</div>
<div class="section" id="id37">
<h4>配置说明<a class="headerlink" href="#id37" title="Permalink to this headline">¶</a></h4>
<p>节点本地配置关于存储部分的配置说明：</p>
<div class="highlight-yaml notranslate"><div class="highlight"><pre><span></span>storage:
	provider: LevelDB	#数据库类型，支持LevelDB，RocksDB，MySQL/分布式MySQL
	store_path: ../data/ledgerData  #账本的存储路径， 包括LevelDB、RocksDB的数据目录，Block binary log的数据目录
	write_buffer_size: 4	#LevelDB、RocksDB的write_buffer_size， 单位为MB，默认为4M
	bloom_filter_bits: 10	#LevelDB、RocksDB的布隆过滤器参数，为每个key分配的额外bit空间，默认为10，如果少于或等于0，则不开启布隆过滤。
	disable_historydb: false	#是否禁用历史读写集的存储功能， 默认为false，也就是保存历史读写集。
	mysql:	#MySQL相关配置，只有provider选择MySQL时才需要配置
		dsn: user:password?@tcp(ip:port)/	#mysql的连接信息，包括用户名、密码、ip、port等，示例：root:admin?@tcp(127.0.0.1:3306)
		max_idle_conns: 10	#连接池中维持的最大的空闲连接数，默认为10
		max_open_conns: 10	#最大的可用连接数，默认为10
		conn_max_lifetime: 60	#连接维持的最长时间，单位秒，默认为60
</pre></div>
</div>
</div>
<div class="section" id="rocksdb">
<h4>RocksDB部署<a class="headerlink" href="#rocksdb" title="Permalink to this headline">¶</a></h4>
<p>因为rocksdb本身是使用C++写的，而目前使用gorocksdb需要依赖rocksdb的库文件，因此直接编译会报错，针对该问题，目前采用了条件编译的方式。</p>
<div class="section" id="id38">
<h5>未安装Rocksdb的环境下编译启动<a class="headerlink" href="#id38" title="Permalink to this headline">¶</a></h5>
<p>针对未安装Rocksdb的环境，可直接通过go build正常编译，但是要求必须使用levelDB，若配置为rocksDB会出现空指针错误。</p>
</div>
<div class="section" id="id39">
<h5>使用RocksDB编译启动<a class="headerlink" href="#id39" title="Permalink to this headline">¶</a></h5>
<p>若要使用RocksDB则必须先本地安装RocksDB环境，安装方式包括两部分：</p>
<ul class="simple">
<li><p>1.RocksDB安装：https://github.com/facebook/rocksdb/blob/master/INSTALL.md</p></li>
<li><p>2.gorocksdb安装：https://github.com/tecbot/gorocksdb</p></li>
</ul>
<p>使用rocksdb需要通过-tag方式启动，build方式：</p>
<div class="highlight-shell script notranslate"><div class="highlight"><pre><span></span>go build -tags=rocksdb 
</pre></div>
</div>
<p>若通过go run直接启动则使用下面的方式：</p>
<div class="highlight-shell script notranslate"><div class="highlight"><pre><span></span>go run -tags=rocksdb main.go {params}
</pre></div>
</div>
</div>
<div class="section" id="linuxrocksdb">
<h5>Linux下Rocksdb环境安装<a class="headerlink" href="#linuxrocksdb" title="Permalink to this headline">¶</a></h5>
<div class="section" id="id40">
<h6>1 安装依赖<a class="headerlink" href="#id40" title="Permalink to this headline">¶</a></h6>
<p>安装gcc、zlib、snappy、lz4等依赖工具</p>
<div class="highlight-shell notranslate"><div class="highlight"><pre><span></span>yum -y install lrzsz git gcc gcc-c++ lz4-devel
</pre></div>
</div>
<div class="highlight-shell notranslate"><div class="highlight"><pre><span></span>yum -y install snappy snappy-devel zlib zlib-devel bzip2 bzip2-devel lz4 lz4-devel zstd
</pre></div>
</div>
</div>
<div class="section" id="cmake">
<h6>2 安装cmake<a class="headerlink" href="#cmake" title="Permalink to this headline">¶</a></h6>
<p>gflags-2.2.2对cmake版本有要求，所以需要指定版本的cmake</p>
<div class="highlight-shell notranslate"><div class="highlight"><pre><span></span>curl -O   https://cmake.org/files/v3.6/cmake-3.6.0-Linux-x86_64.tar.gz
mv cmake-3.6.0-Linux-x86_64.tar.gz /opt/
<span class="nb">cd</span> /opt/
tar -xvzf cmake-3.6.0-Linux-x86_64.tar.gz
yum remove cmake

cat &gt;&gt;/etc/profile <span class="s">&lt;&lt;EOF</span>

<span class="s">export PATH=\$PATH:/opt/cmake-3.6.0-Linux-x86_64/bin</span>

<span class="s">EOF</span>
<span class="nb">source</span> /etc/profile
</pre></div>
</div>
</div>
<div class="section" id="gflags">
<h6>3 安装gflags<a class="headerlink" href="#gflags" title="Permalink to this headline">¶</a></h6>
<div class="highlight-shell notranslate"><div class="highlight"><pre><span></span>wget -O gflags-2.2.2.tar.gz https://github.com/gflags/gflags/archive/v2.2.2.tar.gz
tar -xvzf gflags-2.2.2.tar.gz
<span class="nb">cd</span> gflags-2.2.2/
mkdir build
<span class="nb">cd</span> build/
cmake -DBUILD_SHARED_LIBS<span class="o">=</span>ON -DBUILD_STATIC_LIBS<span class="o">=</span>ON -DINSTALL_HEADERS<span class="o">=</span>ON -DINSTALL_SHARED_LIBS<span class="o">=</span>ON -DINSTALL_STATIC_LIBS<span class="o">=</span>ON ..
make
make install

cat &gt;&gt;/etc/profile <span class="s">&lt;&lt;EOF</span>

<span class="s">export LD_LIBRARY_PATH=\$LD_LIBRARY_PATH:/usr/local/lib</span>
<span class="s">EOF</span>
<span class="nb">source</span> /etc/profile
</pre></div>
</div>
</div>
<div class="section" id="id41">
<h6>4 下载并安装rocksdb<a class="headerlink" href="#id41" title="Permalink to this headline">¶</a></h6>
<div class="highlight-shell notranslate"><div class="highlight"><pre><span></span>wget -O rocksdb-5.18.3.tar.gz https://github.com/facebook/rocksdb/archive/v5.18.3.tar.gz
tar -xzvf rocksdb-5.18.3.tar.gz

<span class="nb">cd</span> rocksdb-5.18.3
mkdir build
<span class="nb">cd</span> build

cmake -DCMAKE_INSTALL_PREFIX<span class="o">=</span>/usr/local/rocksdb ..

make
make install

cat &gt;&gt;/etc/profile <span class="s">&lt;&lt;EOF</span>

<span class="s">export CPLUS_INCLUDE_PATH=\$CPLUS_INCLUDE_PATH:/usr/local/rocksdb/include/</span>
<span class="s">export LD_LIBRARY_PATH=\$LD_LIBRARY_PATH:/usr/local/rocksdb/lib64/</span>
<span class="s">export LIBRARY_PATH=\$LIBRARY_PATH:/usr/local/rocksdb/lib64/</span>

<span class="s">EOF</span>

<span class="nb">source</span> /etc/profile
</pre></div>
</div>
</div>
<div class="section" id="id42">
<h6>5 使用测试<a class="headerlink" href="#id42" title="Permalink to this headline">¶</a></h6>
<div class="highlight-shell notranslate"><div class="highlight"><pre><span></span><span class="o">[</span>root@VM-219-157-centos /opt/rocksdb-5.18.3/build<span class="o">]</span><span class="c1"># cd tools/</span>
<span class="o">[</span>root@VM-219-157-centos /opt/rocksdb-5.18.3/build/tools<span class="o">]</span><span class="c1"># ll</span>
total <span class="m">2608</span>
drwxr-xr-x <span class="m">12</span> root root    <span class="m">4096</span> Dec <span class="m">25</span> <span class="m">10</span>:38 CMakeFiles
-rw-r--r--  <span class="m">1</span> root root     <span class="m">269</span> Dec <span class="m">25</span> <span class="m">10</span>:38 CTestTestfile.cmake
-rw-r--r--  <span class="m">1</span> root root   <span class="m">18973</span> Dec <span class="m">25</span> <span class="m">10</span>:38 Makefile
-rw-r--r--  <span class="m">1</span> root root     <span class="m">988</span> Dec <span class="m">25</span> <span class="m">10</span>:38 cmake_install.cmake
-rwxr-xr-x  <span class="m">1</span> root root  <span class="m">232649</span> Dec <span class="m">25</span> <span class="m">10</span>:55 db_repl_stress
-rwxr-xr-x  <span class="m">1</span> root root  <span class="m">233443</span> Dec <span class="m">25</span> <span class="m">10</span>:55 db_sanity_test
-rwxr-xr-x  <span class="m">1</span> root root <span class="m">1338230</span> Dec <span class="m">25</span> <span class="m">10</span>:55 db_stress
-rwxr-xr-x  <span class="m">1</span> root root   <span class="m">48060</span> Dec <span class="m">25</span> <span class="m">10</span>:55 ldb
-rwxr-xr-x  <span class="m">1</span> root root  <span class="m">207347</span> Dec <span class="m">25</span> <span class="m">10</span>:55 rocksdb_dump
-rwxr-xr-x  <span class="m">1</span> root root  <span class="m">207358</span> Dec <span class="m">25</span> <span class="m">10</span>:55 rocksdb_undump
-rwxr-xr-x  <span class="m">1</span> root root    <span class="m">8571</span> Dec <span class="m">25</span> <span class="m">10</span>:55 sst_dump
-rwxr-xr-x  <span class="m">1</span> root root  <span class="m">350147</span> Dec <span class="m">25</span> <span class="m">10</span>:55 write_stress
<span class="o">[</span>root@VM-219-157-centos /opt/rocksdb-5.18.3/build/tools<span class="o">]</span><span class="c1">#</span>
<span class="o">[</span>root@VM-219-157-centos /opt/rocksdb-5.18.3/build/tools<span class="o">]</span><span class="c1">#</span>
<span class="o">[</span>root@VM-219-157-centos /opt/rocksdb-5.18.3/build/tools<span class="o">]</span><span class="c1">#</span>
<span class="o">[</span>root@VM-219-157-centos /opt/rocksdb-5.18.3/build/tools<span class="o">]</span><span class="c1"># ./ldb -help</span>
ldb - RocksDB Tool

commands MUST specify --db<span class="o">=</span>&lt;full_path_to_db_directory&gt; when necessary

The following optional parameters control <span class="k">if</span> keys/values are input/output as hex or as plain strings:
  --key_hex : Keys are input/output as hex
  --value_hex : Values are input/output as hex
  --hex : Both keys and values are input/output as hex

The following optional parameters control the database internals:
  --column_family<span class="o">=</span>&lt;string&gt; : name of the column family to operate on. default: default column family
  --ttl with <span class="s1">&#39;put&#39;</span>,<span class="s1">&#39;get&#39;</span>,<span class="s1">&#39;scan&#39;</span>,<span class="s1">&#39;dump&#39;</span>,<span class="s1">&#39;query&#39;</span>,<span class="s1">&#39;batchput&#39;</span> : DB supports ttl and value is internally timestamp-suffixed
  --try_load_options : Try to load option file from DB.
  --ignore_unknown_options : Ignore unknown options when loading option file.
  --bloom_bits<span class="o">=</span>&lt;int,e.g.:14&gt;
  --fix_prefix_len<span class="o">=</span>&lt;int,e.g.:14&gt;
  --compression_type<span class="o">=</span>&lt;no<span class="p">|</span>snappy<span class="p">|</span>zlib<span class="p">|</span>bzip2<span class="p">|</span>lz4<span class="p">|</span>lz4hc<span class="p">|</span>xpress<span class="p">|</span>zstd&gt;
  --compression_max_dict_bytes<span class="o">=</span>&lt;int,e.g.:16384&gt;
  --block_size<span class="o">=</span>&lt;block_size_in_bytes&gt;
  --auto_compaction<span class="o">=</span>&lt;true<span class="p">|</span>false&gt;
  --db_write_buffer_size<span class="o">=</span>&lt;int,e.g.:16777216&gt;
  --write_buffer_size<span class="o">=</span>&lt;int,e.g.:4194304&gt;
  --file_size<span class="o">=</span>&lt;int,e.g.:2097152&gt;


Data Access Commands:
  put &lt;key&gt; &lt;value&gt;  <span class="o">[</span>--ttl<span class="o">]</span>
  get &lt;key&gt; <span class="o">[</span>--ttl<span class="o">]</span>
  batchput &lt;key&gt; &lt;value&gt; <span class="o">[</span>&lt;key&gt; &lt;value&gt;<span class="o">]</span> <span class="o">[</span>..<span class="o">]</span> <span class="o">[</span>--ttl<span class="o">]</span>
  scan <span class="o">[</span>--from<span class="o">]</span> <span class="o">[</span>--to<span class="o">]</span>  <span class="o">[</span>--ttl<span class="o">]</span> <span class="o">[</span>--timestamp<span class="o">]</span> <span class="o">[</span>--max_keys<span class="o">=</span>&lt;N&gt;q<span class="o">]</span>  <span class="o">[</span>--start_time<span class="o">=</span>&lt;N&gt;:- is inclusive<span class="o">]</span> <span class="o">[</span>--end_time<span class="o">=</span>&lt;N&gt;:- is exclusive<span class="o">]</span> <span class="o">[</span>--no_value<span class="o">]</span>
  delete &lt;key&gt;
  deleterange &lt;begin key&gt; &lt;end key&gt;
  query <span class="o">[</span>--ttl<span class="o">]</span>
    Starts a REPL shell.  Type <span class="nb">help</span> <span class="k">for</span> list of available commands.
  approxsize <span class="o">[</span>--from<span class="o">]</span> <span class="o">[</span>--to<span class="o">]</span>
  checkconsistency


Admin Commands:
  dump_wal --walfile<span class="o">=</span>&lt;write_ahead_log_file_path&gt; <span class="o">[</span>--header<span class="o">]</span>  <span class="o">[</span>--print_value<span class="o">]</span>  <span class="o">[</span>--write_committed<span class="o">=</span>true<span class="p">|</span>false<span class="o">]</span>
  compact <span class="o">[</span>--from<span class="o">]</span> <span class="o">[</span>--to<span class="o">]</span>
  reduce_levels --new_levels<span class="o">=</span>&lt;New number of levels&gt; <span class="o">[</span>--print_old_levels<span class="o">]</span>
  change_compaction_style --old_compaction_style<span class="o">=</span>&lt;Old compaction style: <span class="m">0</span> <span class="k">for</span> level compaction, <span class="m">1</span> <span class="k">for</span> universal compaction&gt; --new_compaction_style<span class="o">=</span>&lt;New compaction style: <span class="m">0</span> <span class="k">for</span> level compaction, <span class="m">1</span> <span class="k">for</span> universal compaction&gt;
  dump <span class="o">[</span>--from<span class="o">]</span> <span class="o">[</span>--to<span class="o">]</span>  <span class="o">[</span>--ttl<span class="o">]</span> <span class="o">[</span>--max_keys<span class="o">=</span>&lt;N&gt;<span class="o">]</span> <span class="o">[</span>--timestamp<span class="o">]</span> <span class="o">[</span>--count_only<span class="o">]</span> <span class="o">[</span>--count_delim<span class="o">=</span>&lt;char&gt;<span class="o">]</span> <span class="o">[</span>--stats<span class="o">]</span> <span class="o">[</span>--bucket<span class="o">=</span>&lt;N&gt;<span class="o">]</span> <span class="o">[</span>--start_time<span class="o">=</span>&lt;N&gt;:- is inclusive<span class="o">]</span> <span class="o">[</span>--end_time<span class="o">=</span>&lt;N&gt;:- is exclusive<span class="o">]</span> <span class="o">[</span>--path<span class="o">=</span>&lt;path_to_a_file&gt;<span class="o">]</span>
  load <span class="o">[</span>--create_if_missing<span class="o">]</span> <span class="o">[</span>--disable_wal<span class="o">]</span> <span class="o">[</span>--bulk_load<span class="o">]</span> <span class="o">[</span>--compact<span class="o">]</span>
  manifest_dump <span class="o">[</span>--verbose<span class="o">]</span> <span class="o">[</span>--json<span class="o">]</span> <span class="o">[</span>--path<span class="o">=</span>&lt;path_to_manifest_file&gt;<span class="o">]</span>
  list_column_families full_path_to_db_directory
  dump_live_files
  idump <span class="o">[</span>--from<span class="o">]</span> <span class="o">[</span>--to<span class="o">]</span>  <span class="o">[</span>--input_key_hex<span class="o">]</span> <span class="o">[</span>--max_keys<span class="o">=</span>&lt;N&gt;<span class="o">]</span> <span class="o">[</span>--count_only<span class="o">]</span> <span class="o">[</span>--count_delim<span class="o">=</span>&lt;char&gt;<span class="o">]</span> <span class="o">[</span>--stats<span class="o">]</span>
  repair
  backup <span class="o">[</span>--backup_env_uri<span class="o">]</span>  <span class="o">[</span>--backup_dir<span class="o">]</span>  <span class="o">[</span>--num_threads<span class="o">]</span>  <span class="o">[</span>--stderr_log_level<span class="o">=</span>&lt;int <span class="o">(</span>InfoLogLevel<span class="o">)</span>&gt;<span class="o">]</span>
  restore <span class="o">[</span>--backup_env_uri<span class="o">]</span>  <span class="o">[</span>--backup_dir<span class="o">]</span>  <span class="o">[</span>--num_threads<span class="o">]</span>  <span class="o">[</span>--stderr_log_level<span class="o">=</span>&lt;int <span class="o">(</span>InfoLogLevel<span class="o">)</span>&gt;<span class="o">]</span>
  checkpoint <span class="o">[</span>--checkpoint_dir<span class="o">]</span>
  write_extern_sst &lt;output_sst_path&gt;
  ingest_extern_sst &lt;input_sst_path&gt; <span class="o">[</span>--move_files<span class="o">]</span>  <span class="o">[</span>--snapshot_consistency<span class="o">]</span>  <span class="o">[</span>--allow_global_seqno<span class="o">]</span>  <span class="o">[</span>--allow_blocking_flush<span class="o">]</span>  <span class="o">[</span>--ingest_behind<span class="o">]</span>  <span class="o">[</span>--write_global_seqno<span class="o">]</span>

<span class="o">[</span>root@VM-219-157-centos /opt/rocksdb-5.18.3/build/tools<span class="o">]</span><span class="c1">#</span>
<span class="o">[</span>root@VM-219-157-centos /opt/rocksdb-5.18.3/build/tools<span class="o">]</span><span class="c1">#</span>
<span class="o">[</span>root@VM-219-157-centos /opt/rocksdb-5.18.3/build/tools<span class="o">]</span><span class="c1">#</span>
<span class="o">[</span>root@VM-219-157-centos /opt/rocksdb-5.18.3/build/tools<span class="o">]</span><span class="c1">#</span>
<span class="o">[</span>root@VM-219-157-centos /opt/rocksdb-5.18.3/build/tools<span class="o">]</span><span class="c1">#</span>
<span class="o">[</span>root@VM-219-157-centos /opt/rocksdb-5.18.3/build/tools<span class="o">]</span><span class="c1">#</span>
<span class="o">[</span>root@VM-219-157-centos /opt/rocksdb-5.18.3/build/tools<span class="o">]</span><span class="c1"># pwd</span>
/opt/rocksdb-5.18.3/build/tools
<span class="o">[</span>root@VM-219-157-centos /opt/rocksdb-5.18.3/build/tools<span class="o">]</span><span class="c1"># ll /tmp/</span>
total <span class="m">32</span>
srwxrwxrwx <span class="m">1</span> root root    <span class="m">0</span> Dec <span class="m">18</span> <span class="m">23</span>:04 agent_cmd.sock
drwxr-xr-x <span class="m">2</span> root root <span class="m">4096</span> Dec <span class="m">25</span> <span class="m">10</span>:14 commandnotfound
-rw-r--r-- <span class="m">1</span> root root   <span class="m">53</span> Dec <span class="m">17</span> <span class="m">10</span>:44 cpuidle_support.log
-rw-r--r-- <span class="m">1</span> root root <span class="m">2513</span> Dec <span class="m">17</span> <span class="m">10</span>:43 cvm_init.log
-rw-r--r-- <span class="m">1</span> root root  <span class="m">297</span> Dec <span class="m">17</span> <span class="m">10</span>:44 net_affinity.log
-rw-r--r-- <span class="m">1</span> root root   <span class="m">26</span> Dec <span class="m">17</span> <span class="m">10</span>:44 nv_gpu_conf.log
-rw-r--r-- <span class="m">1</span> root root  <span class="m">155</span> Dec <span class="m">17</span> <span class="m">10</span>:44 setRps.log
drwx------ <span class="m">3</span> root root <span class="m">4096</span> Dec <span class="m">17</span> <span class="m">10</span>:44 systemd-private-e9868203df724169bf07a791d55819cd-ntpd.service-mA2nuw
-rw-r--r-- <span class="m">1</span> root root <span class="m">2017</span> Dec <span class="m">17</span> <span class="m">10</span>:44 virtio_blk_affinity.log
<span class="o">[</span>root@VM-219-157-centos /opt/rocksdb-5.18.3/build/tools<span class="o">]</span><span class="c1"># ./ldb --db=/tmp/test_db --create_if_missing put a1 b1</span>
OK

<span class="o">[</span>root@VM-219-157-centos /opt/rocksdb-5.18.3/build/tools<span class="o">]</span><span class="c1"># ./ldb --db=/tmp/test_db scan</span>
a1 : b1

<span class="o">[</span>root@VM-219-157-centos /opt/rocksdb-5.18.3/build/tools<span class="o">]</span><span class="c1"># ./ldb --db=/tmp/test_db get a1</span>
b1

<span class="o">[</span>root@VM-219-157-centos /opt/rocksdb-5.18.3/build/tools<span class="o">]</span><span class="c1"># ./ldb --db=/tmp/test_db get a2</span>
Failed: NotFound:
<span class="o">[</span>root@VM-219-157-centos /opt/rocksdb-5.18.3/build/tools<span class="o">]</span><span class="c1"># cd /tmp/test_db/</span>
<span class="o">[</span>root@VM-219-157-centos /tmp/test_db<span class="o">]</span><span class="c1"># ll</span>
total <span class="m">920</span>
-rw-r--r-- <span class="m">1</span> root root    <span class="m">26</span> Dec <span class="m">25</span> <span class="m">11</span>:13 <span class="m">000003</span>.log
-rw-r--r-- <span class="m">1</span> root root    <span class="m">16</span> Dec <span class="m">25</span> <span class="m">11</span>:13 CURRENT
-rw-r--r-- <span class="m">1</span> root root    <span class="m">37</span> Dec <span class="m">25</span> <span class="m">11</span>:13 IDENTITY
-rw-r--r-- <span class="m">1</span> root root     <span class="m">0</span> Dec <span class="m">25</span> <span class="m">11</span>:13 LOCK
-rw-r--r-- <span class="m">1</span> root root <span class="m">16246</span> Dec <span class="m">25</span> <span class="m">11</span>:14 LOG
-rw-r--r-- <span class="m">1</span> root root <span class="m">19272</span> Dec <span class="m">25</span> <span class="m">11</span>:13 LOG.old.1608866049557780
-rw-r--r-- <span class="m">1</span> root root <span class="m">15784</span> Dec <span class="m">25</span> <span class="m">11</span>:14 LOG.old.1608866049562808
-rw-r--r-- <span class="m">1</span> root root <span class="m">16246</span> Dec <span class="m">25</span> <span class="m">11</span>:14 LOG.old.1608866058035881
-rw-r--r-- <span class="m">1</span> root root <span class="m">15788</span> Dec <span class="m">25</span> <span class="m">11</span>:14 LOG.old.1608866058041253
-rw-r--r-- <span class="m">1</span> root root <span class="m">16250</span> Dec <span class="m">25</span> <span class="m">11</span>:14 LOG.old.1608866062086538
-rw-r--r-- <span class="m">1</span> root root <span class="m">15784</span> Dec <span class="m">25</span> <span class="m">11</span>:14 LOG.old.1608866062091559
-rw-r--r-- <span class="m">1</span> root root    <span class="m">13</span> Dec <span class="m">25</span> <span class="m">11</span>:13 MANIFEST-000001
-rw-r--r-- <span class="m">1</span> root root  <span class="m">4744</span> Dec <span class="m">25</span> <span class="m">11</span>:13 OPTIONS-000005
</pre></div>
</div>
</div>
<div class="section" id="zstd">
<h6>6 安装zstd<a class="headerlink" href="#zstd" title="Permalink to this headline">¶</a></h6>
<p>zstd是facebook为适配rocksdb开发的zstandard数据压缩工具，如果不安装该软件，会导致gorocksdb安装失败。</p>
<p>安装步骤如下：</p>
<div class="highlight-shell notranslate"><div class="highlight"><pre><span></span><span class="nb">cd</span> /usr/local
git clone https://github.com/facebook/zstd.git
<span class="nb">cd</span> zstd
make
make install
</pre></div>
</div>
</div>
<div class="section" id="gorocksdb">
<h6>7 安装gorocksdb<a class="headerlink" href="#gorocksdb" title="Permalink to this headline">¶</a></h6>
<p>通过4.1-4.6安装步骤后，rocksdb会被安装在 usr/local/rocksdb 这个目录下，我们使用go版本的rocksdb需要依赖于该路径。</p>
<p>目前使用的gorocksdb为：github.com/tecbot/gorocksdb</p>
<p>安装上述的安装路径，使用下面的命令即可：</p>
<div class="highlight-shell notranslate"><div class="highlight"><pre><span></span><span class="nv">CGO_CFLAGS</span><span class="o">=</span><span class="s2">&quot;-I/usr/local/rocksdb/include&quot;</span> <span class="se">\</span>
<span class="nv">CGO_LDFLAGS</span><span class="o">=</span><span class="s2">&quot;-L/usr/local/rocksdb -lrocksdb -lstdc++ -lm -lz -lbz2 -lsnappy -llz4 -lzstd&quot;</span> <span class="se">\</span>
  go get github.com/tecbot/gorocksdb
</pre></div>
</div>
<p>如果安装目录有变化，则修改对应的/usr/local/rocksdb对应的路径</p>
</div>
</div>
</div>
<div class="section" id="mysql">
<h4>MySQL存储<a class="headerlink" href="#mysql" title="Permalink to this headline">¶</a></h4>
<p>长安链支持MySQL作为账本存储引擎，同时也支持分布式的MySQL集群，如果使用MySQL作为存储引擎，长安链启动会自动创建数据库和表，使用chainId作为数据库名，同时创建相应的表：</p>
<ol>
<li><p>区块元信息表</p>
<div class="highlight-sql notranslate"><div class="highlight"><pre><span></span><span class="k">CREATE</span> <span class="k">TABLE</span> <span class="o">`</span><span class="n">block_infos</span><span class="o">`</span> <span class="p">(</span>
  <span class="o">`</span><span class="n">chain_id</span><span class="o">`</span> <span class="nb">varchar</span><span class="p">(</span><span class="mi">128</span><span class="p">)</span> <span class="k">COLLATE</span> <span class="n">utf8mb4_general_ci</span> <span class="k">DEFAULT</span> <span class="k">NULL</span><span class="p">,</span>
  <span class="o">`</span><span class="n">block_height</span><span class="o">`</span> <span class="nb">bigint</span><span class="p">(</span><span class="mi">20</span><span class="p">)</span> <span class="k">NOT</span> <span class="k">NULL</span><span class="p">,</span>
  <span class="o">`</span><span class="n">pre_block_hash</span><span class="o">`</span> <span class="n">varbinary</span><span class="p">(</span><span class="mi">128</span><span class="p">)</span> <span class="k">DEFAULT</span> <span class="k">NULL</span><span class="p">,</span>
  <span class="o">`</span><span class="n">block_hash</span><span class="o">`</span> <span class="n">varbinary</span><span class="p">(</span><span class="mi">128</span><span class="p">)</span> <span class="k">DEFAULT</span> <span class="k">NULL</span><span class="p">,</span>
  <span class="o">`</span><span class="n">pre_conf_height</span><span class="o">`</span> <span class="nb">bigint</span><span class="p">(</span><span class="mi">20</span><span class="p">)</span> <span class="k">DEFAULT</span> <span class="s1">&#39;0&#39;</span><span class="p">,</span>
  <span class="o">`</span><span class="n">block_version</span><span class="o">`</span> <span class="n">varbinary</span><span class="p">(</span><span class="mi">128</span><span class="p">)</span> <span class="k">DEFAULT</span> <span class="k">NULL</span><span class="p">,</span>
  <span class="o">`</span><span class="n">dag_hash</span><span class="o">`</span> <span class="n">varbinary</span><span class="p">(</span><span class="mi">128</span><span class="p">)</span> <span class="k">DEFAULT</span> <span class="k">NULL</span><span class="p">,</span>
  <span class="o">`</span><span class="n">rw_set_root</span><span class="o">`</span> <span class="n">varbinary</span><span class="p">(</span><span class="mi">128</span><span class="p">)</span> <span class="k">DEFAULT</span> <span class="k">NULL</span><span class="p">,</span>
  <span class="o">`</span><span class="n">tx_root</span><span class="o">`</span> <span class="n">varbinary</span><span class="p">(</span><span class="mi">128</span><span class="p">)</span> <span class="k">DEFAULT</span> <span class="k">NULL</span><span class="p">,</span>
  <span class="o">`</span><span class="n">block_timestamp</span><span class="o">`</span> <span class="nb">bigint</span><span class="p">(</span><span class="mi">20</span><span class="p">)</span> <span class="k">DEFAULT</span> <span class="s1">&#39;0&#39;</span><span class="p">,</span>
  <span class="o">`</span><span class="n">proposer</span><span class="o">`</span> <span class="nb">blob</span><span class="p">,</span>
  <span class="o">`</span><span class="n">consensus_args</span><span class="o">`</span> <span class="nb">blob</span><span class="p">,</span>
  <span class="o">`</span><span class="n">tx_count</span><span class="o">`</span> <span class="nb">bigint</span><span class="p">(</span><span class="mi">20</span><span class="p">)</span> <span class="k">DEFAULT</span> <span class="s1">&#39;0&#39;</span><span class="p">,</span>
  <span class="o">`</span><span class="n">signature</span><span class="o">`</span> <span class="nb">blob</span><span class="p">,</span>
  <span class="o">`</span><span class="n">dag</span><span class="o">`</span> <span class="nb">blob</span><span class="p">,</span>
  <span class="o">`</span><span class="n">tx_ids</span><span class="o">`</span> <span class="n">longtext</span> <span class="k">COLLATE</span> <span class="n">utf8mb4_general_ci</span><span class="p">,</span>
  <span class="o">`</span><span class="n">additional_data</span><span class="o">`</span> <span class="n">longblob</span><span class="p">,</span>
  <span class="k">PRIMARY</span> <span class="k">KEY</span> <span class="p">(</span><span class="o">`</span><span class="n">block_height</span><span class="o">`</span><span class="p">),</span>
  <span class="k">KEY</span> <span class="o">`</span><span class="n">idx_hash</span><span class="o">`</span> <span class="p">(</span><span class="o">`</span><span class="n">block_hash</span><span class="o">`</span><span class="p">)</span>
<span class="p">)</span> <span class="n">ENGINE</span><span class="o">=</span><span class="n">InnoDB</span> <span class="k">DEFAULT</span> <span class="n">CHARSET</span><span class="o">=</span><span class="n">utf8mb4</span> <span class="k">COLLATE</span><span class="o">=</span><span class="n">utf8mb4_general_ci</span><span class="p">;</span>
</pre></div>
</div>
</li>
<li><p>交易表</p>
<div class="highlight-sql notranslate"><div class="highlight"><pre><span></span><span class="k">CREATE</span> <span class="k">TABLE</span> <span class="o">`</span><span class="n">tx_infos</span><span class="o">`</span> <span class="p">(</span>
  <span class="o">`</span><span class="n">chain_id</span><span class="o">`</span> <span class="nb">varchar</span><span class="p">(</span><span class="mi">128</span><span class="p">)</span> <span class="k">COLLATE</span> <span class="n">utf8mb4_general_ci</span> <span class="k">DEFAULT</span> <span class="k">NULL</span><span class="p">,</span>
  <span class="o">`</span><span class="n">sender</span><span class="o">`</span> <span class="nb">blob</span><span class="p">,</span>
  <span class="o">`</span><span class="n">tx_id</span><span class="o">`</span> <span class="nb">varchar</span><span class="p">(</span><span class="mi">128</span><span class="p">)</span> <span class="k">COLLATE</span> <span class="n">utf8mb4_general_ci</span> <span class="k">NOT</span> <span class="k">NULL</span><span class="p">,</span>
  <span class="o">`</span><span class="n">tx_type</span><span class="o">`</span> <span class="nb">int</span><span class="p">(</span><span class="mi">11</span><span class="p">)</span> <span class="k">DEFAULT</span> <span class="k">NULL</span><span class="p">,</span>
  <span class="o">`</span><span class="n">block_height</span><span class="o">`</span> <span class="nb">bigint</span><span class="p">(</span><span class="mi">20</span><span class="p">)</span> <span class="k">DEFAULT</span> <span class="k">NULL</span><span class="p">,</span>
  <span class="o">`</span><span class="k">offset</span><span class="o">`</span> <span class="nb">int</span><span class="p">(</span><span class="mi">11</span><span class="p">)</span> <span class="k">DEFAULT</span> <span class="k">NULL</span><span class="p">,</span>
  <span class="o">`</span><span class="k">timestamp</span><span class="o">`</span> <span class="nb">bigint</span><span class="p">(</span><span class="mi">20</span><span class="p">)</span> <span class="k">DEFAULT</span> <span class="s1">&#39;0&#39;</span><span class="p">,</span>
  <span class="o">`</span><span class="n">expiration_time</span><span class="o">`</span> <span class="nb">bigint</span><span class="p">(</span><span class="mi">20</span><span class="p">)</span> <span class="k">DEFAULT</span> <span class="s1">&#39;0&#39;</span><span class="p">,</span>
  <span class="o">`</span><span class="n">request_payload</span><span class="o">`</span> <span class="n">longblob</span><span class="p">,</span>
  <span class="o">`</span><span class="n">request_signature</span><span class="o">`</span> <span class="nb">blob</span><span class="p">,</span>
  <span class="o">`</span><span class="n">code</span><span class="o">`</span> <span class="nb">int</span><span class="p">(</span><span class="mi">11</span><span class="p">)</span> <span class="k">DEFAULT</span> <span class="k">NULL</span><span class="p">,</span>
  <span class="o">`</span><span class="n">contract_result</span><span class="o">`</span> <span class="n">longblob</span><span class="p">,</span>
  <span class="o">`</span><span class="n">rw_set_hash</span><span class="o">`</span> <span class="n">varbinary</span><span class="p">(</span><span class="mi">128</span><span class="p">)</span> <span class="k">DEFAULT</span> <span class="k">NULL</span><span class="p">,</span>
  <span class="k">PRIMARY</span> <span class="k">KEY</span> <span class="p">(</span><span class="o">`</span><span class="n">tx_id</span><span class="o">`</span><span class="p">),</span>
  <span class="k">KEY</span> <span class="o">`</span><span class="n">idx_height_offset</span><span class="o">`</span> <span class="p">(</span><span class="o">`</span><span class="n">block_height</span><span class="o">`</span><span class="p">,</span><span class="o">`</span><span class="k">offset</span><span class="o">`</span><span class="p">)</span>
<span class="p">)</span> <span class="n">ENGINE</span><span class="o">=</span><span class="n">InnoDB</span> <span class="k">DEFAULT</span> <span class="n">CHARSET</span><span class="o">=</span><span class="n">utf8mb4</span> <span class="k">COLLATE</span><span class="o">=</span><span class="n">utf8mb4_general_ci</span><span class="p">;</span>
</pre></div>
</div>
</li>
<li><p>世界状态表</p>
<div class="highlight-sql notranslate"><div class="highlight"><pre><span></span><span class="k">CREATE</span> <span class="k">TABLE</span> <span class="o">`</span><span class="n">state_infos</span><span class="o">`</span> <span class="p">(</span>
  <span class="o">`</span><span class="n">contract_name</span><span class="o">`</span> <span class="nb">varchar</span><span class="p">(</span><span class="mi">128</span><span class="p">)</span> <span class="k">COLLATE</span> <span class="n">utf8mb4_general_ci</span> <span class="k">NOT</span> <span class="k">NULL</span><span class="p">,</span>
  <span class="o">`</span><span class="n">object_key</span><span class="o">`</span> <span class="n">varbinary</span><span class="p">(</span><span class="mi">128</span><span class="p">)</span> <span class="k">NOT</span> <span class="k">NULL</span> <span class="k">DEFAULT</span> <span class="s1">&#39;&#39;</span><span class="p">,</span>
  <span class="o">`</span><span class="n">object_value</span><span class="o">`</span> <span class="n">longblob</span><span class="p">,</span>
  <span class="o">`</span><span class="n">block_height</span><span class="o">`</span> <span class="nb">bigint</span><span class="p">(</span><span class="mi">20</span><span class="p">)</span> <span class="k">DEFAULT</span> <span class="k">NULL</span><span class="p">,</span>
  <span class="o">`</span><span class="n">updated_at</span><span class="o">`</span> <span class="n">datetime</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span> <span class="k">DEFAULT</span> <span class="k">NULL</span><span class="p">,</span>
  <span class="k">PRIMARY</span> <span class="k">KEY</span> <span class="p">(</span><span class="o">`</span><span class="n">contract_name</span><span class="o">`</span><span class="p">,</span><span class="o">`</span><span class="n">object_key</span><span class="o">`</span><span class="p">),</span>
  <span class="k">KEY</span> <span class="o">`</span><span class="n">idx_height</span><span class="o">`</span> <span class="p">(</span><span class="o">`</span><span class="n">block_height</span><span class="o">`</span><span class="p">)</span>
<span class="p">)</span> <span class="n">ENGINE</span><span class="o">=</span><span class="n">InnoDB</span> <span class="k">DEFAULT</span> <span class="n">CHARSET</span><span class="o">=</span><span class="n">utf8mb4</span> <span class="k">COLLATE</span><span class="o">=</span><span class="n">utf8mb4_general_ci</span><span class="p">;</span>
</pre></div>
</div>
</li>
<li><p>历史读写集表</p>
<div class="highlight-sql notranslate"><div class="highlight"><pre><span></span><span class="k">CREATE</span> <span class="k">TABLE</span> <span class="o">`</span><span class="n">history_infos</span><span class="o">`</span> <span class="p">(</span>
  <span class="o">`</span><span class="n">tx_id</span><span class="o">`</span> <span class="nb">varchar</span><span class="p">(</span><span class="mi">128</span><span class="p">)</span> <span class="k">COLLATE</span> <span class="n">utf8mb4_general_ci</span> <span class="k">NOT</span> <span class="k">NULL</span><span class="p">,</span>
  <span class="o">`</span><span class="n">rw_sets</span><span class="o">`</span> <span class="n">longblob</span><span class="p">,</span>
  <span class="o">`</span><span class="n">block_height</span><span class="o">`</span> <span class="nb">bigint</span><span class="p">(</span><span class="mi">20</span><span class="p">)</span> <span class="k">DEFAULT</span> <span class="k">NULL</span><span class="p">,</span>
  <span class="k">PRIMARY</span> <span class="k">KEY</span> <span class="p">(</span><span class="o">`</span><span class="n">tx_id</span><span class="o">`</span><span class="p">),</span>
  <span class="k">KEY</span> <span class="o">`</span><span class="n">idx_height</span><span class="o">`</span> <span class="p">(</span><span class="o">`</span><span class="n">block_height</span><span class="o">`</span><span class="p">)</span>
<span class="p">)</span> <span class="n">ENGINE</span><span class="o">=</span><span class="n">InnoDB</span> <span class="k">DEFAULT</span> <span class="n">CHARSET</span><span class="o">=</span><span class="n">utf8mb4</span> <span class="k">COLLATE</span><span class="o">=</span><span class="n">utf8mb4_general_ci</span><span class="p">;</span>
</pre></div>
</div>
</li>
</ol>
</div>
</div>
<div class="section" id="id43">
<h3>身份与权限管理<a class="headerlink" href="#id43" title="Permalink to this headline">¶</a></h3>
<div class="section" id="id44">
<h4>简介<a class="headerlink" href="#id44" title="Permalink to this headline">¶</a></h4>
<p>身份与权限管理分两部分：</p>
<ul class="simple">
<li><p>身份模块（Identity Mode）</p></li>
<li><p>权限管理（Access Control)</p></li>
</ul>
<p>身份模块是基于PKI实现的：</p>
<ul class="simple">
<li><p>私钥部分：模块管理本地节点或者用户成员的私钥，本地节点或成员与链上其他节点交互用这个私钥对消息进行签名</p></li>
<li><p>公钥部分：该模块从链配置中读取链上所有组织的公共信息，高阔公钥、证书等，用户在交互式验证对端的合法性。</p></li>
</ul>
<p>权限管理（Access Control）模块实现了链上资源与权限规则的匹配，并在链的参与者使用链上资源时验证其权限是否符合目标资源的权限规则：</p>
<ul class="simple">
<li><p>权限管理：解析默认配置、链配置中的权限配置，并维护一个资源-权限规则列表。</p></li>
<li><p>鉴权：与身份模块（Identity Mode）一起，为链上成员与资源的权限规则提供验证能力。</p></li>
</ul>
</div>
<div class="section" id="id45">
<h4>组织、成员身份模块<a class="headerlink" href="#id45" title="Permalink to this headline">¶</a></h4>
<p>身份模块由两部分组成等：</p>
<ul class="simple">
<li><p>Organization：组织模块用来管理公共验证信息和本组织的公共信息</p></li>
<li><p>Member：成员模块用来管理本地节点或者本地成员的私钥相关信息</p></li>
</ul>
<div class="section" id="member">
<h5>成员（Member）<a class="headerlink" href="#member" title="Permalink to this headline">¶</a></h5>
<div class="section" id="id46">
<h6><strong>Member</strong> 结构：<a class="headerlink" href="#id46" title="Permalink to this headline">¶</a></h6>
<div class="highlight-go notranslate"><div class="highlight"><pre><span></span><span class="kd">type</span> <span class="nx">member</span> <span class="kd">struct</span> <span class="p">{</span>
	<span class="c1">// the identity of this member (SKI of its certificate)</span>
	<span class="nx">id</span> <span class="kt">string</span>

	<span class="c1">// organization identity who owns this member</span>
	<span class="nx">orgId</span> <span class="kt">string</span>

	<span class="c1">// cert contains the x.509 certificate that signs the public key of this instance</span>
	<span class="nx">cert</span> <span class="o">*</span><span class="nx">bcx509</span><span class="p">.</span><span class="nx">Certificate</span>

	<span class="c1">// this is the public key or certificate of this instance</span>
	<span class="nx">pk</span> <span class="nx">bccrypto</span><span class="p">.</span><span class="nx">PublicKey</span>

	<span class="c1">// role of this member</span>
	<span class="nx">role</span> <span class="p">[]</span><span class="nx">protocol</span><span class="p">.</span><span class="nx">Role</span>

	<span class="c1">// authentication type: x509 certificate or plain public key</span>
	<span class="nx">identityType</span> <span class="nx">IdentityType</span>

	<span class="c1">// hash type from chain configuration</span>
	<span class="nx">hashType</span> <span class="kt">string</span>
<span class="p">}</span>
</pre></div>
</div>
<p>字段说明：</p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">id</span></code>：用户的唯一标识。</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">orgId</span></code>：所属组织，一个用户有且只有一个归属组织。</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">role</span></code>：一个用户可以有几个属于它组织下的身份</p></li>
</ul>
<p><strong>role</strong> 在 <em>protocol/access_control_interface.go</em> 里预定义了以下几种角色类型：</p>
<div class="highlight-go notranslate"><div class="highlight"><pre><span></span><span class="nx">RoleAdmin</span>         <span class="nx">Role</span> <span class="p">=</span> <span class="s">&quot;ADMIN&quot;</span>
<span class="nx">RoleClient</span>        <span class="nx">Role</span> <span class="p">=</span> <span class="s">&quot;CLIENT&quot;</span>
<span class="nx">RoleConsensusNode</span> <span class="nx">Role</span> <span class="p">=</span> <span class="s">&quot;CONSENSUS&quot;</span>
<span class="nx">RoleCommonNode</span>    <span class="nx">Role</span> <span class="p">=</span> <span class="s">&quot;COMMON&quot;</span>
</pre></div>
</div>
<p>成员作为用户时有管理员和普通用户两种角色类型，作为节点时有共识和普通两种角色类型。</p>
<p><strong>Member</strong> 接口定义及实现：</p>
<div class="highlight-go notranslate"><div class="highlight"><pre><span></span><span class="c1">// Member is the identity of a node or user.</span>
<span class="kd">type</span> <span class="nx">Member</span> <span class="kd">interface</span> <span class="p">{</span>
	<span class="c1">// GetMemberId returns the identity of this member</span>
	<span class="nx">GetMemberId</span><span class="p">()</span> <span class="kt">string</span>

	<span class="c1">// GetOrgId returns the organization id which this member belongs to</span>
	<span class="nx">GetOrgId</span><span class="p">()</span> <span class="kt">string</span>

	<span class="c1">// GetRole returns roles of this member</span>
	<span class="nx">GetRole</span><span class="p">()</span> <span class="p">[]</span><span class="nx">Role</span>

	<span class="c1">// GetSKI returns SKI for certificate mode or Public key PEM for pk mode</span>
	<span class="nx">GetSKI</span><span class="p">()</span> <span class="p">[]</span><span class="kt">byte</span>

	<span class="c1">// GetCertificate returns certificate object.</span>
	<span class="c1">// If in public key mode, return a certificate which contains public key object in PublicKey field.</span>
	<span class="nx">GetCertificate</span><span class="p">()</span> <span class="p">(</span><span class="o">*</span><span class="nx">x509</span><span class="p">.</span><span class="nx">Certificate</span><span class="p">,</span> <span class="kt">error</span><span class="p">)</span>

	<span class="c1">// Verify verifies a signature over some message using this member</span>
	<span class="nx">Verify</span><span class="p">(</span><span class="nx">hashType</span> <span class="kt">string</span><span class="p">,</span> <span class="nx">msg</span> <span class="p">[]</span><span class="kt">byte</span><span class="p">,</span> <span class="nx">sig</span> <span class="p">[]</span><span class="kt">byte</span><span class="p">)</span> <span class="kt">error</span>

	<span class="c1">// Serialize converts member to bytes</span>
	<span class="nx">Serialize</span><span class="p">(</span><span class="nx">isFullCert</span> <span class="kt">bool</span><span class="p">)</span> <span class="p">([]</span><span class="kt">byte</span><span class="p">,</span> <span class="kt">error</span><span class="p">)</span>

	<span class="c1">// GetSerializedMember returns SerializedMember</span>
	<span class="nx">GetSerializedMember</span><span class="p">(</span><span class="nx">isFullCert</span> <span class="kt">bool</span><span class="p">)</span> <span class="p">(</span><span class="o">*</span><span class="nx">pbac</span><span class="p">.</span><span class="nx">SerializedMember</span><span class="p">,</span> <span class="kt">error</span><span class="p">)</span>
<span class="p">}</span>
</pre></div>
</div>
</div>
<div class="section" id="id47">
<h6>签名<a class="headerlink" href="#id47" title="Permalink to this headline">¶</a></h6>
<p>成员签名接口定义：</p>
<div class="highlight-go notranslate"><div class="highlight"><pre><span></span><span class="kd">type</span> <span class="nx">SigningMember</span> <span class="kd">interface</span> <span class="p">{</span>
	<span class="c1">// Extends Member interface</span>
	<span class="nx">Member</span>

	<span class="c1">// Sign signs the message with the given hash type and returns signature bytes</span>
	<span class="nx">Sign</span><span class="p">(</span><span class="nx">hashType</span> <span class="kt">string</span><span class="p">,</span> <span class="nx">msg</span> <span class="p">[]</span><span class="kt">byte</span><span class="p">)</span> <span class="p">([]</span><span class="kt">byte</span><span class="p">,</span> <span class="kt">error</span><span class="p">)</span>
<span class="p">}</span>
</pre></div>
</div>
</div>
</div>
<div class="section" id="organization">
<h5>组织（Organization）<a class="headerlink" href="#organization" title="Permalink to this headline">¶</a></h5>
<div class="section" id="id48">
<h6><strong>organization</strong> 结构：<a class="headerlink" href="#id48" title="Permalink to this headline">¶</a></h6>
<div class="highlight-go notranslate"><div class="highlight"><pre><span></span><span class="kd">type</span> <span class="nx">organization</span> <span class="kd">struct</span> <span class="p">{</span>
	<span class="c1">// Name of this group</span>
	<span class="nx">id</span> <span class="kt">string</span>

	<span class="c1">// Trusted certificates or white list</span>
	<span class="nx">trustedRootCerts</span> <span class="kd">map</span><span class="p">[</span><span class="kt">string</span><span class="p">]</span><span class="o">*</span><span class="nx">bcx509</span><span class="p">.</span><span class="nx">Certificate</span>

	<span class="c1">// Trusted intermediate certificates or white list</span>
	<span class="nx">trustedIntermediateCerts</span> <span class="kd">map</span><span class="p">[</span><span class="kt">string</span><span class="p">]</span><span class="o">*</span><span class="nx">bcx509</span><span class="p">.</span><span class="nx">Certificate</span>
<span class="p">}</span>
</pre></div>
</div>
</div>
</div>
<div class="section" id="id49">
<h5>组织-成员对应关系图<a class="headerlink" href="#id49" title="Permalink to this headline">¶</a></h5>
<p>成员和组织之间的对应关系如下图所示：</p>
<p><img alt="组织-成员关系图" src="../_images/organization-member.png" /></p>
</div>
</div>
<div class="section" id="id50">
<h4>权限管理模块<a class="headerlink" href="#id50" title="Permalink to this headline">¶</a></h4>
<div class="section" id="id51">
<h5>权限规则<a class="headerlink" href="#id51" title="Permalink to this headline">¶</a></h5>
<p><strong>Rule</strong> 是规定了能够按照什么方式去做什么事，在 <em>protocol/access_control_interface.go</em> 中预定义了如下权限规则：</p>
<div class="highlight-go notranslate"><div class="highlight"><pre><span></span><span class="kd">const</span> <span class="p">(</span>
	<span class="c1">// ...</span>

	<span class="nx">RuleMajority</span>  <span class="nx">Rule</span> <span class="p">=</span> <span class="s">&quot;MAJORITY&quot;</span>
	<span class="nx">RuleAll</span>       <span class="nx">Rule</span> <span class="p">=</span> <span class="s">&quot;ALL&quot;</span>
	<span class="nx">RuleAny</span>       <span class="nx">Rule</span> <span class="p">=</span> <span class="s">&quot;ANY&quot;</span>
	<span class="nx">RuleSelf</span>      <span class="nx">Rule</span> <span class="p">=</span> <span class="s">&quot;SELF&quot;</span>
	<span class="nx">RuleForbidden</span> <span class="nx">Rule</span> <span class="p">=</span> <span class="s">&quot;FORBIDDEN&quot;</span>
	<span class="nx">RuleDelete</span>    <span class="nx">Rule</span> <span class="p">=</span> <span class="s">&quot;DELETE&quot;</span>
<span class="p">)</span>
</pre></div>
</div>
<p>各个规则的具体作用在下节策略中详细介绍！</p>
</div>
<div class="section" id="id52">
<h5>策略<a class="headerlink" href="#id52" title="Permalink to this headline">¶</a></h5>
<p><strong>Policy</strong> （策略）policy 明确了哪些组织（orgList）下的哪些人（roleList）根据什么规则（rule）有权限去做某些事（请求资源）。</p>
<p>结构如下：</p>
<div class="highlight-go notranslate"><div class="highlight"><pre><span></span><span class="kd">type</span> <span class="nx">policy</span> <span class="kd">struct</span> <span class="p">{</span>
	<span class="nx">rule</span>     <span class="nx">protocol</span><span class="p">.</span><span class="nx">Rule</span>
	<span class="nx">orgList</span>  <span class="p">[]</span><span class="kt">string</span>
	<span class="nx">roleList</span> <span class="p">[]</span><span class="nx">protocol</span><span class="p">.</span><span class="nx">Role</span>
<span class="p">}</span>
</pre></div>
</div>
<p>字段说明：</p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">orgList</span></code>：用于存储一个组织名列表，如果一个签名者不属于列表中任何一个组织，那么他的签名在当前规则</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">roleList</span></code>：用于存储一个身份名列表，如果一个签名者不具备列表中的任何一个身份，那么他的签名在当前规则中会被鉴定为不合法</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">rule</span></code>：是权限类型</p></li>
</ul>
<p><code class="docutils literal notranslate"><span class="pre">rule</span></code>规则详解：</p>
<ol>
<li><p><code class="docutils literal notranslate"><span class="pre">&quot;MAJORITY&quot;</span></code>：要求半数以上的组织共同参与，每个组织至少一个管理员身份（admin）的成员提供签名</p>
<p>a. 只有 admin 身份被认为合法。默认 <code class="docutils literal notranslate"><span class="pre">roleList</span></code> 中只有 admin 。</p>
<p>b. 可以自定义 <code class="docutils literal notranslate"><span class="pre">orgList</span></code> 。</p>
<p>c. 这个类型是修改大部分链配置的默认权限类型。</p>
<p>d. 来自同一个组织的多个 admin 身份签名只会被统计一次。</p>
</li>
<li><p><code class="docutils literal notranslate"><span class="pre">SELF</span></code> 签名者必须与目标资源所属同一个组织</p>
<p>a. 这个规则只能用于与组织有所属关系的资源。该规则下，自定义 <code class="docutils literal notranslate"><span class="pre">orgList</span></code> 将不会生效。</p>
<p>b. 只接受 admin 身份的签名者签名，自定义 <code class="docutils literal notranslate"><span class="pre">roleList</span></code> 将不会生效。
c. 一个符合组织、身份要求的签名就足够满足本规则。
d. 目前，只有组织根证书、组织共识节点两项配置可以且应该使用此规则。</p>
</li>
<li><p>“ANY”. 签名者属于 <code class="docutils literal notranslate"><span class="pre">orgList</span></code> 中的任意一个组织，且签名者拥有 <code class="docutils literal notranslate"><span class="pre">roleList</span></code> 中的任意一个身份，则签名被视为有效：
a. <code class="docutils literal notranslate"><span class="pre">orgList</span></code> 可以随意配置组织名称，留空则代表链上所有组织都满足要求。
b. <code class="docutils literal notranslate"><span class="pre">roleList</span></code> 可以随意配置任意身份集合，留空则代表所有身份都满足要求。
c. 这类规则目前主要用于宽泛的读写权限控制。</p></li>
<li><p>“ALL”. 要求 <code class="docutils literal notranslate"><span class="pre">orgList</span></code> 列表中所有组织参与，每个组织至少提供一个符合 <code class="docutils literal notranslate"><span class="pre">roleList</span></code> 要求身份的签名:
a. <code class="docutils literal notranslate"><span class="pre">orgList</span></code> 可以随意配置组织名称，留空则代表链上所有组织都满足要求。
b. <code class="docutils literal notranslate"><span class="pre">roleList</span></code> 可以随意配置任意身份集合，留空则代表所有身份都满足要求。
c. 来自同一个组织的合法签名只会被统计一次。</p></li>
<li><p>一个以字符串形式表达的整数 (eg. “3”) 作为阈值：
a. <code class="docutils literal notranslate"><span class="pre">orgList</span></code> 可以随意配置组织名称，留空则代表链上所有组织都满足要求。
b. <code class="docutils literal notranslate"><span class="pre">roleList</span></code> 可以随意配置任意身份集合，留空则代表所有身份都满足要求。
c. 这是个用户自定义的规则，这个证书可以为1到组织总数间的任意一个数，包括1和组织总数。
d. 这条规则与 <code class="docutils literal notranslate"><span class="pre">ALL</span></code> 规则相似，但不要求 <code class="docutils literal notranslate"><span class="pre">orgList</span></code> 中的所有组织参与，而只要求大于或等于阈值数量的 <code class="docutils literal notranslate"><span class="pre">orgList</span></code> 中的不同组织参与即可。</p></li>
<li><p>一个以字符串形式表达的分数 (eg. “1/3”) 作为比例：
a. <code class="docutils literal notranslate"><span class="pre">orgList</span></code> 可以随意配置组织名称，留空则代表链上所有组织都满足要求。
b. <code class="docutils literal notranslate"><span class="pre">roleList</span></code> 可以随意配置任意身份集合，留空则代表所有身份都满足要求。
c. 这是个用户自定义的规则，可以配置 [0, 1] 间的任意分数。
d. 这条规则与 “ALL” 规则相似，但不要求 <code class="docutils literal notranslate"><span class="pre">orgList</span></code> 中的所有组织参与，而只要求大于或等于比例 <code class="docutils literal notranslate"><span class="pre">orgList</span></code> 中的不同组织参与即可。</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">FORBIDDEN</span></code>：这个类型的资源被禁用了。</p></li>
</ol>
<div class="section" id="id53">
<h6>策略配置使用说明：<a class="headerlink" href="#id53" title="Permalink to this headline">¶</a></h6>
<p>示例1：<code class="docutils literal notranslate"><span class="pre">MAJORITY</span></code>规则下的策略详解：</p>
<div class="highlight-go notranslate"><div class="highlight"><pre><span></span><span class="nx">policy</span><span class="p">{</span>
    <span class="nx">orgList</span><span class="p">:</span> <span class="p">[]</span><span class="kt">string</span><span class="p">{</span><span class="s">&quot;org1&quot;</span><span class="p">,</span> <span class="s">&quot;org2&quot;</span><span class="p">,</span> <span class="s">&quot;org3&quot;</span><span class="p">},</span>
	<span class="nx">rule</span><span class="p">:</span> <span class="nx">protocol</span><span class="p">.</span><span class="nx">RuleMajority</span><span class="p">,</span>
<span class="p">}</span>
</pre></div>
</div>
<p>该规则下，只有 <code class="docutils literal notranslate"><span class="pre">ADMIN</span></code>身份被认可， <code class="docutils literal notranslate"><span class="pre">roleList</span></code> 默认为 <code class="docutils literal notranslate"><span class="pre">protocol.RoleAdmin</span></code> 即 <code class="docutils literal notranslate"><span class="pre">ADMIN</span></code>，此时，要求半数以上的组织参与（这里为至少有两个组织参与），并且每个组织管理员身份（<code class="docutils literal notranslate"><span class="pre">ADMIN</span></code>）的成员提供签名才会通过。</p>
<p>当然除了默认指定<code class="docutils literal notranslate"><span class="pre">ADMIN</span></code>成员，你还可以自定义<code class="docutils literal notranslate"><span class="pre">roleList</span></code>字段来指定特定身份成员，如下：</p>
<div class="highlight-go notranslate"><div class="highlight"><pre><span></span><span class="nx">policy</span><span class="p">{</span>
    <span class="nx">orgList</span><span class="p">:</span> <span class="p">[]</span><span class="kt">string</span><span class="p">{</span><span class="s">&quot;org1&quot;</span><span class="p">,</span> <span class="s">&quot;org2&quot;</span><span class="p">,</span> <span class="s">&quot;org3&quot;</span><span class="p">},</span>
    <span class="nx">roleList</span><span class="p">:</span> <span class="p">[]</span><span class="nx">protocol</span><span class="p">.</span><span class="nx">Role</span><span class="p">{</span><span class="nx">protocol</span><span class="p">.</span><span class="nx">RoleAdmin</span><span class="p">,</span> <span class="nx">protocol</span><span class="p">.</span><span class="nx">RoleClient</span><span class="p">,</span> <span class="nx">protocol</span><span class="p">.</span><span class="nx">RoleCommonNode</span><span class="p">},</span>
	<span class="nx">rule</span><span class="p">:</span> <span class="nx">protocol</span><span class="p">.</span><span class="nx">RuleMajority</span><span class="p">,</span>
<span class="p">}</span>
</pre></div>
</div>
<p>注意，每个组织只能提供一个管理员（<code class="docutils literal notranslate"><span class="pre">ADMIN</span></code>）的签名，来自同一组织的多个管理员签名只会被统计一次。并且自定义中的其他身份成员（例如<code class="docutils literal notranslate"><span class="pre">CLIENT</span></code>）的签名是无效的，不被统计的。</p>
<p>示例2：<code class="docutils literal notranslate"><span class="pre">SELF</span></code>规则下的策略详解：</p>
<div class="highlight-go notranslate"><div class="highlight"><pre><span></span><span class="nx">policy</span><span class="p">{</span>
    <span class="nx">orgList</span><span class="p">:</span> <span class="p">[]</span><span class="kt">string</span><span class="p">{</span><span class="s">&quot;org1&quot;</span><span class="p">,</span> <span class="s">&quot;org2&quot;</span><span class="p">,</span> <span class="s">&quot;org3&quot;</span><span class="p">},</span>
    <span class="nx">roleList</span><span class="p">:</span> <span class="p">[]</span><span class="nx">protocol</span><span class="p">.</span><span class="nx">Role</span><span class="p">{</span><span class="nx">protocol</span><span class="p">.</span><span class="nx">RoleAdmin</span><span class="p">,</span> <span class="nx">protocol</span><span class="p">.</span><span class="nx">RoleClient</span><span class="p">,</span> <span class="nx">protocol</span><span class="p">.</span><span class="nx">RoleCommonNode</span><span class="p">},</span>
	<span class="nx">rule</span><span class="p">:</span> <span class="nx">protocol</span><span class="p">.</span><span class="nx">RuleSelf</span><span class="p">,</span>
<span class="p">}</span>
</pre></div>
</div>
<p>该规则配置下，拥有一个所属组织的<code class="docutils literal notranslate"><span class="pre">ADMIN</span></code>成员签名即可。</p>
<p>注意，该规则下自定义配置的<code class="docutils literal notranslate"><span class="pre">orgList</span></code>和<code class="docutils literal notranslate"><span class="pre">roleList</span></code>不会生效，例如上面的配置中是不会生效的，只接受所属组织的<code class="docutils literal notranslate"><span class="pre">ADMIN</span></code>成员签名。目前，只有组织根证书、组织共识节点两项配置可以且应该使用此规则。</p>
<p>示例3：<code class="docutils literal notranslate"><span class="pre">ANY</span></code>规则下的策略详解：</p>
<div class="highlight-go notranslate"><div class="highlight"><pre><span></span><span class="nx">policy</span><span class="p">{</span>
    <span class="nx">orgList</span><span class="p">:</span> <span class="p">[]</span><span class="kt">string</span><span class="p">{</span><span class="s">&quot;org1&quot;</span><span class="p">,</span> <span class="s">&quot;org2&quot;</span><span class="p">,</span> <span class="s">&quot;org3&quot;</span><span class="p">},</span>
    <span class="nx">roleList</span><span class="p">:</span> <span class="p">[]</span><span class="nx">protocol</span><span class="p">.</span><span class="nx">Role</span><span class="p">{</span><span class="nx">protocol</span><span class="p">.</span><span class="nx">RoleAdmin</span><span class="p">,</span> <span class="nx">protocol</span><span class="p">.</span><span class="nx">RoleClient</span><span class="p">,</span> <span class="nx">protocol</span><span class="p">.</span><span class="nx">RoleCommonNode</span><span class="p">},</span>
	<span class="nx">rule</span><span class="p">:</span> <span class="nx">protocol</span><span class="p">.</span><span class="nx">RuleAny</span><span class="p">,</span>
<span class="p">}</span>
</pre></div>
</div>
<p>该规则配置下，拥有配置中的任一组织下的任一身份成员的签名（例如一个<code class="docutils literal notranslate"><span class="pre">org1</span></code>组织下的<code class="docutils literal notranslate"><span class="pre">CLIENT</span></code>身份成员的签名）就会通过。</p>
<p>示例4：<code class="docutils literal notranslate"><span class="pre">ALL</span></code>规则下的策略详解：</p>
<div class="highlight-go notranslate"><div class="highlight"><pre><span></span><span class="nx">policy</span><span class="p">{</span>
    <span class="nx">orgList</span><span class="p">:</span> <span class="p">[]</span><span class="kt">string</span><span class="p">{</span><span class="s">&quot;org1&quot;</span><span class="p">,</span> <span class="s">&quot;org2&quot;</span><span class="p">,</span> <span class="s">&quot;org3&quot;</span><span class="p">},</span>
    <span class="nx">roleList</span><span class="p">:</span> <span class="p">[]</span><span class="nx">protocol</span><span class="p">.</span><span class="nx">Role</span><span class="p">{</span><span class="nx">protocol</span><span class="p">.</span><span class="nx">RoleAdmin</span><span class="p">,</span> <span class="nx">protocol</span><span class="p">.</span><span class="nx">RoleClient</span><span class="p">,</span> <span class="nx">protocol</span><span class="p">.</span><span class="nx">RoleCommonNode</span><span class="p">}</span>
	<span class="nx">rule</span><span class="p">:</span> <span class="nx">protocol</span><span class="p">.</span><span class="nx">RuleAll</span><span class="p">,</span>
<span class="p">}</span>
</pre></div>
</div>
<p>该规则配置下，要求有所有配置组织（这里是<code class="docutils literal notranslate"><span class="pre">org1</span></code>、<code class="docutils literal notranslate"><span class="pre">org2</span></code>、<code class="docutils literal notranslate"><span class="pre">org3</span></code>）下任一成员身份（这里是三个组织下的<code class="docutils literal notranslate"><span class="pre">ADMIN</span></code>或者<code class="docutils literal notranslate"><span class="pre">CLIENT</span></code>或者<code class="docutils literal notranslate"><span class="pre">COMMON</span></code>身份成员）的签名才能通过，所有组织都要参与。</p>
<p>示例5：<code class="docutils literal notranslate"><span class="pre">字符串整数</span></code>规则下的策略详解：</p>
<div class="highlight-go notranslate"><div class="highlight"><pre><span></span><span class="nx">policy</span><span class="p">{</span>
    <span class="nx">orgList</span><span class="p">:</span> <span class="p">[]</span><span class="kt">string</span><span class="p">{</span><span class="s">&quot;org1&quot;</span><span class="p">,</span> <span class="s">&quot;org2&quot;</span><span class="p">,</span> <span class="s">&quot;org3&quot;</span><span class="p">},</span>
    <span class="nx">roleList</span><span class="p">:</span> <span class="p">[]</span><span class="nx">protocol</span><span class="p">.</span><span class="nx">Role</span><span class="p">{</span><span class="nx">protocol</span><span class="p">.</span><span class="nx">RoleAdmin</span><span class="p">,</span> <span class="nx">protocol</span><span class="p">.</span><span class="nx">RoleClient</span><span class="p">,</span> <span class="nx">protocol</span><span class="p">.</span><span class="nx">RoleCommonNode</span><span class="p">},</span>
	<span class="nx">rule</span><span class="p">:</span> <span class="s">&quot;2&quot;</span><span class="p">,</span>
<span class="p">}</span>
</pre></div>
</div>
<p>该规则配置下：要求拥有不低于<code class="docutils literal notranslate"><span class="pre">2</span></code>个组织下的任一配置成员身份的签名才能通过。</p>
<p>该规则下<code class="docutils literal notranslate"><span class="pre">orgList</span></code>和<code class="docutils literal notranslate"><span class="pre">roleList</span></code>配置可以为空，为空时分别代表链上所有组织和组织下所有身份都可以参与签名。</p>
<p>示例6：<code class="docutils literal notranslate"><span class="pre">字符串分数</span></code>规则下的策略详解：</p>
<div class="highlight-go notranslate"><div class="highlight"><pre><span></span><span class="nx">policy</span><span class="p">{</span>
    <span class="nx">orgList</span><span class="p">:</span> <span class="p">[]</span><span class="kt">string</span><span class="p">{</span><span class="s">&quot;org1&quot;</span><span class="p">,</span> <span class="s">&quot;org2&quot;</span><span class="p">,</span> <span class="s">&quot;org3&quot;</span><span class="p">},</span>
    <span class="nx">roleList</span><span class="p">:</span> <span class="p">[]</span><span class="nx">protocol</span><span class="p">.</span><span class="nx">Role</span><span class="p">{</span><span class="nx">protocol</span><span class="p">.</span><span class="nx">RoleAdmin</span><span class="p">,</span> <span class="nx">protocol</span><span class="p">.</span><span class="nx">RoleClient</span><span class="p">,</span> <span class="nx">protocol</span><span class="p">.</span><span class="nx">RoleCommonNode</span><span class="p">},</span>
	<span class="nx">rule</span><span class="p">:</span> <span class="s">&quot;1/3&quot;</span><span class="p">,</span>
<span class="p">}</span>
</pre></div>
</div>
<p>该规则配置下：要求大于等于配置比例（这里是<code class="docutils literal notranslate"><span class="pre">1/3</span></code>）的组织下的任一配置身份成员进行签名才能通过。</p>
<p>用户可以自定义配置<code class="docutils literal notranslate"><span class="pre">[0,1]</span></code>区间内的任意数以字符串分数的形式表示，例如这里的<code class="docutils literal notranslate"><span class="pre">&quot;1/3&quot;</span></code>。</p>
</div>
</div>
<div class="section" id="id54">
<h5>身份-权限策略对<a class="headerlink" href="#id54" title="Permalink to this headline">¶</a></h5>
<p><strong>principal</strong> （身份-权限策略对）结构如下：</p>
<div class="highlight-go notranslate"><div class="highlight"><pre><span></span><span class="kd">type</span> <span class="nx">principal</span> <span class="kd">struct</span> <span class="p">{</span>
	<span class="nx">resourceName</span> <span class="kt">string</span>
	<span class="nx">endorsement</span>  <span class="p">[]</span><span class="o">*</span><span class="nx">common</span><span class="p">.</span><span class="nx">EndorsementEntry</span>
	<span class="nx">message</span>      <span class="p">[]</span><span class="kt">byte</span>

	<span class="nx">targetOrg</span> <span class="kt">string</span>
<span class="p">}</span>
</pre></div>
</div>
<p>字段说明：</p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">resourceName</span></code>：被调用资源的ID，当前资源包括配置项的增、删、查、该，链上数据查询、写入等。</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">endorsement</span></code>：背书列表，即（签名者, 签名）对的列表。</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">message</span></code>：请求消息的主题。</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">targetOrg</span></code>：可选字段，在 resourceId 字段所指示的资源是属于某个特定组织时被使用到。</p></li>
</ul>
<p><code class="docutils literal notranslate"><span class="pre">resourceName</span></code>预定义了以下几种类型：</p>
<div class="highlight-go notranslate"><div class="highlight"><pre><span></span>	<span class="c1">// fine-grained resource id for different policies</span>
	<span class="nx">ResourceNameUnknown</span>          <span class="p">=</span> <span class="s">&quot;UNKNOWN&quot;</span>
	<span class="nx">ResourceNameReadData</span>         <span class="p">=</span> <span class="s">&quot;READ&quot;</span>
	<span class="nx">ResourceNameWriteData</span>        <span class="p">=</span> <span class="s">&quot;WRITE&quot;</span>
	<span class="nx">ResourceNameP2p</span>              <span class="p">=</span> <span class="s">&quot;P2P&quot;</span>
	<span class="nx">ResourceNameConsensusNode</span>    <span class="p">=</span> <span class="s">&quot;CONSENSUS&quot;</span>
	<span class="nx">ResourceNameAdmin</span>            <span class="p">=</span> <span class="s">&quot;ADMIN&quot;</span>
	<span class="nx">ResourceNameUpdateConfig</span>     <span class="p">=</span> <span class="s">&quot;CONFIG&quot;</span>
	<span class="nx">ResourceNameUpdateSelfConfig</span> <span class="p">=</span> <span class="s">&quot;SELF_CONFIG&quot;</span>
	<span class="nx">ResourceNameAllTest</span>          <span class="p">=</span> <span class="s">&quot;ALL_TEST&quot;</span>

	<span class="nx">ResourceNameTxQuery</span>    <span class="p">=</span> <span class="s">&quot;query&quot;</span>
	<span class="nx">ResourceNameTxTransact</span> <span class="p">=</span> <span class="s">&quot;transaction&quot;</span>
</pre></div>
</div>
</div>
<div class="section" id="accesscontrol">
<h5>AccessControl<a class="headerlink" href="#accesscontrol" title="Permalink to this headline">¶</a></h5>
<p><strong>AccessControl</strong> 定义了权限管理对外的接口：</p>
<div class="highlight-go notranslate"><div class="highlight"><pre><span></span><span class="c1">// AccessControlProvider manages policies and principals.</span>
<span class="kd">type</span> <span class="nx">AccessControlProvider</span> <span class="kd">interface</span> <span class="p">{</span>
	<span class="nx">MemberDeserializer</span>

	<span class="c1">// GetHashAlg return hash algorithm the access control provider uses</span>
	<span class="nx">GetHashAlg</span><span class="p">()</span> <span class="kt">string</span>

	<span class="c1">// ValidateResourcePolicy checks whether the given resource policy is valid</span>
	<span class="nx">ValidateResourcePolicy</span><span class="p">(</span><span class="nx">resourcePolicy</span> <span class="o">*</span><span class="nx">config</span><span class="p">.</span><span class="nx">ResourcePolicy</span><span class="p">)</span> <span class="kt">bool</span>

	<span class="c1">// LookUpResourceNameByTxType returns resource name corresponding to the tx type</span>
	<span class="nx">LookUpResourceNameByTxType</span><span class="p">(</span><span class="nx">txType</span> <span class="nx">common</span><span class="p">.</span><span class="nx">TxType</span><span class="p">)</span> <span class="p">(</span><span class="kt">string</span><span class="p">,</span> <span class="kt">error</span><span class="p">)</span>

	<span class="c1">// CreatePrincipal creates a principal for one time authentication</span>
	<span class="nx">CreatePrincipal</span><span class="p">(</span><span class="nx">resourceName</span> <span class="kt">string</span><span class="p">,</span> <span class="nx">endorsements</span> <span class="p">[]</span><span class="o">*</span><span class="nx">common</span><span class="p">.</span><span class="nx">EndorsementEntry</span><span class="p">,</span> <span class="nx">message</span> <span class="p">[]</span><span class="kt">byte</span><span class="p">)</span> <span class="p">(</span><span class="nx">Principal</span><span class="p">,</span> <span class="kt">error</span><span class="p">)</span>

	<span class="c1">// CreatePrincipalForTargetOrg creates a principal for &quot;SELF&quot; type policy,</span>
	<span class="c1">// which needs to convert SELF to a sepecific organization id in one authentication</span>
	<span class="nx">CreatePrincipalForTargetOrg</span><span class="p">(</span><span class="nx">resourceName</span> <span class="kt">string</span><span class="p">,</span> <span class="nx">endorsements</span> <span class="p">[]</span><span class="o">*</span><span class="nx">common</span><span class="p">.</span><span class="nx">EndorsementEntry</span><span class="p">,</span> <span class="nx">message</span> <span class="p">[]</span><span class="kt">byte</span><span class="p">,</span> <span class="nx">targetOrgId</span> <span class="kt">string</span><span class="p">)</span> <span class="p">(</span><span class="nx">Principal</span><span class="p">,</span> <span class="kt">error</span><span class="p">)</span>

	<span class="c1">// GetValidEndorsements filters all endorsement entries and returns all valid ones</span>
	<span class="nx">GetValidEndorsements</span><span class="p">(</span><span class="nx">principal</span> <span class="nx">Principal</span><span class="p">)</span> <span class="p">([]</span><span class="o">*</span><span class="nx">common</span><span class="p">.</span><span class="nx">EndorsementEntry</span><span class="p">,</span> <span class="kt">error</span><span class="p">)</span>

	<span class="c1">// VerifyPrincipal verifies if the policy for the resource is met</span>
	<span class="nx">VerifyPrincipal</span><span class="p">(</span><span class="nx">principal</span> <span class="nx">Principal</span><span class="p">)</span> <span class="p">(</span><span class="kt">bool</span><span class="p">,</span> <span class="kt">error</span><span class="p">)</span>

	<span class="c1">// ValidateCRL validates whether the CRL is issued by a trusted CA</span>
	<span class="nx">ValidateCRL</span><span class="p">(</span><span class="nx">crl</span> <span class="p">[]</span><span class="kt">byte</span><span class="p">)</span> <span class="p">([]</span><span class="o">*</span><span class="nx">pkix</span><span class="p">.</span><span class="nx">CertificateList</span><span class="p">,</span> <span class="kt">error</span><span class="p">)</span>

	<span class="c1">// IsCertRevoked verify whether cert chain is revoked by a trusted CA.</span>
	<span class="nx">IsCertRevoked</span><span class="p">(</span><span class="nx">certChain</span> <span class="p">[]</span><span class="o">*</span><span class="nx">x509</span><span class="p">.</span><span class="nx">Certificate</span><span class="p">)</span> <span class="kt">bool</span>

	<span class="c1">// GetLocalOrgId returns local organization id</span>
	<span class="nx">GetLocalOrgId</span><span class="p">()</span> <span class="kt">string</span>

	<span class="c1">// GetLocalSigningMember returns local SigningMember</span>
	<span class="nx">GetLocalSigningMember</span><span class="p">()</span> <span class="nx">SigningMember</span>

	<span class="c1">// NewMemberFromCertPem creates a member from cert pem</span>
	<span class="nx">NewMemberFromCertPem</span><span class="p">(</span><span class="nx">orgId</span><span class="p">,</span> <span class="nx">certPEM</span> <span class="kt">string</span><span class="p">)</span> <span class="p">(</span><span class="nx">Member</span><span class="p">,</span> <span class="kt">error</span><span class="p">)</span>

	<span class="c1">// NewMemberFromProto creates a member from SerializedMember</span>
	<span class="nx">NewMemberFromProto</span><span class="p">(</span><span class="nx">serializedMember</span> <span class="o">*</span><span class="nx">pbac</span><span class="p">.</span><span class="nx">SerializedMember</span><span class="p">)</span> <span class="p">(</span><span class="nx">Member</span><span class="p">,</span> <span class="kt">error</span><span class="p">)</span>

	<span class="c1">// NewSigningMemberFromCertFile creates a signing member from private key and cert files</span>
	<span class="nx">NewSigningMemberFromCertFile</span><span class="p">(</span><span class="nx">orgId</span><span class="p">,</span> <span class="nx">prvKeyFile</span><span class="p">,</span> <span class="nx">password</span><span class="p">,</span> <span class="nx">certFile</span> <span class="kt">string</span><span class="p">)</span> <span class="p">(</span><span class="nx">SigningMember</span><span class="p">,</span> <span class="kt">error</span><span class="p">)</span>

	<span class="c1">// NewSigningMember creates a signing member from existing member</span>
	<span class="nx">NewSigningMember</span><span class="p">(</span><span class="nx">member</span> <span class="nx">Member</span><span class="p">,</span> <span class="nx">privateKeyPem</span><span class="p">,</span> <span class="nx">password</span> <span class="kt">string</span><span class="p">)</span> <span class="p">(</span><span class="nx">SigningMember</span><span class="p">,</span> <span class="kt">error</span><span class="p">)</span>
<span class="p">}</span>

<span class="c1">// MemberDeserializer interface for members</span>
<span class="kd">type</span> <span class="nx">MemberDeserializer</span> <span class="kd">interface</span> <span class="p">{</span>
	<span class="c1">// DeserializeMember converts bytes to Member</span>
	<span class="nx">DeserializeMember</span><span class="p">(</span><span class="nx">serializedMember</span> <span class="p">[]</span><span class="kt">byte</span><span class="p">)</span> <span class="p">(</span><span class="nx">Member</span><span class="p">,</span> <span class="kt">error</span><span class="p">)</span>
<span class="p">}</span>
</pre></div>
</div>
<p>权限管理模块的核心接口是 <code class="docutils literal notranslate"><span class="pre">NewPolicy()</span></code>、<code class="docutils literal notranslate"><span class="pre">NewSelfPolicy()</span></code>、<code class="docutils literal notranslate"><span class="pre">VerifyPolicy()</span></code>.</p>
<p>前两个接口用于根据请求者身份和所请求的资源构建一个被验证的身份身份-策略对，后一个用于验证这个身份-策略后</p>
</div>
</div>
<div class="section" id="id55">
<h4>接口使用说明<a class="headerlink" href="#id55" title="Permalink to this headline">¶</a></h4>
<div class="section" id="id56">
<h5>验证权限<a class="headerlink" href="#id56" title="Permalink to this headline">¶</a></h5>
<p>首先，构建身份策略 (Policy) 用于判断某一组签名者是否满足目标资源的权限规则：</p>
<div class="highlight-go notranslate"><div class="highlight"><pre><span></span><span class="nx">principle</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">ac</span><span class="p">.</span><span class="nx">CreatePrincipal</span><span class="p">(</span><span class="nx">Target_Resource_ID</span><span class="p">,</span> <span class="nx">Endorsement_List</span><span class="p">,</span> <span class="nx">Request_Message</span><span class="p">)</span>
</pre></div>
</div>
<p>若资源属于特定组织，则用以下方式：</p>
<div class="highlight-go notranslate"><div class="highlight"><pre><span></span><span class="nx">principle</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">ac</span><span class="p">.</span><span class="nx">CreatePrincipalForTargetOrg</span><span class="p">(</span><span class="nx">Target_Resource_ID</span><span class="p">,</span> <span class="nx">Endorsement_List</span><span class="p">,</span> <span class="nx">Request_Message</span><span class="p">,</span> <span class="nx">Target_Organization</span><span class="p">)</span>
</pre></div>
</div>
<p>最后调用以下接口来验证身份策略与权限规则是否匹配：</p>
<div class="highlight-go notranslate"><div class="highlight"><pre><span></span><span class="nx">ok</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">ac</span><span class="p">.</span><span class="nx">VerifyPrincipal</span><span class="p">(</span><span class="nx">principle</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="section" id="id57">
<h5>新增资源<a class="headerlink" href="#id57" title="Permalink to this headline">¶</a></h5>
<p>首选，为新资源添加一个ID。(可参考系统合约 CREATE_USER_CONTRACT 创建用户合约接口，他的资源ID是 TxType_CREATE_USER_CONTRACT)。</p>
<p>然后，把新资源ID添加到默认权限配置列表中，为他赋予一个默认外层权限。</p>
<div class="highlight-go notranslate"><div class="highlight"><pre><span></span><span class="kd">var</span> <span class="nx">txTypeToResourceNameMap</span> <span class="p">=</span> <span class="kd">map</span><span class="p">[</span><span class="nx">pb</span><span class="p">.</span><span class="nx">TxType</span><span class="p">]</span><span class="nx">protocol</span><span class="p">.</span><span class="nx">ResourceId</span><span class="p">{</span>
	<span class="nx">pb</span><span class="p">.</span><span class="nx">TxType_QUERY_USER_CONTRACT</span><span class="p">:</span>   <span class="nx">protocol</span><span class="p">.</span><span class="nx">RESOURCE_CATEGORY_READ_DATA</span><span class="p">,</span>
	<span class="nx">pb</span><span class="p">.</span><span class="nx">TxType_QUERY_SYSTEM_CONTRACT</span><span class="p">:</span> <span class="nx">protocol</span><span class="p">.</span><span class="nx">RESOURCE_CATEGORY_READ_DATA</span><span class="p">,</span>
	<span class="nx">pb</span><span class="p">.</span><span class="nx">TxType_INVOKE_USER_CONTRACT</span><span class="p">:</span>  <span class="nx">protocol</span><span class="p">.</span><span class="nx">RESOURCE_CATEGORY_WRITE_DATA</span><span class="p">,</span>
	<span class="nx">pb</span><span class="p">.</span><span class="nx">TxType_UPDATE_CHAIN_CONFIG</span><span class="p">:</span>   <span class="nx">protocol</span><span class="p">.</span><span class="nx">RESOURCE_CATEGORY_WRITE_DATA</span><span class="p">,</span>
	<span class="nx">pb</span><span class="p">.</span><span class="nx">TxType_CREATE_USER_CONTRACT</span><span class="p">:</span>  <span class="nx">protocol</span><span class="p">.</span><span class="nx">RESOURCE_CATEGORY_WRITE_DATA</span><span class="p">,</span>
	<span class="nx">pb</span><span class="p">.</span><span class="nx">TxType_UPGRADE_USER_CONTRACT</span><span class="p">:</span> <span class="nx">protocol</span><span class="p">.</span><span class="nx">RESOURCE_CATEGORY_WRITE_DATA</span><span class="p">,</span>
	<span class="nx">pb</span><span class="p">.</span><span class="nx">TxType_SUBSCRIBE_BLOCK_INFO</span><span class="p">:</span>  <span class="nx">protocol</span><span class="p">.</span><span class="nx">RESOURCE_CATEGORY_READ_DATA</span><span class="p">,</span>
	<span class="nx">pb</span><span class="p">.</span><span class="nx">TxType_SUBSCRIBE_TX_INFO</span><span class="p">:</span>     <span class="nx">protocol</span><span class="p">.</span><span class="nx">RESOURCE_CATEGORY_READ_DATA</span><span class="p">,</span>
	<span class="nx">pb</span><span class="p">.</span><span class="nx">TxType_SYSTEM_CONTRACT</span><span class="p">:</span>       <span class="nx">protocol</span><span class="p">.</span><span class="nx">RESOURCE_CATEGORY_WRITE_DATA</span><span class="p">,</span>
<span class="p">}</span>
</pre></div>
</div>
<p>这个 map 被定义在 chainmaker-go/module/access/access_control.go 中. 为新资源ID配置一个下表中的默认权限。</p>
<div class="highlight-go notranslate"><div class="highlight"><pre><span></span><span class="kd">const</span> <span class="p">(</span>
	<span class="nx">RESOURCE_UNKNOWN</span> <span class="nx">ResourceId</span> <span class="p">=</span> <span class="s">&quot;UNKNOWN&quot;</span>

	<span class="nx">RESOURCE_CATEGORY_READ_DATA</span>  <span class="nx">ResourceId</span> <span class="p">=</span> <span class="s">&quot;READ&quot;</span>
	<span class="nx">RESOURCE_CATEGORY_WRITE_DATA</span> <span class="nx">ResourceId</span> <span class="p">=</span> <span class="s">&quot;WRITE&quot;</span>

	<span class="nx">RESOURCE_CATEGORY_P2P</span>            <span class="nx">ResourceId</span> <span class="p">=</span> <span class="s">&quot;P2P&quot;</span>
	<span class="nx">RESOURCE_CATEGORY_CONSENSUS_NODE</span> <span class="nx">ResourceId</span> <span class="p">=</span> <span class="s">&quot;CONSENSUS&quot;</span>
	<span class="nx">RESOURCE_CATEGORY_ADMIN</span>          <span class="nx">ResourceId</span> <span class="p">=</span> <span class="s">&quot;ADMIN&quot;</span>

	<span class="nx">RESOURCE_CATEGORY_UPDATE_CONFIG</span>      <span class="nx">ResourceId</span> <span class="p">=</span> <span class="s">&quot;CONFIG&quot;</span>
	<span class="nx">RESOURCE_CATEGORY_UPDATE_SELF_CONFIG</span> <span class="nx">ResourceId</span> <span class="p">=</span> <span class="s">&quot;SELF_CONFIG&quot;</span>

	<span class="c1">// fine-grained source id for different access policies</span>
	<span class="nx">RESOURCE_TX_QUERY</span>     <span class="nx">ResourceId</span> <span class="p">=</span> <span class="s">&quot;query&quot;</span>
	<span class="nx">RESOURCE_TX_TRANSACT</span>  <span class="nx">ResourceId</span> <span class="p">=</span> <span class="s">&quot;transaction&quot;</span>
	<span class="nx">RESOURCE_CATEGORY_ALL</span> <span class="nx">ResourceId</span> <span class="p">=</span> <span class="s">&quot;ALL_TEST&quot;</span>
<span class="p">)</span>
</pre></div>
</div>
<p>如果需要配置自定义权限，可以在链配置中设置 (可参考 bc1.yml 文件的 permissions 部分)。</p>
</div>
<div class="section" id="id58">
<h5>注意<a class="headerlink" href="#id58" title="Permalink to this headline">¶</a></h5>
<p>当新增一个系统合约接口时，必须要为该合约接口配置一个默认的权限，或者在链配置里为他添加一个配置项，否则将无法调用这个合约接口。添加链配置可以用 UPDATE_CHAIN_CONFIG 合约来实现。</p>
</div>
</div>
</div>
<div class="section" id="id59">
<h3>配置模块<a class="headerlink" href="#id59" title="Permalink to this headline">¶</a></h3>
<div class="section" id="id60">
<h4><strong>本地配置</strong><a class="headerlink" href="#id60" title="Permalink to this headline">¶</a></h4>
<p>本地配置项都包含在chainmaker.yml中，具体配置如下：</p>
<div class="highlight-yaml notranslate"><div class="highlight"><pre><span></span><span class="c1"># 链配置</span>
<span class="nt">blockchain</span><span class="p">:</span>
  <span class="p p-Indicator">-</span> <span class="nt">chainId</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">chain1</span> <span class="c1"># 链ID</span>
    <span class="nt">genesis</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">chainconfig/bc1.yml</span> <span class="c1"># 链配置文件</span>
<span class="c1">#  - chainId: chain2</span>
<span class="c1">#    genesis: chainconfig/bc2.yml</span>
<span class="c1">#  - chainId: chain3</span>
<span class="c1">#    genesis: chainconfig/bc3.yml</span>
<span class="c1">#  - chainId: chain4</span>
<span class="c1">#    genesis: chainconfig/bc4.yml</span>

<span class="c1"># 节点配置</span>
<span class="nt">node</span><span class="p">:</span>
  <span class="nt">type</span><span class="p">:</span>              <span class="l l-Scalar l-Scalar-Plain">full</span> <span class="c1"># 节点类型：full、spv</span>
  <span class="nt">org_id</span><span class="p">:</span>            <span class="l l-Scalar l-Scalar-Plain">wx-org1.chainmaker.org</span> <span class="c1"># 所属组织ID</span>
  <span class="nt">priv_key_file</span><span class="p">:</span>     <span class="l l-Scalar l-Scalar-Plain">./certs/node/consensus1/consensus1.sign.key</span> <span class="c1"># 签名私钥</span>
  <span class="nt">cert_file</span><span class="p">:</span>         <span class="l l-Scalar l-Scalar-Plain">./certs/node/consensus1/consensus1.sign.crt</span> <span class="c1"># 签名证书</span>
  <span class="nt">signer_cache_size</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">1000</span>
  <span class="nt">cert_cache_size</span><span class="p">:</span>   <span class="l l-Scalar l-Scalar-Plain">1000</span>

<span class="c1"># 网络配置</span>
<span class="nt">net</span><span class="p">:</span>
  <span class="nt">provider</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">LibP2P</span> <span class="c1"># 网络类型，目前只支持libp2p</span>
  <span class="nt">listen_addr</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">/ip4/0.0.0.0/tcp/11301</span> <span class="c1"># 网络本地监听地址，包含IP和端口号，IP若为0.0.0.0则本地所有IP都会绑定监听</span>
  <span class="nt">peer_stream_pool_size</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">100</span>  <span class="c1"># 每个节点连接stream池大小上限，不配默认为100</span>
  <span class="nt">max_peer_count_allow</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">10</span> <span class="c1"># 允许与本节点建立链接的节点总数量，不配默认为20</span>
  <span class="nt">peer_elimination_strategy</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">3</span> <span class="c1"># 节点链接淘汰策略，1 Random, 2 FIFO, 3 LIFO。不配默认为3</span>
  <span class="nt">seeds</span><span class="p">:</span>  <span class="c1"># 种子节点地址列表，用于节点发现，可选项。链配置中所有共识节点地址都会作为种子节点。</span>
    <span class="p p-Indicator">-</span> <span class="s">&quot;/ip4/127.0.0.1/tcp/6666/p2p/QmQZn3pZCcuEf34FSvucqkvVJEvfzpNjQTk17HS6CYMR35&quot;</span>
  <span class="nt">tls</span><span class="p">:</span> <span class="c1"># TLS认证配置</span>
    <span class="nt">enabled</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">true</span> <span class="c1"># TLS认证开关，现阶段必须设置为true</span>
    <span class="nt">priv_key_file</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">./certs/node/consensus1/consensus1.tls.key</span> <span class="c1"># TLS私钥</span>
    <span class="nt">cert_file</span><span class="p">:</span>     <span class="l l-Scalar l-Scalar-Plain">./certs/node/consensus1/consensus1.tls.crt</span> <span class="c1"># TLS证书</span>

<span class="c1"># 交易池配置</span>
<span class="nt">txpool</span><span class="p">:</span>
  <span class="nt">max_txpool_size</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">5120</span> <span class="c1"># 普通交易池上限</span>
  <span class="nt">max_config_txpool_size</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">10</span> <span class="c1"># config交易池的上限</span>
  <span class="nt">full_notify_again_time</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">30</span> <span class="c1"># 交易池溢出后，再次通知打包的时间间隔(秒)</span>

<span class="c1"># RPC服务配置</span>
<span class="nt">rpc</span><span class="p">:</span>
  <span class="nt">provider</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">grpc</span> <span class="c1"># 服务类型，目前只支持gRPC</span>
  <span class="nt">port</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">12301</span> <span class="c1"># 服务监听端口</span>
  <span class="nt">tls</span><span class="p">:</span>
    <span class="c1"># TLS模式:</span>
    <span class="c1">#   disable - 不启用TLS</span>
    <span class="c1">#   oneway  - 单向认证</span>
    <span class="c1">#   twoway  - 双向认证</span>
    <span class="c1">#mode: disable</span>
    <span class="c1">#mode: oneway</span>
    <span class="nt">mode</span><span class="p">:</span>           <span class="l l-Scalar l-Scalar-Plain">twoway</span> 
    <span class="nt">priv_key_file</span><span class="p">:</span>  <span class="l l-Scalar l-Scalar-Plain">./certs/node/consensus1/consensus1.tls.key</span> <span class="c1"># TLS私钥</span>
    <span class="nt">cert_file</span><span class="p">:</span>      <span class="l l-Scalar l-Scalar-Plain">./certs/node/consensus1/consensus1.tls.crt</span> <span class="c1"># TLS证书</span>

<span class="c1"># 检测相关配置</span>
<span class="nt">monitor</span><span class="p">:</span>
  <span class="nt">enabled</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">false</span> <span class="c1"># 检测开关</span>
  <span class="nt">port</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">14321</span> <span class="c1"># 检测服务监听端口</span>

<span class="c1"># pprof功能配置</span>
<span class="nt">pprof</span><span class="p">:</span>
  <span class="nt">enabled</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">false</span> <span class="c1"># 开关</span>
  <span class="nt">port</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">24321</span> <span class="c1"># 性能分析监听端口</span>

<span class="c1"># 存储配置</span>
<span class="nt">storage</span><span class="p">:</span>
  <span class="nt">provider</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">leveldb</span> <span class="c1"># 数据库类型</span>
  <span class="nt">store_path</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">../data/ledgerData</span> <span class="c1"># 数据库所在路径</span>

<span class="c1"># debug 相关配置</span>
<span class="nt">debug</span><span class="p">:</span>
  <span class="nt">is_cli_open</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">true</span> <span class="c1"># 是否开启CLI功能</span>
  <span class="nt">is_http_open</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">false</span> <span class="c1"># 是否开启http</span>
  <span class="l l-Scalar l-Scalar-Plain">...</span>
</pre></div>
</div>
</div>
<div class="section" id="id61">
<h4><strong>链配置</strong><a class="headerlink" href="#id61" title="Permalink to this headline">¶</a></h4>
<p>链配置是作为链启动时创建创世区块的依据，所以要求每条链每个节点的链配置文件都必须保持一致。
具体链配置项如下：</p>
<div class="highlight-yaml notranslate"><div class="highlight"><pre><span></span><span class="nt">chain_id</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">chain1</span>        <span class="c1"># 链标识，链ID</span>
<span class="nt">version</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">v1.0.0</span>         <span class="c1"># 链版本</span>
<span class="nt">sequence</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">1</span>             <span class="c1"># 配置版本</span>
<span class="nt">auth_type</span><span class="p">:</span> <span class="s">&quot;identity&quot;</span>   <span class="c1"># 认证类型，供身份管理模块验证使用</span>

<span class="nt">crypto</span><span class="p">:</span>
  <span class="nt">hash</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">SHA256</span> <span class="c1"># 加密算法</span>

<span class="c1"># 交易、区块相关配置</span>
<span class="nt">block</span><span class="p">:</span>
  <span class="nt">tx_timestamp_verify</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">true</span> <span class="c1"># 是否需要开启交易时间戳校验</span>
  <span class="nt">tx_timeout</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">600</span>  <span class="c1"># 交易时间戳的过期时间(秒)</span>
  <span class="nt">block_tx_capacity</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">100</span>  <span class="c1"># 区块中最大交易数</span>
  <span class="nt">block_size</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">10</span>  <span class="c1"># 区块最大限制，单位MB</span>
  <span class="nt">block_interval</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">2000</span> <span class="c1"># 出块间隔，单位:ms</span>

<span class="c1"># core模块</span>
<span class="nt">core</span><span class="p">:</span>
  <span class="nt">tx_scheduler_timeout</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">10</span> <span class="c1">#  [0, 60] 交易调度器从交易池拿到交易后, 进行调度的时间</span>
  <span class="nt">tx_scheduler_validate_timeout</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">10</span> <span class="c1"># [0, 60] 交易调度器从区块中拿到交易后, 进行验证的超时时间</span>

<span class="c1">#共识配置</span>
<span class="nt">consensus</span><span class="p">:</span>
  <span class="c1"># 共识类型(0-POW,1-PBFT,2-TENDERMINT,3-TBFT,4-HOTSTUFF,5-RAFT,6-SOLO,7-MBFT)</span>
  <span class="nt">type</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">3</span>
  <span class="c1"># 共识节点列表，组织必须出现在trust_roots的org_id中，每个组织可配置多个共识节点，节点地址采用libp2p格式</span>
  <span class="nt">nodes</span><span class="p">:</span>
    <span class="p p-Indicator">-</span> <span class="nt">org_id</span><span class="p">:</span> <span class="s">&quot;wx-org1.chainmaker.org&quot;</span> <span class="c1"># 组织ID，该值与下方trust_roots对应，需要保证在trust_roots中配有该组织的根证书</span>
      <span class="nt">address</span><span class="p">:</span> <span class="c1"># 该组织认证下的共识节点地址</span>
        <span class="p p-Indicator">-</span> <span class="s">&quot;/ip4/127.0.0.1/tcp/11301/p2p/QmcQHCuAXaFkbcsPUj7e37hXXfZ9DdN7bozseo5oX4qiC4&quot;</span>
    <span class="p p-Indicator">-</span> <span class="nt">org_id</span><span class="p">:</span> <span class="s">&quot;wx-org2.chainmaker.org&quot;</span>
      <span class="nt">address</span><span class="p">:</span>
        <span class="p p-Indicator">-</span> <span class="s">&quot;/ip4/127.0.0.1/tcp/11302/p2p/QmeyNRs2DwWjcHTpcVHoUSaDAAif4VQZ2wQDQAUNDP33gH&quot;</span>
    <span class="p p-Indicator">-</span> <span class="nt">org_id</span><span class="p">:</span> <span class="s">&quot;wx-org3.chainmaker.org&quot;</span>
      <span class="nt">address</span><span class="p">:</span>
        <span class="p p-Indicator">-</span> <span class="s">&quot;/ip4/127.0.0.1/tcp/11303/p2p/QmXf6mnQDBR9aHauRmViKzSuZgpumkn7x6rNxw1oqqRr45&quot;</span>
    <span class="p p-Indicator">-</span> <span class="nt">org_id</span><span class="p">:</span> <span class="s">&quot;wx-org4.chainmaker.org&quot;</span>
      <span class="nt">address</span><span class="p">:</span>
        <span class="p p-Indicator">-</span> <span class="s">&quot;/ip4/127.0.0.1/tcp/11304/p2p/QmRRWXJpAVdhFsFtd9ah5F4LDQWFFBDVKpECAF8hssqj6H&quot;</span>
  <span class="nt">ext_config</span><span class="p">:</span> <span class="c1"># 扩展字段，记录难度、奖励等其他类共识算法配置</span>
    <span class="p p-Indicator">-</span> <span class="nt">key</span><span class="p">:</span> <span class="s">&quot;&quot;</span>
      <span class="nt">value</span><span class="p">:</span> <span class="s">&quot;&quot;</span>

<span class="c1"># 信任组织和根证书</span>
<span class="nt">trust_roots</span><span class="p">:</span>
  <span class="p p-Indicator">-</span> <span class="nt">org_id</span><span class="p">:</span> <span class="s">&quot;wx-org1.chainmaker.org&quot;</span> <span class="c1"># 信任组织ID</span>
    <span class="nt">root</span><span class="p">:</span> <span class="s">&quot;./certs/ca/wx-org1.chainmaker.org/ca.crt&quot;</span> <span class="c1"># 信任组织根证书</span>
  <span class="p p-Indicator">-</span> <span class="nt">org_id</span><span class="p">:</span> <span class="s">&quot;wx-org2.chainmaker.org&quot;</span>
    <span class="nt">root</span><span class="p">:</span> <span class="s">&quot;./certs/ca/wx-org2.chainmaker.org/ca.crt&quot;</span>
  <span class="p p-Indicator">-</span> <span class="nt">org_id</span><span class="p">:</span> <span class="s">&quot;wx-org3.chainmaker.org&quot;</span>
    <span class="nt">root</span><span class="p">:</span> <span class="s">&quot;./certs/ca/wx-org3.chainmaker.org/ca.crt&quot;</span>
  <span class="p p-Indicator">-</span> <span class="nt">org_id</span><span class="p">:</span> <span class="s">&quot;wx-org4.chainmaker.org&quot;</span>
    <span class="nt">root</span><span class="p">:</span> <span class="s">&quot;./certs/ca/wx-org4.chainmaker.org/ca.crt&quot;</span>

<span class="c1"># 权限配置</span>
<span class="nt">permissions</span><span class="p">:</span>
  <span class="p p-Indicator">-</span> <span class="nt">resource_name</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">NODE_ADDR_UPDATE</span>
    <span class="nt">principle</span><span class="p">:</span>
      <span class="nt">rule</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">SELF</span> <span class="c1"># 规则（ANY，MAJORITY...，全部大写，自动转大写）</span>
      <span class="nt">org_list</span><span class="p">:</span> <span class="c1"># 组织名称（组织名称，区分大小写）</span>
      <span class="nt">role_list</span><span class="p">:</span> <span class="c1"># 角色名称（role，全部小写，自动转小写）</span>
        <span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">admin</span>
  <span class="p p-Indicator">-</span> <span class="nt">resource_name</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">TRUST_ROOT_UPDATE</span>
    <span class="nt">principle</span><span class="p">:</span>
      <span class="nt">rule</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">SELF</span> <span class="c1"># 规则（ANY，MAJORITY...，全部大写）</span>
      <span class="nt">org_list</span><span class="p">:</span> <span class="c1"># 组织名称（组织名称）</span>
      <span class="nt">role_list</span><span class="p">:</span> <span class="c1"># 角色名称（role，全部小写）</span>
        <span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">admin</span>
  <span class="p p-Indicator">-</span> <span class="nt">resource_name</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">CONSENSUS_EXT_DELETE</span>
    <span class="nt">principle</span><span class="p">:</span>
      <span class="nt">rule</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">MAJORITY</span>
      <span class="nt">org_list</span><span class="p">:</span>
      <span class="nt">role_list</span><span class="p">:</span>
        <span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">admin</span>
  <span class="p p-Indicator">-</span> <span class="nt">resource_name</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">BLOCK_UPDATE</span>
    <span class="nt">principle</span><span class="p">:</span>
      <span class="nt">rule</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">ANY</span>
      <span class="nt">org_list</span><span class="p">:</span>
      <span class="nt">role_list</span><span class="p">:</span>
        <span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">admin</span>
        <span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">client</span>
  <span class="p p-Indicator">-</span> <span class="nt">resource_name</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">INIT_CONTRACT</span>
    <span class="nt">principle</span><span class="p">:</span>
      <span class="nt">rule</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">ANY</span>
      <span class="nt">org_list</span><span class="p">:</span>
      <span class="nt">role_list</span><span class="p">:</span>
  <span class="p p-Indicator">-</span> <span class="nt">resource_name</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">UPGRADE_CONTRACT</span>
    <span class="nt">principle</span><span class="p">:</span>
      <span class="nt">rule</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">ANY</span>
      <span class="nt">org_list</span><span class="p">:</span>
      <span class="nt">role_list</span><span class="p">:</span>
  <span class="p p-Indicator">-</span> <span class="nt">resource_name</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">FREEZE_CONTRACT</span>
    <span class="nt">principle</span><span class="p">:</span>
      <span class="nt">rule</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">ANY</span>
      <span class="nt">org_list</span><span class="p">:</span>
      <span class="nt">role_list</span><span class="p">:</span>
  <span class="p p-Indicator">-</span> <span class="nt">resource_name</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">UNFREEZE_CONTRACT</span>
    <span class="nt">principle</span><span class="p">:</span>
      <span class="nt">rule</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">ANY</span>
      <span class="nt">org_list</span><span class="p">:</span>
      <span class="nt">role_list</span><span class="p">:</span>
  <span class="p p-Indicator">-</span> <span class="nt">resource_name</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">REVOKE_CONTRACT</span>
    <span class="nt">principle</span><span class="p">:</span>
      <span class="nt">rule</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">ANY</span>
      <span class="nt">org_list</span><span class="p">:</span>
      <span class="nt">role_list</span><span class="p">:</span>
</pre></div>
</div>
<p>当节点上的某个链是第一次启动时，会读取链配置文件中相关项和值，并创建一个新的GenesisBlock作为创世块写入节点链数据库。所以需要保证链上的所有节点的创世块相同，才能保证共识生效，这就要求当前链的所有节点上配置的链配置文件内容是相同一致的，即使链配置已在中途被调用链配置相关合约改动过，新节点启动时链配置文件也必须使用最早的版本。</p>
</div>
<div class="section" id="id62">
<h4><strong>配置变更</strong><a class="headerlink" href="#id62" title="Permalink to this headline">¶</a></h4>
<p>链配置变更需要通过系统配置合约来完成，具体请参考《运维手册》。</p>
</div>
</div>
<div class="section" id="id63">
<h3>同步模块<a class="headerlink" href="#id63" title="Permalink to this headline">¶</a></h3>
<p>同步模块负责提供节点之间快速进行区块同步的服务，当新节点/远离链最新状体的节点，加入网络时，节点会通过模块与其他节点进行状态交互，迅速同步区块数据至链的最新状态.</p>
<div class="section" id="id64">
<h4>组件描述<a class="headerlink" href="#id64" title="Permalink to this headline">¶</a></h4>
<p>组件描述分为两部分：交互模块的组件、本模块的组件.</p>
<div class="section" id="id65">
<h5>交互模块的组件<a class="headerlink" href="#id65" title="Permalink to this headline">¶</a></h5>
<p>使用其它模块的组件，进行网络消息通信、区块验证、新区块上链等服务.</p>
<ul class="simple">
<li><p><strong>protocol.NetService</strong>：发送或接收网络请求，提供与其它节点进行网络信息交互的服务.</p></li>
<li><p><strong>msgbus.MessageBus</strong>：发送或接收消息给内部的其他模块，提供节点内部模块数据交互的服务.</p></li>
<li><p><strong>protocol.BlockchainStore</strong>：提供DB查询服务，获取链上信息，如获取指定高度的区块数据.</p></li>
<li><p><strong>protocol.LedgerCache</strong>：获取当前节点的缓存的最新链上状态</p></li>
<li><p><strong>protocol.BlockVerifier</strong>：对获取到的区块提供验证服务</p></li>
<li><p><strong>protocol.BlockCommitter</strong>：通过验证的区块会被添加至链上</p></li>
</ul>
</div>
<div class="section" id="id66">
<h5>本模块的组件<a class="headerlink" href="#id66" title="Permalink to this headline">¶</a></h5>
<ul class="simple">
<li><p><strong>BlockSyncServer</strong>：sync模块对外提供服务的整体结构，依赖了外部模块组件和内部组件</p></li>
<li><p><strong>Routine</strong>：工具类，提供内部服务的托管功能，使用单独的goroutine运行注册的服务；本身含有一个优先级任务队列，调用者可以向该队列中添加任务，使用托管的服务依次执行优先级队列中的任务，并将执行结果返回给上层调用方</p></li>
<li><p><strong>scheduler</strong>：请求区块服务，内部维护本节点链接的所有节点状态（对等节点的最新高度），当前已知高度区块的状态，以及正在请求的区块状态等；上层调用方收到节点状态时，更新内部维护的区块状态；同时，上层调用方定时触发区块请求任务，服务接收到请求后，依据内部维护的状态，选择一个待同步的区块和请求节点，向请求节点发送区块请求消息；并将收到的区块信息发送给<strong>processor</strong>服务</p></li>
<li><p><strong>processor</strong>：处理区块服务，内部维护接收到的区块信息，下一个待上链的区块高度；上层调用方定时触发区块处理任务，服务依据自身内部状态，处理待上链的区块，如果该区块不存在，则跳过此次任务处理，直到接收到该区块；并将区块的处理结果返回给<strong>scheduler</strong>服务</p></li>
</ul>
</div>
</div>
<div class="section" id="id67">
<h4>网络消息<a class="headerlink" href="#id67" title="Permalink to this headline">¶</a></h4>
<p>节点之间的网络消息分为两组：节点状态的请求与应答，区块信息的请求与应答</p>
<div class="highlight-go notranslate"><div class="highlight"><pre><span></span><span class="kd">type</span> <span class="nx">SyncBlockMsg_MsgType</span> <span class="kt">int32</span>

<span class="kd">const</span> <span class="p">(</span>
   <span class="nx">SyncBlockMsg_NODE_STATUS_REQ</span>  <span class="nx">SyncBlockMsg_MsgType</span> <span class="p">=</span> <span class="mi">0</span>
   <span class="nx">SyncBlockMsg_NODE_STATUS_RESP</span> <span class="nx">SyncBlockMsg_MsgType</span> <span class="p">=</span> <span class="mi">1</span>
   <span class="nx">SyncBlockMsg_BLOCK_SYNC_REQ</span>   <span class="nx">SyncBlockMsg_MsgType</span> <span class="p">=</span> <span class="mi">2</span>
   <span class="nx">SyncBlockMsg_BLOCK_SYNC_RESP</span>  <span class="nx">SyncBlockMsg_MsgType</span> <span class="p">=</span> <span class="mi">3</span>
<span class="p">)</span>
</pre></div>
</div>
<p><strong>protobuf的数据结构</strong></p>
<p>同步模块的网络消息，最外层结构如下，<code class="docutils literal notranslate"><span class="pre">Type</span></code>为上述四种消息类型，<code class="docutils literal notranslate"><span class="pre">Payload</span></code>为消息的载荷数据。</p>
<div class="highlight-go notranslate"><div class="highlight"><pre><span></span><span class="kd">type</span> <span class="nx">SyncBlockMsg</span> <span class="kd">struct</span> <span class="p">{</span>
	<span class="nx">Type</span>    <span class="nx">SyncBlockMsg_MsgType</span> 
	<span class="nx">Payload</span> <span class="p">[]</span><span class="kt">byte</span>               
<span class="p">}</span>
</pre></div>
</div>
<ul>
<li><p>节点状态的请求消息，它的载和数据为空</p></li>
<li><p>节点状态的应答消息，它的载荷数据为下列结构用protobuf序列化后的字节码</p>
<div class="highlight-go notranslate"><div class="highlight"><pre><span></span><span class="kd">type</span> <span class="nx">BlockHeightBCM</span> <span class="kd">struct</span> <span class="p">{</span>
	<span class="nx">BlockHeight</span> <span class="kt">int64</span> 
<span class="p">}</span>
</pre></div>
</div>
</li>
<li><p>区块请求消息，它的载荷数据为下列结构用protobuf序列化后的字节码</p>
<div class="highlight-go notranslate"><div class="highlight"><pre><span></span><span class="kd">type</span> <span class="nx">BlockSyncReq</span> <span class="kd">struct</span> <span class="p">{</span>
	<span class="nx">BlockHeight</span> <span class="kt">int64</span> 
	<span class="nx">BatchSize</span>   <span class="kt">int64</span> 
	<span class="nx">ReturnRwset</span> <span class="kt">bool</span>  
<span class="p">}</span>
</pre></div>
</div>
<ul class="simple">
<li><p><strong>BlockHeight</strong>：区块请求的起始高度</p></li>
<li><p><strong>BatchSize</strong>：依次请求几个区块；如起始高度为10，<code class="docutils literal notranslate"><span class="pre">BatchSize</span></code>为2，则表示请求 10，11两个区块</p></li>
<li><p><strong>ReturnRwset</strong>：是否返回区块的读写集数据；True，返回区块的读写集数据</p></li>
</ul>
</li>
<li><p>区块应答消息，它的载荷数据为下列结构用protobuf序列化后的字节码</p>
<div class="highlight-go notranslate"><div class="highlight"><pre><span></span><span class="kd">type</span> <span class="nx">BlockBatch</span> <span class="kd">struct</span> <span class="p">{</span>
	<span class="nx">Batchs</span> <span class="p">[]</span><span class="o">*</span><span class="nx">Block</span> 
<span class="p">}</span>

<span class="kd">type</span> <span class="nx">BlockInfoBatch</span> <span class="kd">struct</span> <span class="p">{</span>
	<span class="nx">Batchs</span> <span class="p">[]</span><span class="o">*</span><span class="nx">BlockInfo</span> 
<span class="p">}</span>
<span class="kd">type</span> <span class="nx">BlockInfo</span> <span class="kd">struct</span> <span class="p">{</span>
	<span class="nx">Block</span> <span class="o">*</span><span class="nx">Block</span> 
	<span class="nx">RwsetList</span> <span class="p">[]</span><span class="o">*</span><span class="nx">TxRWSet</span> 
<span class="p">}</span>
</pre></div>
</div>
<ul class="simple">
<li><p><strong>BlockBatch</strong>：当仅请求区块数据时，返回的应答为该结构</p></li>
<li><p><strong>BlockInfoBatch</strong>：当请求区块以及它的读写集数据时，返回的应答为该结构</p></li>
</ul>
</li>
</ul>
</div>
<div class="section" id="id68">
<h4>配置<a class="headerlink" href="#id68" title="Permalink to this headline">¶</a></h4>
<p>同步模块有如下几个配置：</p>
<div class="highlight-go notranslate"><div class="highlight"><pre><span></span><span class="kd">type</span> <span class="nx">syncConfig</span> <span class="kd">struct</span> <span class="p">{</span>
	<span class="nx">BroadcastTime</span>             <span class="kt">uint32</span>  <span class="s">`mapstructure:&quot;broadcast_time&quot;`</span>
	<span class="nx">BlockPoolSize</span>             <span class="kt">uint32</span>  <span class="s">`mapstructure:&quot;block_pool_size&quot;`</span>
	<span class="nx">WaitTimeOfBlockRequestMsg</span> <span class="kt">uint32</span>  <span class="s">`mapstructure:&quot;wait_time_requested&quot;`</span>
	<span class="nx">BatchSizeFromOneNode</span>      <span class="kt">uint32</span>  <span class="s">`mapstructure:&quot;batch_Size_from_one_node&quot;`</span>
	<span class="nx">ProcessBlockTick</span>          <span class="kt">float64</span> <span class="s">`mapstructure:&quot;process_block_tick&quot;`</span>
	<span class="nx">NodeStatusTick</span>            <span class="kt">float64</span> <span class="s">`mapstructure:&quot;node_status_tick&quot;`</span>
	<span class="nx">LivenessTick</span>              <span class="kt">float64</span> <span class="s">`mapstructure:&quot;liveness_tick&quot;`</span>
	<span class="nx">SchedulerTick</span>             <span class="kt">float64</span> <span class="s">`mapstructure:&quot;scheduler_tick&quot;`</span>
<span class="p">}</span>
</pre></div>
</div>
<ul class="simple">
<li><p><strong>BlockPoolSize</strong>：scheduler服务内部任务队列的大小</p></li>
<li><p><strong>WaitTimeOfBlockRequestMsg</strong>：区块请求的超时时间，当请求超时后，该请求的任务会被放回队列，待下一次重新执行</p></li>
<li><p><strong>BatchSizeFromOneNode</strong>：单次发送区块数据请求时，从一个节点连续获取的区块个数，即上述protobuf中描述的<code class="docutils literal notranslate"><span class="pre">BatchSize</span></code></p></li>
<li><p><strong>ProcessBlockTick</strong>：处理接收的区块数据的定时器间隔时长，单位：秒</p></li>
<li><p><strong>NodeStatusTick</strong>：获取所有链接节点的状态信息定时器间隔时长，单位：秒</p></li>
<li><p><strong>LivenessTick</strong>：检测区块请求应答是否超时的定时器时长，单位：秒</p></li>
<li><p><strong>SchedulerTick</strong>：发送区块请求的定时器时长，单位：秒</p></li>
</ul>
</div>
<div class="section" id="id69">
<h4>同步流程及状态流转<a class="headerlink" href="#id69" title="Permalink to this headline">¶</a></h4>
<p>同步模块内部对特定数据有如下的状态跟踪.</p>
<ul class="simple">
<li><p>scheduler服务内部对节点的状态跟踪：<code class="docutils literal notranslate"><span class="pre">map[string]int64</span></code></p>
<ul>
<li><p>key为节点的nodeId，value为节点的最新区块高度</p></li>
</ul>
</li>
<li><p>scheduler服务内部对区块的状态跟踪: <code class="docutils literal notranslate"><span class="pre">map[int64]blockState</span></code></p>
<ul>
<li><p>Key 为区块高度，value为区块状态，分别为：<code class="docutils literal notranslate"><span class="pre">newBlock</span></code>, <code class="docutils literal notranslate"><span class="pre">pendingBlock</span></code>, <code class="docutils literal notranslate"><span class="pre">receivedBlock</span></code></p>
<ul>
<li><p><code class="docutils literal notranslate"><span class="pre">newBlock</span></code>: 初次从一个节点状态中了解到某个高度的区块存在</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">pendingBlock</span></code>：向某个节点请求该区块的数据</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">receivedBlock</span></code>：从某个节点接收到该区块的数据</p></li>
</ul>
</li>
</ul>
</li>
</ul>
 <img src="images/chainmaker-sync-flow.png" width = "700" height = "700" alt="图片名称"/></div>
</div>
<div class="section" id="id70">
<h3>轻节点模块<a class="headerlink" href="#id70" title="Permalink to this headline">¶</a></h3>
<div class="section" id="id71">
<h4>简要描述<a class="headerlink" href="#id71" title="Permalink to this headline">¶</a></h4>
<ul class="simple">
<li><p>处理RPC请求，接收交易，验证本地账本是否存在，不存在通过P2P网络发送给全节点</p></li>
<li><p>从共识节点同步数据，校验数据合法性，过滤同属组织的交易并存储</p></li>
<li><p>复用全节点的Net，VM，RPCServer，Store等模块，不启动Core，Sync，TxPool，Consensus模块</p></li>
<li><p>在Blockchain模块中启动</p></li>
</ul>
</div>
<div class="section" id="id72">
<h4>主要逻辑<a class="headerlink" href="#id72" title="Permalink to this headline">¶</a></h4>
<div class="section" id="id73">
<h5>处理RPC请求<a class="headerlink" href="#id73" title="Permalink to this headline">¶</a></h5>
<ol class="simple">
<li><p>接收交易请求，查询交易是否在账本中，防止双花，如果在直接返回</p></li>
<li><p>判断交易请求类型，如果是查询类交易，复用全节点查询逻辑走native合约查询</p></li>
<li><p>如果是写操作交易，走P2P网络广播出去</p></li>
</ol>
</div>
<div class="section" id="id74">
<h5>同步逻辑<a class="headerlink" href="#id74" title="Permalink to this headline">¶</a></h5>
<p>通过P2P连接到网络，监听全节点同步模块发送的消息，起四个协程处理数据，请求和响应数据存储在小顶堆里，通过高度排序</p>
<ol class="simple">
<li><p>loop：处理全节点同步模块发送的消息</p>
<ol class="simple">
<li><p>onReceiveHeartbeat：处理某个节点发送来的高度消息，更新管理节点的高度，判断账本高度和心跳高度的大小，决定好要请求的高度范围，将高度范围拆分成更小范围的一个个请求，发送出去，并放入请求小顶堆</p></li>
<li><p>onReceiveSyncResp: 处理请求节点后响应的区块列表信息，校验高度是否在目前请求的高度范围，符合放入响应的小顶堆</p></li>
</ol>
</li>
<li><p>respProcessLoop: 处理响应小顶堆里的消息</p>
<ol class="simple">
<li><p>如果请求小顶堆的Top的高度 = 响应小顶堆的Top的高度，则两个堆的Top是对应的，验证数据合法存储成功后，都Pop掉</p></li>
<li><p>如果请求小顶堆的Top的高度 &gt; 响应小顶堆的Top的高度，说明响应小顶堆的Top数据是旧的，或者过时的，将其Pop清除掉</p></li>
</ol>
</li>
<li><p>refreshReqCache: 处理请求小顶堆里的消息，如果账本的高度&gt;=小顶堆里Top高度，则清除小顶堆的数据直到不满足为止</p></li>
<li><p>resyncLoop: 检查请求小顶堆里的请求是否有超时的，有超时则进行重发</p></li>
</ol>
</div>
</div>
<div class="section" id="id75">
<h4>配置说明<a class="headerlink" href="#id75" title="Permalink to this headline">¶</a></h4>
<p>chainmaker.yml
节点类型修改成spv，证书做替换成common里的</p>
<div class="highlight-yml notranslate"><div class="highlight"><pre><span></span>node:
  # 节点类型：full、spv
  type: spv
  priv_key_file: ./crypto-config/wx-org1.chainmaker.org/node/common1/common1.tls.key
  cert_file:     ./crypto-config/wx-org1.chainmaker.org/node/common1/common1.tls.crt
  org_id: wx-org1
spv:
  refresh_reqcache_mils: 10000    # 每10秒查一次账本，清除小于账本高度的请求堆
  message_cahche_size: 12800      # 处理网络消息channel个数
  resync_check_interval_mils: 10  # 每笔请求同步多少个区块
  sync_timeout_mils: 1000         # 一次（多笔请求）最多同步多少个区块
  reqsync_blocknum: 10000         # 定时处理请求堆
  max_reqsync_blocknum: 10000     # 发出同步请求超时时间
  peer_active_time: 0             # 判断节点未发送心跳超时时间，剔除节点，0则不判断
</pre></div>
</div>
<p>如果配置文件没有配置，则取代码中的默认配置</p>
<div class="highlight-go notranslate"><div class="highlight"><pre><span></span><span class="kd">func</span> <span class="nx">NewConfig</span><span class="p">()</span> <span class="o">*</span><span class="nx">Config</span> <span class="p">{</span>
	<span class="k">return</span> <span class="o">&amp;</span><span class="nx">Config</span><span class="p">{</span>
		<span class="nx">RefreshReqCacheMills</span><span class="p">:</span>     <span class="mi">10000</span><span class="p">,</span>     <span class="c1">// 每10秒查一次账本，清除小于账本高度的请求堆</span>
		<span class="nx">MessageCacheSize</span><span class="p">:</span>         <span class="mi">12800</span><span class="p">,</span>     <span class="c1">// 处理网络消息channel个数</span>

		<span class="nx">MaxBlockNumPerSync</span><span class="p">:</span>       <span class="mi">10</span><span class="p">,</span>		 <span class="c1">// 每笔请求同步多少个区块</span>
		<span class="nx">MaxReqSyncBlockNum</span><span class="p">:</span>       <span class="mi">1000</span><span class="p">,</span>      <span class="c1">// 一次（多笔请求）最多同步多少个区块</span>

		<span class="nx">ReSyncCheckIntervalMills</span><span class="p">:</span> <span class="mi">10000</span><span class="p">,</span>     <span class="c1">// 定时处理请求堆</span>
		<span class="nx">SyncTimeoutMills</span><span class="p">:</span>         <span class="mi">10000</span><span class="p">,</span>     <span class="c1">// 发出同步请求超时时间</span>
		<span class="nx">PeerActiveTime</span><span class="p">:</span>           <span class="mi">0</span><span class="p">,</span>         <span class="c1">// 判断节点未发送心跳超时时间，剔除节点，0则不判断</span>
	<span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
</div>
</div>
<div class="section" id="id76">
<h3>交易池<a class="headerlink" href="#id76" title="Permalink to this headline">¶</a></h3>
<p>交易池模块用来存储节点从网络中接收到交易，来自网络的交易从接收方式上分为两种：用户/上层APP通过RPC，向节点添加交易；接收其他节点通过P2P广播自身已收到的交易。当交易池内存储的交易达到容量限制时，会通知core模块，尝试生成新的出块，如果节点为出块节点，且满足出块时机，此时会生成新的区块。</p>
<div class="section" id="id77">
<h4>交易的种类<a class="headerlink" href="#id77" title="Permalink to this headline">¶</a></h4>
<p>交易池中存储的交易分为两种类型：配置类型的交易，普通类型的交易</p>
<ul class="simple">
<li><p>配置类型的交易：修改链配置；如果区块内含有链配置交易，则该区块被限制为总共有且仅有一笔交易</p></li>
<li><p>普通类型的交易：如创建合约、调用合约等</p></li>
</ul>
</div>
<div class="section" id="id78">
<h4>接口描述<a class="headerlink" href="#id78" title="Permalink to this headline">¶</a></h4>
<div class="highlight-go notranslate"><div class="highlight"><pre><span></span><span class="kd">type</span> <span class="nx">TxPool</span> <span class="kd">interface</span> <span class="p">{</span>
	<span class="nx">Start</span><span class="p">()</span> <span class="kt">error</span>
	<span class="nx">Stop</span><span class="p">()</span> <span class="kt">error</span>
	<span class="nx">AddTx</span><span class="p">(</span><span class="nx">tx</span> <span class="o">*</span><span class="nx">pb</span><span class="p">.</span><span class="nx">Transaction</span><span class="p">,</span> <span class="nx">source</span> <span class="nx">TxSource</span><span class="p">)</span> <span class="kt">error</span>
  <span class="nx">TxExists</span><span class="p">(</span><span class="nx">tx</span> <span class="o">*</span><span class="nx">pb</span><span class="p">.</span><span class="nx">Transaction</span><span class="p">)</span> <span class="kt">bool</span>
	<span class="nx">GetTxByTxId</span><span class="p">(</span><span class="nx">txId</span> <span class="kt">string</span><span class="p">)</span> <span class="p">(</span><span class="nx">tx</span> <span class="o">*</span><span class="nx">pb</span><span class="p">.</span><span class="nx">Transaction</span><span class="p">,</span> <span class="nx">inBlockHeight</span> <span class="kt">int64</span><span class="p">)</span>
  <span class="nx">GetTxsByTxIds</span><span class="p">(</span><span class="nx">txIds</span> <span class="p">[]</span><span class="kt">string</span><span class="p">)</span> <span class="p">(</span><span class="nx">txsRet</span> <span class="kd">map</span><span class="p">[</span><span class="kt">string</span><span class="p">]</span><span class="o">*</span><span class="nx">pb</span><span class="p">.</span><span class="nx">Transaction</span><span class="p">,</span> <span class="nx">txsHeightRet</span> <span class="kd">map</span><span class="p">[</span><span class="kt">string</span><span class="p">]</span><span class="kt">int64</span><span class="p">)</span>
	<span class="nx">RetryAndRemove</span><span class="p">(</span><span class="nx">retryTxs</span><span class="p">,</span> <span class="nx">removeTxs</span> <span class="p">[]</span><span class="o">*</span><span class="nx">pb</span><span class="p">.</span><span class="nx">Transaction</span><span class="p">)</span>
	<span class="nx">FetchTxBatch</span><span class="p">(</span><span class="nx">blockHeight</span> <span class="kt">int64</span><span class="p">)</span> <span class="p">[]</span><span class="o">*</span><span class="nx">pb</span><span class="p">.</span><span class="nx">Transaction</span>
	<span class="nx">AddTxsToPendingCache</span><span class="p">(</span><span class="nx">txs</span> <span class="p">[]</span><span class="o">*</span><span class="nx">pb</span><span class="p">.</span><span class="nx">Transaction</span><span class="p">,</span> <span class="nx">blockHeight</span> <span class="kt">int64</span><span class="p">)</span>
<span class="p">}</span>
</pre></div>
</div>
<ul class="simple">
<li><p><strong>Start</strong>：启动交易池服务</p></li>
<li><p><strong>Stop</strong>：关闭交易池服务</p></li>
<li><p><strong>AddTx</strong>：添加交易至交易池，source为交易的来源，有三种类型：RPC、P2P、INTERNAL，不同来源的交易，对应不同的检查</p>
<ul>
<li><p>RPC：来自RPC的交易不验证基础的交易信息（如交易ID、时间戳是否符合规范）、不验证交易者的证书；因为RPC模块已做此类校验；成功添加至交易池的交易会广播给其它连接的节点</p></li>
<li><p>P2P：进行所有的校验</p></li>
<li><p>INTERNAL：如果节点在同一高度接收到多个验证有效的区块，当其中某个区块上链后，其余的相同高度区块内的交易会被重新添加进交易池，防止这些交易被抛弃。此时会使用DB对添加进交易池的交易做存在性检查，将未上链的交易添加进交易池</p></li>
</ul>
</li>
<li><p><strong>GetTxByTxId</strong>：依据交易ID在交易池查询该交易，如果交易存在，返回交易数据，以及交易在交易池中记录的高度</p>
<ul>
<li><p>交易在交易池中高度分为三种</p>
<ul>
<li><p>交易池中不存在该交易，返回的高度为-1</p></li>
<li><p>交易存在于交易池的普通队列（即：待打包区块队列），返回的高度为0</p></li>
<li><p>交易存在于交易池的pending队列（即：已打包但未上链的交易），返回的高度为交易所在的区块高度</p></li>
</ul>
</li>
</ul>
</li>
<li><p><strong>GetTxsByTxIds</strong>：依据交易ID在交易池查询交易的批量接口；</p>
<ul>
<li><p>返回值txsRet，存储交易的内容信息，key 为txId，value为交易内容；交易不存在时，value为nil</p></li>
<li><p>返回值txsHeightRet，存储交易所在的区块高度，key 为txId，value为高度信息</p></li>
</ul>
</li>
<li><p><strong>TxExists</strong>：判断交易是否存在与交易池，存在返回true，反之为false</p></li>
<li><p><strong>RetryAndRemove</strong>：将参数一的交易重新添加至交易池的普通队列，且这些交易如果存在于pending 队列，则从pending队列中删除，将参数二的交易从交易池中删除；该接口主要由<code class="docutils literal notranslate"><span class="pre">core</span></code>模块进行调用，当节点在同一高度接收到多个不同区块时，将待上链区块的交易，从交易池中删除；将其它不上链区块的交易，重新添加进交易池；</p>
<ul>
<li><p>注意：该接口的内部实现为：先添加参数一的交易，后删除参数二的交易；以便即使参数一与参数二有部分重合交易时，最后也会从交易池中删除。</p></li>
</ul>
</li>
<li><p><strong>FetchTxBatch</strong>：从交易池获取一批交易，获取数量最大为单个区块可容纳的交易数，参数为要打包的区块高度；由core模块调用，使用获取的交易打包生成新的区块</p>
<ul>
<li><p>获取交易时，会将这批交易从交易池的普通队列移动到pending队列</p></li>
</ul>
</li>
<li><p><strong>AddTxsToPendingCache</strong>：将交易添加进交易池的pending队列中，且这批交易如果存在于交易池的普通队列中，则从普通队列中删除；参数二为这批交易所在的区块高度；</p>
<ul>
<li><p>当节点收到一个新区块时，验证通过后，将该区块内的交易添加进交易池的pending队列</p></li>
</ul>
</li>
</ul>
</div>
<div class="section" id="id79">
<h4>组件描述<a class="headerlink" href="#id79" title="Permalink to this headline">¶</a></h4>
<p>组件描述分为两部分：交互模块的组件、本模块的组件。</p>
<div class="section" id="id80">
<h5>交互模块的组件<a class="headerlink" href="#id80" title="Permalink to this headline">¶</a></h5>
<ul class="simple">
<li><p><strong>msgbus.MessageBus</strong>：发送或接收消息给内部的其他模块，提供节点内部模块数据交互的服务.</p></li>
<li><p><strong>protocol.NetService</strong>：发送或接收网络请求，提供与其它节点进行网络信息交互的服务.</p></li>
<li><p><strong>protocol.BlockchainStore</strong>：提供DB查询服务，获取链上信息，如查询指定交易</p></li>
<li><p><strong>protocol.Organization</strong>：验证交易内的证书信息是否有效</p></li>
<li><p><strong>protocol.AccessControl</strong>：验证交易内的证书是否有访问特定资源的权限</p></li>
</ul>
</div>
<div class="section" id="id81">
<h5>本模块的组件<a class="headerlink" href="#id81" title="Permalink to this headline">¶</a></h5>
<ul class="simple">
<li><p><strong>txList</strong>：用该结构缓存交易池内的交易；由于交易有两种类型，所以，交易池内存在两个<code class="docutils literal notranslate"><span class="pre">txList</span></code>，缓存不同类型的交易</p></li>
<li><p><strong>common.LinkedHashMap</strong>：<code class="docutils literal notranslate"><span class="pre">txList</span></code>内包含两个<code class="docutils literal notranslate"><span class="pre">LinkedHashMap</span></code>，分别存储不同状态的交易</p>
<ul>
<li><p><strong>queue</strong>：存储待打包区块的交易</p></li>
<li><p><strong>pendingCache</strong>：存储已打包进区块，但未上链的交易</p></li>
</ul>
</li>
</ul>
</div>
</div>
<div class="section" id="id82">
<h4>配置<a class="headerlink" href="#id82" title="Permalink to this headline">¶</a></h4>
<div class="highlight-go notranslate"><div class="highlight"><pre><span></span><span class="kd">type</span> <span class="nx">txPoolConfig</span> <span class="kd">struct</span> <span class="p">{</span>
	<span class="nx">MaxTxPoolSize</span>       <span class="kt">uint32</span> <span class="s">`mapstructure:&quot;max_txpool_size&quot;`</span>
	<span class="nx">MaxConfigTxPoolSize</span> <span class="kt">uint32</span> <span class="s">`mapstructure:&quot;max_config_txpool_size&quot;`</span>
	<span class="nx">FullNotifyAgainTime</span> <span class="kt">uint32</span> <span class="s">`mapstructure:&quot;full_notify_again_time&quot;`</span>
	<span class="nx">IsMetrics</span>           <span class="kt">bool</span>   <span class="s">`mapstructure:&quot;is_metrics&quot;`</span>
<span class="p">}</span>
</pre></div>
</div>
<ul class="simple">
<li><p><strong>MaxTxPoolSize</strong>：交易池可以缓存的普通交易的数量</p></li>
<li><p><strong>MaxConfigTxPoolSize</strong>：交易池可以缓存配置交易的数量</p></li>
<li><p><strong>FullNotifyAgainTime</strong>：当交易池容量满时，通知上层模块打包区块的时间间隔</p></li>
<li><p><strong>IsMetrics</strong>：是否开启交易池数据监测功能</p></li>
</ul>
</div>
<div class="section" id="id83">
<h4>流程图<a class="headerlink" href="#id83" title="Permalink to this headline">¶</a></h4>
<img src="images/chainmaker-txpool-flow.png" width = "700" height = "500" alt="chainmaker-txpool-flow"/></div>
</div>
<div class="section" id="id84">
<h3>加密算法<a class="headerlink" href="#id84" title="Permalink to this headline">¶</a></h3>
<div class="section" id="id85">
<h4>简介<a class="headerlink" href="#id85" title="Permalink to this headline">¶</a></h4>
<p>crypto 模块提供了一些密码学算法 (包括加密、签名、哈希等) 能力及其相关的协议的接口。</p>
</div>
<div class="section" id="id86">
<h4>密码学算法<a class="headerlink" href="#id86" title="Permalink to this headline">¶</a></h4>
<div class="section" id="id87">
<h5>非对称密码学算法接口<a class="headerlink" href="#id87" title="Permalink to this headline">¶</a></h5>
<p>定义了如下的非对称体系公私钥接口：</p>
<div class="highlight-go notranslate"><div class="highlight"><pre><span></span><span class="c1">// Signing options</span>
<span class="kd">type</span> <span class="nx">SignOpts</span> <span class="kd">struct</span> <span class="p">{</span>
	<span class="nx">Hash</span> <span class="nx">HashType</span>
	<span class="nx">UID</span>  <span class="kt">string</span>
<span class="p">}</span>

<span class="c1">// === 秘钥接口 ===</span>
<span class="kd">type</span> <span class="nx">Key</span> <span class="kd">interface</span> <span class="p">{</span>
	<span class="c1">// 获取秘钥字节数组</span>
	<span class="nx">Bytes</span><span class="p">()</span> <span class="p">([]</span><span class="kt">byte</span><span class="p">,</span> <span class="kt">error</span><span class="p">)</span>

	<span class="c1">// 获取秘钥类型</span>
	<span class="nx">Type</span><span class="p">()</span> <span class="nx">KeyType</span>

	<span class="c1">// 获取编码后秘钥(PEM格式)</span>
	<span class="nx">String</span><span class="p">()</span> <span class="p">(</span><span class="kt">string</span><span class="p">,</span> <span class="kt">error</span><span class="p">)</span>
<span class="p">}</span>

<span class="c1">// === 非对称秘钥签名+验签接口 ===</span>
<span class="c1">// 私钥签名接口</span>
<span class="kd">type</span> <span class="nx">PrivateKey</span> <span class="kd">interface</span> <span class="p">{</span>
	<span class="nx">Key</span>

	<span class="c1">// 私钥签名</span>
	<span class="nx">Sign</span><span class="p">(</span><span class="nx">data</span> <span class="p">[]</span><span class="kt">byte</span><span class="p">)</span> <span class="p">([]</span><span class="kt">byte</span><span class="p">,</span> <span class="kt">error</span><span class="p">)</span>

	<span class="nx">SignWithOpts</span><span class="p">(</span><span class="nx">data</span> <span class="p">[]</span><span class="kt">byte</span><span class="p">,</span> <span class="nx">opts</span> <span class="o">*</span><span class="nx">SignOpts</span><span class="p">)</span> <span class="p">([]</span><span class="kt">byte</span><span class="p">,</span> <span class="kt">error</span><span class="p">)</span>

	<span class="c1">// 返回公钥</span>
	<span class="nx">PublicKey</span><span class="p">()</span> <span class="nx">PublicKey</span>

	<span class="c1">// 转换为crypto包中的 PrivateKey 接口类</span>
	<span class="nx">ToStandardKey</span><span class="p">()</span> <span class="nx">crypto</span><span class="p">.</span><span class="nx">PrivateKey</span>
<span class="p">}</span>

<span class="c1">// 公钥验签接口</span>
<span class="kd">type</span> <span class="nx">PublicKey</span> <span class="kd">interface</span> <span class="p">{</span>
	<span class="nx">Key</span>

	<span class="c1">// 公钥验签</span>
	<span class="nx">Verify</span><span class="p">(</span><span class="nx">data</span> <span class="p">[]</span><span class="kt">byte</span><span class="p">,</span> <span class="nx">sig</span> <span class="p">[]</span><span class="kt">byte</span><span class="p">)</span> <span class="p">(</span><span class="kt">bool</span><span class="p">,</span> <span class="kt">error</span><span class="p">)</span>

	<span class="nx">VerifyWithOpts</span><span class="p">(</span><span class="nx">data</span> <span class="p">[]</span><span class="kt">byte</span><span class="p">,</span> <span class="nx">sig</span> <span class="p">[]</span><span class="kt">byte</span><span class="p">,</span> <span class="nx">opts</span> <span class="o">*</span><span class="nx">SignOpts</span><span class="p">)</span> <span class="p">(</span><span class="kt">bool</span><span class="p">,</span> <span class="kt">error</span><span class="p">)</span>

	<span class="c1">// 转换为crypto包中的 PublicKey 接口类</span>
	<span class="nx">ToStandardKey</span><span class="p">()</span> <span class="nx">crypto</span><span class="p">.</span><span class="nx">PublicKey</span>
<span class="p">}</span>
</pre></div>
</div>
<p>SignOpts 结构用于为一个签名、验签操作提供灵活的流程变化。其中，Hash 字段可以设置哈希算法，例如 SHA256、SM3 等。UID 字段是 SM2-SM3 签名套件专用字段，用于设置国密局规定的 user ID。</p>
<p>Key 接口定义了密码学公私钥通用的序列化接口，和一个返回密钥算法的 Type() 接口。</p>
<p>PrivateKey 接口用于签名私钥，通常使用的是 SighWithOpts() 接口，其中入参 data 是数据原文，opts是一个 SignOpts 类型的结构，用于指定哈希算法，在 SM2-SM3 签名套件中也用于指定 user ID。在 长安链中应用时，这个哈希算法可能读取自证书中指定的算法套件，也可能来自配置文件设置。</p>
</div>
<div class="section" id="id88">
<h5>公私钥的序列化<a class="headerlink" href="#id88" title="Permalink to this headline">¶</a></h5>
<p>在应用中，公钥、私钥通常会以字符串形式保存在配置文件中或用于传输。前面提到的 Key 接口中的 String() 为公钥提供了序列化为 PEM 格式字符串的能力。</p>
<p>要把字符串形式的公私钥反序列化为对象，可以调用 crypto/asym 包中的 PublicKeyFromPEM() 或 PrivateKeyFromPEM() 接口。长安链 支持的算法都可以用这两个通用接口反序列化公私钥。</p>
</div>
</div>
<div class="section" id="id89">
<h4>证书<a class="headerlink" href="#id89" title="Permalink to this headline">¶</a></h4>
<p>长安链 使用的节点、客户端证书需要满足一下要求：</p>
<ol class="simple">
<li><p>O 字段需要指明节点或客户端所属的组织的名称。</p></li>
<li><p>OU 字段需要指明节点或客户端的身份，默认身份有四种：admin、client、consensus、common，分别代表管理员、普通用户、共识节点、普通节点。</p></li>
</ol>
</div>
</div>
<div class="section" id="id90">
<h3>核心引擎<a class="headerlink" href="#id90" title="Permalink to this headline">¶</a></h3>
<div class="section" id="id91">
<h4>简要描述<a class="headerlink" href="#id91" title="Permalink to this headline">¶</a></h4>
<p>core模块（核心引擎）负责区块的打包、验证和落块的处理。其中：</p>
<ul class="simple">
<li><p>区块打包需要与共识模块和TxPool模块交互，基于当前最新区块以及打包的前置条件（当前）触发操作。</p></li>
<li><p>交易调度，负责将待打包区块的交易调用智能合约执行，如果发现交易存在读写集冲突，按照规则重新调度，并返回交易执行结果和交易执行排序（DAG）；同时，该模块支持按照给定的DAG执行智能合约，得到交易执行结果，用于有效性校验。</p></li>
<li><p>区块的验证，在该节点收到共识或同步模块接收的区块后，对该区块的合法性进行校验。校验的详细内容参见流程说明部分。</p></li>
<li><p>区块的落块，在共识或同步模块确认区块合法并完成投票处理（共识需要）后，将区块和区块中读写集记录到账本数据库中。在落块成功后，将最新区块信息更新至账本缓存（ledger模块），并通知新区块事件至共识、同步和消息订阅模块。</p></li>
</ul>
</div>
<div class="section" id="id92">
<h4>接口说明<a class="headerlink" href="#id92" title="Permalink to this headline">¶</a></h4>
<ul class="simple">
<li><p>BlockProposer（区块提案）</p></li>
</ul>
<div class="highlight-go notranslate"><div class="highlight"><pre><span></span><span class="c1">// Block proposer, generate new block when node is consensus proposer.</span>
<span class="kd">type</span> <span class="nx">BlockProposer</span> <span class="kd">interface</span> <span class="p">{</span>
	<span class="c1">// Start proposer.</span>
	<span class="nx">Start</span><span class="p">()</span> <span class="kt">error</span>
	<span class="c1">// Stop proposer</span>
	<span class="nx">Stop</span><span class="p">()</span> <span class="kt">error</span>
	<span class="c1">// Receive propose signal from txpool module.</span>
	<span class="nx">OnReceiveTxPoolSignal</span><span class="p">(</span><span class="nx">proposeSignal</span> <span class="o">*</span><span class="nx">pb</span><span class="p">.</span><span class="nx">TxPoolSignal</span><span class="p">)</span>
	<span class="c1">// Receive signal indicates if node is proposer from consensus module.</span>
	<span class="nx">OnReceiveProposeStatusChange</span><span class="p">(</span><span class="nx">proposeStatus</span> <span class="kt">bool</span><span class="p">)</span>
<span class="p">}</span>
</pre></div>
</div>
<ul class="simple">
<li><p>TxScheduler（交易调度）</p></li>
</ul>
<div class="highlight-go notranslate"><div class="highlight"><pre><span></span><span class="c1">// TxScheduler schedules a transaction batch and returns a block (maybe not complete) with DAG</span>
<span class="c1">// TxScheduler also can run VM with a given DAG, and return results.</span>
<span class="c1">// It can only be called by BlockProposer</span>
<span class="c1">// Should have multiple implementations and adaptive mode</span>
<span class="kd">type</span> <span class="nx">TxScheduler</span> <span class="kd">interface</span> <span class="p">{</span>
	<span class="c1">// schedule a transaction batch into a block with DAG</span>
	<span class="c1">// Return result(and read write set) of each transaction, no matter it is executed OK, or fail, or timeout.</span>
	<span class="c1">// For cross-contracts invoke, result(and read write set) include all contract relative.</span>
	<span class="nx">Schedule</span><span class="p">(</span><span class="nx">block</span> <span class="o">*</span><span class="nx">pb</span><span class="p">.</span><span class="nx">Block</span><span class="p">,</span> <span class="nx">txBatch</span> <span class="p">[]</span><span class="o">*</span><span class="nx">pb</span><span class="p">.</span><span class="nx">Transaction</span><span class="p">,</span> <span class="nx">snapshot</span> <span class="nx">Snapshot</span><span class="p">)</span> <span class="p">(</span><span class="kd">map</span><span class="p">[</span><span class="kt">string</span><span class="p">]</span><span class="o">*</span><span class="nx">pb</span><span class="p">.</span><span class="nx">TxRWSet</span><span class="p">,</span> <span class="kt">error</span><span class="p">)</span>
	<span class="c1">// Run VM with a given DAG, and return results.</span>
	<span class="nx">SimulateWithDag</span><span class="p">(</span><span class="nx">block</span> <span class="o">*</span><span class="nx">pb</span><span class="p">.</span><span class="nx">Block</span><span class="p">,</span> <span class="nx">snapshot</span> <span class="nx">Snapshot</span><span class="p">)</span> <span class="p">(</span><span class="kd">map</span><span class="p">[</span><span class="kt">string</span><span class="p">]</span><span class="o">*</span><span class="nx">pb</span><span class="p">.</span><span class="nx">TxRWSet</span><span class="p">,</span> <span class="kd">map</span><span class="p">[</span><span class="kt">string</span><span class="p">]</span><span class="o">*</span><span class="nx">pb</span><span class="p">.</span><span class="nx">Result</span><span class="p">,</span> <span class="kt">error</span><span class="p">)</span>
	<span class="c1">// To halt scheduler and release VM resources.</span>
	<span class="nx">Halt</span><span class="p">()</span>
<span class="p">}</span>
</pre></div>
</div>
<ul class="simple">
<li><p>TxSimContext（交易执行上下文）</p></li>
</ul>
<div class="highlight-go notranslate"><div class="highlight"><pre><span></span><span class="c1">// The simulated execution context of the transaction, providing a cache for the transaction to read and write</span>
<span class="kd">type</span> <span class="nx">TxSimContext</span> <span class="kd">interface</span> <span class="p">{</span>
	<span class="c1">// Get key from cache</span>
	<span class="nx">Get</span><span class="p">(</span><span class="nx">namespace</span> <span class="kt">string</span><span class="p">,</span> <span class="nx">key</span> <span class="p">[]</span><span class="kt">byte</span><span class="p">)</span> <span class="p">([]</span><span class="kt">byte</span><span class="p">,</span> <span class="kt">error</span><span class="p">)</span>
	<span class="c1">// Put key into cache</span>
	<span class="nx">Put</span><span class="p">(</span><span class="nx">namespace</span> <span class="kt">string</span><span class="p">,</span> <span class="nx">key</span> <span class="p">[]</span><span class="kt">byte</span><span class="p">,</span> <span class="nx">value</span> <span class="p">[]</span><span class="kt">byte</span><span class="p">)</span> <span class="kt">error</span>
	<span class="c1">// Delete key from cache</span>
	<span class="nx">Del</span><span class="p">(</span><span class="nx">namespace</span> <span class="kt">string</span><span class="p">,</span> <span class="nx">key</span> <span class="p">[]</span><span class="kt">byte</span><span class="p">)</span> <span class="kt">error</span>
	<span class="c1">// TODO Query a series of keys from the database, not yet implemented</span>
	<span class="nx">Select</span><span class="p">(</span><span class="nx">namespace</span> <span class="kt">string</span><span class="p">,</span> <span class="nx">startKey</span> <span class="p">[]</span><span class="kt">byte</span><span class="p">,</span> <span class="nx">limit</span> <span class="p">[]</span><span class="kt">byte</span><span class="p">)</span> <span class="p">(</span><span class="nx">Iterator</span><span class="p">,</span> <span class="kt">error</span><span class="p">)</span>
	<span class="c1">// Get related transaction</span>
	<span class="nx">GetTx</span><span class="p">()</span> <span class="o">*</span><span class="nx">pb</span><span class="p">.</span><span class="nx">Transaction</span>
	<span class="c1">// Get related transaction</span>
	<span class="nx">GetBlockHeight</span><span class="p">()</span> <span class="kt">int64</span>
	<span class="c1">// Get the tx result</span>
	<span class="nx">GetTxResult</span><span class="p">()</span> <span class="o">*</span><span class="nx">pb</span><span class="p">.</span><span class="nx">Result</span>
	<span class="c1">// Set the tx result</span>
	<span class="nx">SetTxResult</span><span class="p">(</span><span class="o">*</span><span class="nx">pb</span><span class="p">.</span><span class="nx">Result</span><span class="p">)</span>
	<span class="c1">// Get the read and write set completed by the current transaction</span>
	<span class="nx">GetTxRWSet</span><span class="p">()</span> <span class="o">*</span><span class="nx">pb</span><span class="p">.</span><span class="nx">TxRWSet</span>
	<span class="c1">// Get the creator of the contract</span>
	<span class="nx">GetCreator</span><span class="p">(</span><span class="nx">namespace</span> <span class="kt">string</span><span class="p">)</span> <span class="o">*</span><span class="nx">pb</span><span class="p">.</span><span class="nx">SerializedMember</span>
	<span class="c1">// Get the invoker of the transaction</span>
	<span class="nx">GetSender</span><span class="p">()</span> <span class="o">*</span><span class="nx">pb</span><span class="p">.</span><span class="nx">SerializedMember</span>
	<span class="c1">// Get related blockchain store</span>
	<span class="nx">GetBlockchainStore</span><span class="p">()</span> <span class="nx">BlockchainStore</span>
	<span class="c1">// Get organization service</span>
	<span class="nx">GetOrganization</span><span class="p">()</span> <span class="p">(</span><span class="nx">Organization</span><span class="p">,</span> <span class="kt">error</span><span class="p">)</span>
	<span class="c1">// Get access control service</span>
	<span class="nx">GetAccessControl</span><span class="p">()</span> <span class="p">(</span><span class="nx">AccessControl</span><span class="p">,</span> <span class="kt">error</span><span class="p">)</span>
	<span class="c1">//获取状态数据库的的创建\升级合约对应的交易Id列表</span>
	<span class="nx">GetContractTxIds</span><span class="p">()</span> <span class="p">([]</span><span class="kt">string</span><span class="p">,</span> <span class="kt">error</span><span class="p">)</span>
	<span class="c1">// Get organization service</span>
	<span class="nx">GetNet</span><span class="p">()</span> <span class="p">(</span><span class="nx">Net</span><span class="p">,</span> <span class="kt">error</span><span class="p">)</span>
	<span class="c1">// The execution sequence of the transaction, used to construct the dag,</span>
	<span class="c1">// indicating the number of completed transactions during transaction scheduling</span>
	<span class="nx">GetTxExecSeq</span><span class="p">()</span> <span class="kt">int</span>
	<span class="nx">SetTxExecSeq</span><span class="p">(</span><span class="kt">int</span><span class="p">)</span>
<span class="p">}</span>
</pre></div>
</div>
<ul class="simple">
<li><p>BlockVerifier（区块验证）</p></li>
</ul>
<div class="highlight-go notranslate"><div class="highlight"><pre><span></span><span class="c1">// Block verifier, verify if a block is valid</span>
<span class="kd">type</span> <span class="nx">BlockVerifier</span> <span class="kd">interface</span> <span class="p">{</span>
	<span class="c1">// Verify if a block is valid</span>
	<span class="nx">VerifyBlock</span><span class="p">(</span><span class="nx">block</span> <span class="o">*</span><span class="nx">pb</span><span class="p">.</span><span class="nx">Block</span><span class="p">,</span> <span class="nx">mode</span> <span class="nx">VerifyMode</span><span class="p">)</span> <span class="kt">error</span>
<span class="p">}</span>
</pre></div>
</div>
<ul class="simple">
<li><p>BlockCommitter（区块提交）</p></li>
</ul>
<div class="highlight-go notranslate"><div class="highlight"><pre><span></span><span class="c1">// Block committer, put block and read write set into ledger(DB).</span>
<span class="kd">type</span> <span class="nx">BlockCommitter</span> <span class="kd">interface</span> <span class="p">{</span>
	<span class="c1">// Put block into ledger(DB) after block verify. Invoke by consensus or sync module.</span>
	<span class="nx">AddBlock</span><span class="p">(</span><span class="nx">blk</span> <span class="o">*</span><span class="nx">pb</span><span class="p">.</span><span class="nx">Block</span><span class="p">)</span> <span class="kt">error</span>
<span class="p">}</span>
</pre></div>
</div>
</div>
<div class="section" id="id93">
<h4>流程说明<a class="headerlink" href="#id93" title="Permalink to this headline">¶</a></h4>
<ul class="simple">
<li><p>BlockProposer（区块提案）</p></li>
</ul>
<ol class="simple">
<li><p>确定是否是提案节点（通过OnReceiveProposeStatusChange方法获得共识模块的通知，变更核心引擎的proposer状态）</p></li>
<li><p>触发打包事件</p>
<ol class="simple">
<li><p>先基于重入锁进行并发控制，只有一个线程进行打包任务执行</p></li>
<li><p>触发机制包括：proposer的超时或TxPool模块池大小超过阈值</p></li>
<li><p>判断是否可以打包，如果通过，进入第3步</p>
<ol class="simple">
<li><p>再次确认本节点是proposer</p></li>
<li><p>判断本阶段未处在正在打包区块或提案区块未落块状态</p></li>
</ol>
</li>
</ol>
</li>
<li><p>区块打包</p>
<ol class="simple">
<li><p>判断本节点在此区块高度是否已提案过区块，如果已提案，则不重复打包新区块，将已提案区块重复进行共识投票；</p></li>
<li><p>从交易池获取一批交易；</p></li>
<li><p>判断该批次交易是否有重复，包括：账本已存在或批次内部有重复交易，去重判断后，如果待出块交易集为空，则停止打包；</p></li>
<li><p>通过TxScheduler调度智能合约执行交易，获得各交易的执行结果（包括读写集）；</p></li>
<li><p>基于智能合约执行结果，打包区块，包括：区块交易笔数、区块TxRoot、区块DAG哈希、区块读写集哈希；</p></li>
<li><p>如果前一区块是配置块，则修改PreConfHeight为前一区块高度，关联配置区块；</p></li>
<li><p>打包完成，缓存当前proposed block，并通知共识模块。</p></li>
</ol>
</li>
</ol>
<p>上述打包操作可终止，触发条件为，proposer模块接到共识模块通知，已更换为非proposer身份。终止时，会调用TxScheduler的Halt方法，停止虚拟机的调度执行。</p>
<ul class="simple">
<li><p>TxScheduler（交易调度）</p></li>
</ul>
<ol class="simple">
<li><p>预执行（Schedule）</p>
<ol class="simple">
<li><p>根据各交易请求，调度对应的VM执行合约，并收集结果；如果存在读写集冲突，则重新调度（并行执行）；</p></li>
<li><p>超时或合约调度结束，则跳出并行执行逻辑；</p></li>
<li><p>构建DAG；</p></li>
<li><p>基于TxId生成读写集map，并返回该map；</p></li>
</ol>
</li>
<li><p>根据DAG执行（SimulateWithDAG）</p>
<ol class="simple">
<li><p>基于DAG的顺序，并发调用VM执行合约；</p></li>
<li><p>超时或合约调度结束，则跳出并行执行逻辑；；</p></li>
<li><p>基于TxId生成读写集map，并返回读写集map和交易结果（本次执行的交易结果，单独运算，与原区块的结果进行对比验证）。</p></li>
</ol>
</li>
</ol>
<ul class="simple">
<li><p>BlockVerifier（区块验证）</p></li>
</ul>
<ol class="simple">
<li><p>区块头基本信息非空校验</p></li>
<li><p>并行冲突检测，不允许并发对相同哈希的区块进校验，允许并发对不同区块校验</p></li>
<li><p>是否已校验过该高度该哈希的区块，如果校验过，直接返回通过；</p></li>
<li><p>区块校验</p>
<ol class="simple">
<li><p>区块高度，是否为当前账本区块高度+1</p></li>
<li><p>本区块前序哈希校验</p></li>
<li><p>区块打包的交易数量是否和区块头里的交易数量一致</p></li>
<li><p>区块完整性</p>
<ol class="simple">
<li><p>区块签名，哈希根据区块头重新计算并校验签名</p></li>
<li><p>proposer身份</p></li>
<li><p>proposer权限</p></li>
</ol>
</li>
<li><p>交易完整性，merkle根校验，区块Txs的顺序计算得到的merkle根，与块头的merkle根比对是否一致</p></li>
<li><p>DAG完整性，DAG哈希校验，序列化区块DAG结构并计算哈希，比对与块头的DAG哈希比对是否一致</p></li>
<li><p>读写集完整性，按照DAG模拟执行的结果读写集结果计算哈希，与区块头的读写集哈希比对是否一致</p></li>
<li><p>如果是同步模块验证区块，则需要对共识投票签名进行验证，判断投票签名正确性和投票者身份及权限</p></li>
</ol>
</li>
<li><p>交易校验</p>
<ol class="simple">
<li><p>交易防重</p>
<ol class="simple">
<li><p>交易是否已落块，如果账本中存在该交易，则不通过（可并行）</p></li>
<li><p>本区块中是否有重复交易*</p></li>
</ol>
</li>
<li><p>交易完整性，如果交易存在与TxPool中，则取出来校验交易哈希完整性是否正确，并跳过下述校验，否则进行下述校验（可并行）：</p>
<ol class="simple">
<li><p>交易签名</p></li>
<li><p>交易提交者身份</p></li>
<li><p>交易提交者权限</p></li>
</ol>
</li>
</ol>
</li>
</ol>
<ul class="simple">
<li><p>BlockCommitter（区块提交）</p></li>
</ul>
<ol class="simple">
<li><p>从缓存中获取proposed block，如果不存在，则说明该区块未通过严格校验，不能落块；</p></li>
<li><p>对待落块区块进行简单校验，包括：块高度、前块哈希、本区块哈希（缓存的proposed block是通过区块哈希提取的，因此本步骤待落块区块哈希校验通过，说明与缓存区块一致）；</p></li>
<li><p>调用存储模块接口，保存区块和读写集数据，如果失败，则panic；</p></li>
<li><p>清除缓存数据、交易池数据、snapshot数据；</p></li>
<li><p>如果是配置区块，通知链配置（chainconf）模块；</p></li>
<li><p>通过msgBus将最新区块同步给共识、同步和消息订阅模块。</p></li>
</ol>
</div>
<div class="section" id="id94">
<h4>配置说明<a class="headerlink" href="#id94" title="Permalink to this headline">¶</a></h4>
<div class="highlight-yaml notranslate"><div class="highlight"><pre><span></span><span class="c1"># 交易、区块相关配置</span>
<span class="nt">block</span><span class="p">:</span>
  <span class="nt">tx_timestamp_verify</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">true</span> <span class="c1"># 是否需要开启交易时间戳校验</span>
  <span class="nt">tx_timeout</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">600</span>  <span class="c1"># 交易时间戳的过期时间(秒)</span>
  <span class="nt">block_tx_capacity</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">100</span>  <span class="c1"># 区块中最大交易数</span>
  <span class="nt">block_size</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">10</span>  <span class="c1"># 区块最大限制，单位MB</span>
  <span class="nt">block_interval</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">2000</span> <span class="c1"># 出块间隔，单位:ms</span>

<span class="c1"># core模块</span>
<span class="nt">core</span><span class="p">:</span>
  <span class="nt">tx_scheduler_timeout</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">10</span> <span class="c1">#  [0, 60] 交易调度器从交易池拿到交易后, 进行调度的时间</span>
  <span class="nt">tx_scheduler_validate_timeout</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">10</span> <span class="c1"># [0, 60] 交易调度器从区块中拿到交易后, 进行验证的超时时间</span>
</pre></div>
</div>
</div>
</div>
<div class="section" id="id95">
<h3>日志<a class="headerlink" href="#id95" title="Permalink to this headline">¶</a></h3>
<div class="section" id="id96">
<h4><strong>如何使用</strong><a class="headerlink" href="#id96" title="Permalink to this headline">¶</a></h4>
<ul class="simple">
<li><p>若无需区分链标识，可使用全局变量定义logger</p></li>
</ul>
<div class="highlight-go notranslate"><div class="highlight"><pre><span></span><span class="kd">var</span> <span class="nx">log</span> <span class="p">=</span> <span class="nx">logger</span><span class="p">.</span><span class="nx">GetLogger</span><span class="p">(</span><span class="nx">logger</span><span class="p">.</span><span class="nx">MODULE_NET</span><span class="p">)</span>
<span class="nx">logger</span><span class="p">.</span><span class="nx">Info</span><span class="p">(</span><span class="s">&quot;log message&quot;</span><span class="p">)</span>
<span class="o">...</span>
</pre></div>
</div>
<ul class="simple">
<li><p>若需要区分链标识，则不可使用全局变量定义logger，建议放入结构体中</p></li>
</ul>
<div class="highlight-go notranslate"><div class="highlight"><pre><span></span><span class="kd">type</span> <span class="nx">Foo</span> <span class="kd">struct</span> <span class="p">{</span>
    <span class="nx">log</span> <span class="o">*</span><span class="nx">logger</span><span class="p">.</span><span class="nx">CMLogger</span>
    <span class="o">...</span>
<span class="p">}</span>

<span class="nx">foo</span> <span class="o">:=</span> <span class="o">&amp;</span><span class="nx">Foo</span><span class="p">{</span>
    <span class="nx">log</span><span class="p">:</span> <span class="nx">logger</span><span class="p">.</span><span class="nx">GetLoggerByChain</span><span class="p">(</span><span class="nx">logger</span><span class="p">.</span><span class="nx">MODULE_NET</span><span class="p">,</span> <span class="nx">chainId</span><span class="p">)</span>
<span class="p">}</span>

<span class="kd">func</span> <span class="p">(</span><span class="nx">f</span> <span class="o">*</span><span class="nx">Foo</span><span class="p">)</span> <span class="nx">a</span><span class="p">()</span> <span class="p">{</span>
    <span class="nx">f</span><span class="p">.</span><span class="nx">log</span><span class="p">.</span><span class="nx">Info</span><span class="p">(</span><span class="s">&quot;log message&quot;</span><span class="p">)</span>
<span class="p">}</span>
<span class="o">...</span>
</pre></div>
</div>
</div>
<div class="section" id="logger">
<h4><strong>logger配置</strong><a class="headerlink" href="#logger" title="Permalink to this headline">¶</a></h4>
<p>logger.yml</p>
<div class="highlight-yaml notranslate"><div class="highlight"><pre><span></span><span class="nt">log</span><span class="p">:</span>
  <span class="nt">system</span><span class="p">:</span>
    <span class="nt">log_level_default</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">INFO</span>       <span class="c1"># 默认日志级别</span>
    <span class="nt">log_levels</span><span class="p">:</span>                   <span class="c1"># 模块日志级别自定义</span>
      <span class="nt">core</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">INFO</span>                  <span class="c1">#   模块标识: 级别</span>
      <span class="nt">net</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">INFO</span>
    <span class="nt">file_path</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">../log/system.log</span>  <span class="c1"># 日志文件指定</span>
    <span class="nt">max_age</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">365</span>                  <span class="c1"># 日志最长保存时间，单位：天</span>
    <span class="nt">rotation_time</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">1</span>              <span class="c1"># 日志滚动时间，单位：小时</span>
    <span class="nt">log_in_console</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">true</span>          <span class="c1"># 是否展示日志到终端，仅限于调试使用</span>
    <span class="nt">show_color</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">true</span>              <span class="c1"># 是否打印颜色日志</span>
  <span class="nt">brief</span><span class="p">:</span>
    <span class="nt">log_level_default</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">INFO</span>
    <span class="nt">file_path</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">../log/brief.log</span>
    <span class="nt">max_age</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">365</span>                  <span class="c1"># 日志最长保存时间，单位：天</span>
    <span class="nt">rotation_time</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">1</span>              <span class="c1"># 日志滚动时间，单位：小时</span>
    <span class="nt">log_in_console</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">false</span>         <span class="c1"># 是否展示日志到终端，仅限于调试使用</span>
    <span class="nt">show_color</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">true</span>              <span class="c1"># 是否打印颜色日志</span>
  <span class="nt">event</span><span class="p">:</span>
    <span class="nt">log_level_default</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">INFO</span>
    <span class="nt">file_path</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">../log/event.log</span>
    <span class="nt">max_age</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">365</span>                  <span class="c1"># 日志最长保存时间，单位：天</span>
    <span class="nt">rotation_time</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">1</span>              <span class="c1"># 日志滚动间隔，单位：小时</span>
    <span class="nt">log_in_console</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">false</span>         <span class="c1"># 是否展示日志到终端，仅限于调试使用</span>
    <span class="nt">show_color</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">true</span>              <span class="c1"># 是否打印颜色日志</span>
</pre></div>
</div>
</div>
</div>
</div>
</div>


           </div>
           
          </div>
          <footer>
    <div class="rst-footer-buttons" role="navigation" aria-label="footer navigation">
        <a href="ChainMaker_Data_Structure.html" class="btn btn-neutral float-right" title="长安链 · ChainMaker Data Structure" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right" aria-hidden="true"></span></a>
        <a href="ChainMaker_Quick_Start.html" class="btn btn-neutral float-left" title="长安链· ChainMaker Quick Start" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left" aria-hidden="true"></span> Previous</a>
    </div>

  <hr/>

  <div role="contentinfo">
    <p>
        &#169; Copyright 2021,test1.

    </p>
  </div>
    
    
    
    Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    
    provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>
        </div>
      </div>

    </section>

  </div>
  

  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>

  
  
    
   

</body>
</html>